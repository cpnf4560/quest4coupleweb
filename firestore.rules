rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
      // ========================================
    // USERS COLLECTION
    // ========================================
    match /users/{userId} {
      // Permitir criação apenas se:
      // 1. Utilizador está autenticado (request.auth != null)
      // 2. O UID do documento coincide com o UID do utilizador autenticado
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Permitir leitura do próprio perfil OU pesquisa por username (apenas campo username)
      // Isto permite verificar se um username já existe durante o registo
      allow read: if request.auth != null;
        // Permitir atualização do próprio perfil OU por admin
      allow update: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true
      );
      
      // Permitir eliminação apenas por admins
      allow delete: if request.auth != null && 
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;      // ========================================
      // SUBCOLEÇÃO: answers
      // ========================================
      match /answers/{answerId} {
        // Utilizador pode escrever suas próprias respostas
        allow write: if request.auth != null && request.auth.uid == userId;
        
        // Leitura: próprias respostas OU parceiros com conexão ACEITE OU admin
        allow read: if request.auth != null && (
          // Próprias respostas
          request.auth.uid == userId ||
          // Admin pode ler todas as respostas para analytics
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
          // Parceiro com conexão aceite - verifica se existe documento de conexão
          // Testa as duas ordenações possíveis dos IDs
          (request.auth.uid < userId && 
           exists(/databases/$(database)/documents/connections/$(request.auth.uid + '_' + userId))) ||
          (userId < request.auth.uid && 
           exists(/databases/$(database)/documents/connections/$(userId + '_' + request.auth.uid)))
        );
      }
      
      // ========================================
      // SUBCOLEÇÃO: customQuestions
      // ========================================
      match /customQuestions/{packId} {
        // Utilizador pode criar, ler, atualizar suas próprias perguntas custom
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // ========================================
      // SUBCOLEÇÃO: progress
      // ========================================
      match /progress/{progressId} {
        // Utilizador pode criar, ler, atualizar seu próprio progresso
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // ========================================
      // SUBCOLEÇÃO: connections
      // ========================================
      match /connections/{connectionId} {
        // Utilizador pode gerenciar suas próprias conexões
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // ========================================
    // RESPONSES COLLECTION
    // ========================================
    match /responses/{responseId} {
      // Utilizador pode criar as suas próprias respostas
      allow create: if request.auth != null;
      
      // Utilizador pode ler/atualizar apenas as suas respostas
      allow read, update: if request.auth != null && 
                             resource.data.userId == request.auth.uid;
      
      // Prevenir deleção
      allow delete: if false;
    }
    
    // ========================================
    // MATCHES COLLECTION
    // ========================================
    match /matches/{matchId} {
      // Utilizador pode ver matches onde participa
      allow read: if request.auth != null && 
                     (resource.data.user1Id == request.auth.uid || 
                      resource.data.user2Id == request.auth.uid);
      
      // Sistema cria matches automaticamente
      allow create: if request.auth != null;
      
      // Apenas utilizadores envolvidos podem atualizar
      allow update: if request.auth != null && 
                       (resource.data.user1Id == request.auth.uid || 
                        resource.data.user2Id == request.auth.uid);
      
      // Prevenir deleção
      allow delete: if false;
    }
    
    // ========================================
    // ACTIVITIES COLLECTION
    // ========================================
    match /activities/{activityId} {
      // Qualquer utilizador autenticado pode ler activities
      allow read: if request.auth != null;
      
      // Apenas admins podem escrever
      allow write: if request.auth != null && 
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
      // ========================================
    // PARTNERS COLLECTION (Se existir)
    // ========================================
    match /partners/{partnerId} {
      // Utilizador pode criar/ler/atualizar seus próprios partners
      allow create, read, update: if request.auth != null && 
                                     request.auth.uid == resource.data.userId;
      
      // Prevenir deleção
      allow delete: if false;
    }
    
    // ========================================
    // CONNECTIONS COLLECTION (Coleção raiz)
    // ========================================
    match /connections/{connectionId} {
      // Utilizador pode criar conexões se estiver autenticado e for um dos users
      allow create: if request.auth != null && 
                       request.auth.uid in request.resource.data.users;
      
      // Utilizador pode ler/atualizar conexões onde participa
      allow read, update: if request.auth != null && 
                             request.auth.uid in resource.data.users;
      
      // Utilizador pode apagar conexões onde participa
      allow delete: if request.auth != null && 
                       request.auth.uid in resource.data.users;
    }
    
    // ========================================
    // CONNECTION REQUESTS (Convites de parceiros)
    // ========================================
    match /connection_requests/{requestId} {
      // Utilizador pode criar pedidos de conexão (é o remetente)
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.fromUserId;
      
      // Utilizador pode ler pedidos onde é remetente ou destinatário
      allow read: if request.auth != null && 
                     (request.auth.uid == resource.data.fromUserId || 
                      request.auth.uid == resource.data.toUserId);
      
      // Destinatário pode atualizar (aceitar/recusar)
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.toUserId;
      
      // Remetente ou destinatário pode apagar
      allow delete: if request.auth != null && 
                       (request.auth.uid == resource.data.fromUserId || 
                        request.auth.uid == resource.data.toUserId);
    }
    
    // ========================================
    // ANALYTICS FULL REPORTS (Para BackOffice)
    // ========================================
    match /analytics_full_reports/{reportId} {
      // Qualquer utilizador autenticado pode criar relatórios
      allow create: if request.auth != null;
      
      // Apenas admins podem ler relatórios
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
      
      // Ninguém pode editar ou apagar relatórios
      allow update, delete: if false;
    }
    
    // ========================================
    // USER ANSWERS (Respostas dos utilizadores)
    // ========================================
    match /userAnswers/{docId} {
      // Utilizador pode ler/escrever suas próprias respostas
      allow read, write: if request.auth != null && request.auth.uid == docId;
      
      // Admins podem ler todas as respostas (para analytics)
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // ========================================
    // PARTNER CONNECTIONS (Conexões de parceiros)
    // ========================================
    match /partnerConnections/{connectionId} {
      // Utilizador pode criar conexões
      allow create: if request.auth != null;
      
      // Utilizador pode ler/atualizar conexões onde participa
      allow read, update: if request.auth != null;
      
      // Admins podem ler todas as conexões (para analytics)
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
      
      // Utilizador pode apagar suas conexões
      allow delete: if request.auth != null;
    }
    
    // ========================================
    // AUDIT LOG COLLECTION
    // ========================================
    match /audit_log/{logId} {
      // Qualquer utilizador autenticado pode criar logs
      allow create: if request.auth != null;
      
      // Apenas admins podem ler logs
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
      
      // Ninguém pode editar ou apagar logs
      allow update, delete: if false;
    }
    
    // ========================================
    // BLOQUEAR TUDO O RESTO
    // ========================================
    // Qualquer outra coleção não especificada acima é bloqueada
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
