<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relat√≥rio de Compatibilidade - Quest4Couple üíï</title>
  
  <!-- Favicons -->
  <link rel="icon" href="./favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  
  <!-- CSS Modules -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/themes.css">
  <link rel="stylesheet" href="css/questions.css">
    <style>
    /* Estilos espec√≠ficos para o relat√≥rio - FORMATO TABELA COMPACTO */
    body {
      padding-top: 20px;
      background: #f8f9fa;
    }
    
    .report-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* ========================================
       CATEGORIAS - Design Minimalista
       ======================================== */
    .compatibility-category {
      margin: 25px 0;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }
      .compatibility-category h3 {
      font-size: 1.1em;
      margin: 0;
      padding: 12px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      color: #495057;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .compatibility-category h3:hover {
      background: #e9ecef;
    }
    
    .category-toggle {
      font-size: 0.8em;
      color: #667eea;
      transition: transform 0.3s;
      display: inline-block;
    }
    
    .category-content {
      display: block;
      transition: all 0.3s ease;
    }
    
    /* ========================================
       TABELA DE COMPATIBILIDADE - Ultra Compacto
       ======================================== */    .compatibility-section {
      display: grid;
      grid-template-columns: 3.5fr 1.2fr 2fr 2fr;
      gap: 15px;
      padding: 10px 20px;
      margin: 0;
      border-bottom: 1px solid #f0f0f0;
      align-items: center;
      transition: background 0.2s;
      font-size: 0.9em;
    }
    
    .compatibility-section:last-child {
      border-bottom: none;
    }
    
    .compatibility-section:hover {
      background: #f8f9fa;
    }
    
    /* Cores das linhas baseadas nos packs */
    .pack.romantico .compatibility-section {
      border-left: 3px solid #f082a9;
    }
    
    .pack.experiencia .compatibility-section {
      border-left: 3px solid #006c80;
    }
    
    .pack.pimentinha .compatibility-section {
      border-left: 3px solid #ff6b6b;
    }
    
    .pack.poliamor .compatibility-section {
      border-left: 3px solid #6f42c1;
    }
    
    .pack.kinks .compatibility-section {
      border-left: 3px solid #1a1a1a;
    }
    
    /* Coluna 1: Quest√£o */
    .compatibility-section .question-text {
      color: #2c3e50;
      font-weight: 500;
      line-height: 1.4;
      margin: 0;
    }
    
    /* Coluna 2: Tipo de Match */
    .compatibility-section .match-type {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 600;
      white-space: nowrap;
    }
    
    /* Coluna 3 e 4: Respostas dos Users */
    .compatibility-section .user-answer {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .compatibility-section .user-name {
      font-size: 0.75em;
      color: #6c757d;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* ========================================
       CORES POR TIPO DE MATCH - S√≥brias
       ======================================== */
    /* Super Match */
    .compatibility-section.super-match .match-type {
      background: #d4edda;
      color: #155724;
    }
    
    /* Excelente */
    .compatibility-section.excellent .match-type {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    /* Bom Match */
    .compatibility-section.good-match .match-type {
      background: #d4edda;
      color: #155724;
    }
    
    /* Poss√≠vel */
    .compatibility-section.possible .match-type {
      background: #fff3cd;
      color: #856404;
    }
    
    /* Neutro */
    .compatibility-section.neutral .match-type {
      background: #e2e3e5;
      color: #383d41;
    }
      /* ========================================
       BADGES DE RESPOSTAS - Novas Cores
       ======================================== */
    .answer-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.85em;
      border: 1px solid;
    }
    
    /* Por favor! - AZUL */
    .answer-badge.porfavor {
      background: #cfe2ff;
      color: #084298;
      border-color: #b6d4fe;
    }
    
    /* Yup - VERDE */
    .answer-badge.yup {
      background: #d1e7dd;
      color: #0f5132;
      border-color: #badbcc;
    }
    
    /* Talvez - AMARELO (mant√©m) */
    .answer-badge.talvez {
      background: #fff3cd;
      color: #856404;
      border-color: #ffeaa7;
    }
    
    /* Meh - VERMELHO */
    .answer-badge.meh {
      background: #f8d7da;
      color: #842029;
      border-color: #f5c2c7;
    }
      /* ========================================
       INVERT MATCHING - Formato Tabela Adaptado
       ======================================== */
    .compatibility-section.inverted {
      background: #f5f7fa;
      border-left: 3px solid #667eea;
      grid-template-columns: 1fr;
      padding: 15px 20px;
    }
    
    .invert-container {
      display: grid;
      grid-template-columns: auto 1.2fr 40px 1.2fr;
      gap: 15px;
      align-items: center;
      margin-top: 10px;
    }
    
    .invert-label {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 0.75em;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .invert-label.giver {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .invert-label.receiver {
      background: #d6d8ff;
      color: #3d3d8f;
      border: 1px solid #b8bcff;
    }
    
    .invert-you, .invert-partner {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .invert-arrow {
      font-size: 1.5em;
      color: #667eea;
      text-align: center;
    }    .invert-description {
      margin-top: 10px;
      padding: 8px 12px;
      background: #e8eaf6;
      border-radius: 4px;
      font-size: 0.85em;
      color: #495057;
      border-left: 3px solid #667eea;
    }
    
    /* ========================================
       ESTILOS MELHORADOS PARA INVERT MATCHING
       ======================================== */
    .compatibility-section.inverted {
      animation: highlightInvert 0.5s ease-in-out;
    }
    
    @keyframes highlightInvert {
      0% { background: #fff8e1; }
      100% { background: linear-gradient(to right, #f9fbe7, #fff8e1); }
    }
    
    /* Badge "üîÑ MATCHING INVERTIDO" */
    .invert-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #667eea;
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 700;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* Container de explica√ß√£o da din√¢mica */
    .invert-explanation {
      margin-top: 12px;
      padding: 10px 15px;
      background: #e3f2fd;
      border-left: 3px solid #2196f3;
      border-radius: 6px;
      color: #1565c0;
      font-size: 0.9em;
      line-height: 1.5;
    }
    
    /* ========================================
       BOT√ÉO TOGGLE ALL
       ======================================== */
    #toggleAllBtn {
      transition: all 0.3s;
    }
    
    #toggleAllBtn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    #toggleAllBtn:active {
      transform: translateY(0);
    }
    
    /* Bot√µes de a√ß√£o */
    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .btn-action {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      font-size: 0.95em;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-action:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #d63384, #e83e8c);
      color: white;
    }
    
    .btn-outline {
      background: white;
      border: 2px solid #667eea;
      color: #667eea;
    }
      /* ========================================
       RESPONSIVIDADE - Mobile First
       ======================================== */
    @media (max-width: 1200px) {
      .compatibility-section {
        grid-template-columns: 2.5fr 1fr 1.5fr 1.5fr;
        font-size: 0.85em;
        gap: 10px;
      }
    }
    
    @media (max-width: 992px) {
      .compatibility-section {
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 15px 20px;
      }
      
      .compatibility-section .question-text {
        font-size: 1em;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e9ecef;
      }
      
      .compatibility-section .match-type {
        margin-bottom: 8px;
      }
      
      .compatibility-section .user-answer {
        flex-direction: row;
        align-items: center;
        gap: 8px;
      }
      
      .invert-container {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .invert-arrow {
        transform: rotate(90deg);
        margin: 5px 0;
      }
    }
    
    @media (max-width: 768px) {
      .report-container {
        padding: 10px;
      }
      
      .compatibility-category h3 {
        font-size: 1em;
        padding: 10px 15px;
      }
      
      .compatibility-section {
        padding: 12px 15px;
        font-size: 0.9em;
      }
      
      .action-buttons {
        flex-direction: column;
      }
          .btn-action {
        width: 100%;
        justify-content: center;
      }
    }
    
    /* Modal Animation */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
  </style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="logo-section">
    <a href="index.html">
      <img src="./assets/logo.png" alt="Quest4Couple Logo" class="logo" onerror="this.src='./logo.png'; this.onerror=null;">
    </a>
    <h1>Quest4Couple</h1>
    <p class="tagline">Relat√≥rio de Compatibilidade üíï</p>
  </div>
</div>

<!-- Container do Relat√≥rio -->
<div class="report-container">
  
  <!-- Sec√ß√£o para carregar ficheiros -->
  <div id="uploadSection" style="max-width: 700px; margin: 0 auto; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);">
    <div style="text-align: center; margin-bottom: 30px;">
      <div style="font-size: 4em; margin-bottom: 15px;">üíë</div>
      <h2 style="color: #667eea; font-size: 2em; margin-bottom: 10px;">Gerar Relat√≥rio de Compatibilidade</h2>
      <p style="color: #6c757d; font-size: 1.1em;">Carreguem os vossos ficheiros .q4c para descobrir a compatibilidade!</p>
    </div>
    
    <div style="margin: 25px 0;">
      <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">üìÅ O teu ficheiro .q4c:</label>
      <input type="file" id="myFile" accept=".q4c" style="width: 100%; padding: 15px; border: 2px dashed #667eea; border-radius: 12px; cursor: pointer; font-size: 1em;">
    </div>
    
    <div style="margin: 25px 0;">
      <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">üìÅ Ficheiro .q4c do/a parceiro/a:</label>
      <input type="file" id="partnerFile" accept=".q4c" style="width: 100%; padding: 15px; border: 2px dashed #d63384; border-radius: 12px; cursor: pointer; font-size: 1em;">
    </div>
    
    <div style="margin: 25px 0;">
      <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">üîë C√≥digo de seguran√ßa:</label>
      <input type="password" id="securityCode" placeholder="C√≥digo utilizado ao guardar..." style="width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 1em;">
    </div>
      <button onclick="compareEncryptedAnswers()" style="width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 1.2em; font-weight: 700; cursor: pointer; transition: all 0.3s; margin-top: 10px;">
      üéØ Gerar Relat√≥rio
    </button>
    
    <!-- NOVA SEC√á√ÉO: Cloud Report -->
    <div style="margin: 35px 0 25px; padding: 25px; background: linear-gradient(135deg, #e0f7fa 0%, #e8eaf6 100%); border-radius: 12px; border: 2px solid #667eea;">
      <div style="text-align: center; margin-bottom: 15px;">
        <div style="font-size: 2.5em; margin-bottom: 5px;">‚òÅÔ∏è</div>
        <h3 style="color: #667eea; margin: 0 0 5px 0; font-size: 1.3em;">Gerar com Conta Quest4Couple</h3>
        <p style="color: #6c757d; margin: 0; font-size: 0.9em;">Sem ficheiros! Direto pela cloud üöÄ</p>
      </div>
      
      <div id="cloudSection">        <!-- Estado: N√£o autenticado -->
        <div id="cloudNotAuth" style="text-align: center;">
          <p style="color: #495057; margin-bottom: 15px;">
            <strong>‚ú® Novo!</strong> Se ambos t√™m conta Quest4Couple, podem gerar o relat√≥rio diretamente sem ficheiros .q4c!
          </p>
          <button onclick="window.location.href='auth.html?redirect=relatorio.html'" style="padding: 12px 25px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em;">
            üîê Fazer Login para Usar Cloud
          </button>
        </div>
          <!-- Estado: Autenticado (escondido por padr√£o) -->
        <div id="cloudAuth" style="display: none;">
          <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">üë• Escolher parceiro/a:</label>
            <div style="display: flex; gap: 10px;">
              <select id="partnerSelect" style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em; cursor: pointer;">
                <option value="">Carregando parceiros...</option>
              </select>
              <button onclick="showAddPartnerModal()" style="padding: 12px 20px; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; white-space: nowrap;">
                ‚ûï Adicionar
              </button>
            </div>
          </div>
          
          <button onclick="generateCloudReport()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #00bcd4 0%, #667eea 100%); color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.3s;">
            ‚òÅÔ∏è Gerar Relat√≥rio pela Cloud
          </button>
          
          <p style="color: #6c757d; font-size: 0.85em; margin-top: 10px; text-align: center;">
            ‚ö° R√°pido e sem c√≥digo de seguran√ßa!
          </p>
        </div>
      </div>
    </div>
    <!-- FIM SEC√á√ÉO CLOUD -->
    
    <div style="margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 12px; border-left: 4px solid #17a2b8;">
      <div style="font-weight: 700; margin-bottom: 10px; color: #0c5460;">üí° Como funciona:</div>
      <ol style="margin: 10px 0 0 20px; line-height: 1.8; color: #6c757d;">
        <li>Cada pessoa responde aos question√°rios no <a href="app.html" style="color: #667eea; font-weight: 600;">app.html</a></li>
        <li>Guardam as respostas num ficheiro .q4c</li>
        <li>Partilham os ficheiros entre si</li>
        <li>Carregam ambos aqui para ver a compatibilidade!</li>
        <li>Usem o <strong>mesmo c√≥digo de seguran√ßa</strong></li>
      </ol>
    </div>
  </div>
  
  <!-- Container onde o relat√≥rio ser√° renderizado -->
  <div id="compatibilityReport" style="display: none; margin-top: 40px;"></div>
  
  <!-- Bot√µes de a√ß√£o (aparecem ap√≥s gerar relat√≥rio) -->
  <div id="actionButtons" style="display: none;" class="action-buttons">
    <button onclick="window.print()" class="btn-action btn-primary">
      üñ®Ô∏è Imprimir Relat√≥rio
    </button>
    <button onclick="window.location.href='app.html'" class="btn-action btn-secondary">
      üîÑ Responder Novamente
    </button>
    <a href="index.html" class="btn-action btn-outline">
      üè† Voltar ao In√≠cio
    </a>
  </div>
  </div>

<!-- Add Partner Modal -->
<div id="addPartnerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
  <div style="background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 50px rgba(0,0,0,0.3); animation: slideIn 0.3s ease-out;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef;">
      <h3 style="margin: 0; color: #667eea; font-size: 1.5em;">Adicionar Parceiro</h3>
      <button onclick="closeAddPartnerModal()" style="background: none; border: none; font-size: 2em; color: #aaa; cursor: pointer; line-height: 1; transition: color 0.2s;">√ó</button>
    </div>
    
    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
      <p style="margin: 0 0 8px 0; color: #495057; font-weight: 500;">üì± O teu username para partilhar:</p>
      <div style="display: flex; align-items: center; gap: 10px;">
        <code id="myUsernameDisplay" style="background: white; padding: 8px 12px; border-radius: 6px; font-size: 1.1em; color: #667eea; font-weight: 600; flex: 1;">@carregando...</code>
        <button type="button" onclick="copyMyUsername()" style="background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; white-space: nowrap; font-weight: 600;">üìã Copiar</button>
      </div>
      <small style="color: #6c757d; display: block; margin-top: 8px;">Partilha este username com o teu parceiro</small>
    </div>
    
    <p style="font-weight: 500; margin-bottom: 10px; color: #495057;">üîç Procura pelo username do teu parceiro:</p>
    <form id="searchUserForm" onsubmit="searchPartnerByUsername(event)" style="margin-bottom: 20px;">
      <div style="display: flex; gap: 10px;">
        <input type="text" id="searchUsername" placeholder="@username" required style="flex: 1; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1em; transition: border-color 0.3s;">
        <button type="submit" style="padding: 12px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; white-space: nowrap;">Procurar</button>
      </div>
    </form>
    
    <div id="searchResults" style="margin-top: 15px;">
      <!-- Results will appear here -->
    </div>
  </div>
</div>

<!-- Footer -->
<footer style="margin-top: 60px; padding: 30px 20px; background: rgba(255,255,255,0.9); border-top: 2px solid #d63384; text-align: center;">
  <div style="max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-bottom: 20px;">
      <a href="pages/sobre.html" style="color: #d63384; text-decoration: none; font-weight: 600;">Sobre</a>
      <a href="pages/faq.html" style="color: #d63384; text-decoration: none; font-weight: 600;">FAQ</a>
      <a href="tutorial.html" style="color: #d63384; text-decoration: none; font-weight: 600;">Tutorial</a>
      <a href="pages/privacidade.html" style="color: #d63384; text-decoration: none; font-weight: 600;">Privacidade</a>
    </div>
    <p style="color: #6c757d; font-size: 0.9em; margin: 10px 0;">
      üíï Quest4Couple - Descubram-se juntos
    </p>
    <p style="color: #999; font-size: 0.8em;">
      ¬© 2025 Quest4Couple. Todos os direitos reservados.
    </p>
  </div>
</footer>

<!-- CryptoJS Library (necess√°rio para desencriptar) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<!-- Firebase Configuration -->
<script src="js/firebase-config.js"></script>

<!-- JavaScript Modules -->
<script src="js/analytics.js"></script>
<script src="js/invertMatching.js"></script>
<script src="js/comparison.js"></script>

<script>
  // Mostrar bot√µes de a√ß√£o ap√≥s gerar relat√≥rio
  const originalGenerateReport = window.generateCompatibilityReport;
  if (originalGenerateReport) {
    window.generateCompatibilityReport = async function(...args) {
      await originalGenerateReport.apply(this, args);
      document.getElementById('actionButtons').style.display = 'flex';
      document.getElementById('uploadSection').style.display = 'none';
    };
  }
    // Verificar autentica√ß√£o ao carregar a p√°gina
  document.addEventListener('DOMContentLoaded', () => {
    console.log('üîç Verificando autentica√ß√£o na p√°gina relat√≥rio...');
    
    // Aguardar Firebase inicializar
    setTimeout(() => {
      if (typeof firebase !== 'undefined' && firebase.auth) {
        checkCloudAuthentication();
      } else {
        console.warn('‚ö†Ô∏è Firebase n√£o carregado - funcionalidade cloud desativada');
      }
    }, 500);
  });

  // ===================================
  // FUN√á√ïES DO MODAL DE ADICIONAR PARCEIRO
  // ===================================
  
  function showAddPartnerModal() {
    const modal = document.getElementById('addPartnerModal');
    if (modal) {
      modal.style.display = 'flex';
      loadMyUsername();
    }
  }
  
  function closeAddPartnerModal() {
    const modal = document.getElementById('addPartnerModal');
    if (modal) {
      modal.style.display = 'none';
      document.getElementById('searchUsername').value = '';
      document.getElementById('searchResults').innerHTML = '';
    }
  }
  
  async function loadMyUsername() {
    const user = firebase.auth().currentUser;
    if (!user) {
      document.getElementById('myUsernameDisplay').textContent = '@erro';
      return;
    }
    
    try {
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (userDoc.exists) {
        const username = userDoc.data().username || user.email.split('@')[0];
        document.getElementById('myUsernameDisplay').textContent = '@' + username;
      }
    } catch (error) {
      console.error('Erro ao carregar username:', error);
      document.getElementById('myUsernameDisplay').textContent = '@' + user.email.split('@')[0];
    }
  }
  
  function copyMyUsername() {
    const usernameText = document.getElementById('myUsernameDisplay').textContent;
    navigator.clipboard.writeText(usernameText).then(() => {
      alert('‚úÖ Username copiado!\n\n' + usernameText + '\n\nPartilha com o teu parceiro.');
    }).catch(() => {
      alert('‚ùå Erro ao copiar. Tenta selecionar e copiar manualmente: ' + usernameText);
    });
  }
  
  async function searchPartnerByUsername(event) {
    event.preventDefault();
    
    const searchInput = document.getElementById('searchUsername');
    const searchResults = document.getElementById('searchResults');
    const searchUsername = searchInput.value.trim().replace('@', '').toLowerCase();
    
    if (!searchUsername) {
      alert('‚ùå Por favor, insere um username v√°lido!');
      return;
    }
    
    searchResults.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">üîç Procurando...</div>';
    
    try {
      const currentUser = firebase.auth().currentUser;
      if (!currentUser) {
        throw new Error('Utilizador n√£o autenticado');
      }
      
      // Buscar utilizador pelo username
      const usersSnapshot = await db.collection('users')
        .where('username', '==', searchUsername)
        .limit(1)
        .get();
      
      if (usersSnapshot.empty) {
        searchResults.innerHTML = `
          <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: 8px; color: #856404;">
            <p style="margin: 0; font-weight: 500;">‚ùå Username n√£o encontrado</p>
            <p style="margin: 5px 0 0 0; font-size: 0.9em;">Verifica se o username est√° correto</p>
          </div>
        `;
        return;
      }
      
      const partnerDoc = usersSnapshot.docs[0];
      const partnerData = partnerDoc.data();
      const partnerId = partnerDoc.id;
      
      // Verificar se j√° est√° conectado
      const connectionSnapshot = await db.collection('connections')
        .where('userId', '==', currentUser.uid)
        .where('partnerId', '==', partnerId)
        .get();
      
      if (!connectionSnapshot.empty) {
        searchResults.innerHTML = `
          <div style="text-align: center; padding: 20px; background: #d1ecf1; border-radius: 8px; color: #0c5460;">
            <p style="margin: 0; font-weight: 500;">‚ÑπÔ∏è J√° est√°s conectado com este utilizador</p>
          </div>
        `;
        return;
      }
      
      // Mostrar resultado e bot√£o para adicionar
      searchResults.innerHTML = `
        <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border: 2px solid #667eea;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em;">
              ${partnerData.gender === 'M' ? 'üë®' : partnerData.gender === 'F' ? 'üë©' : 'üë§'}
            </div>
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #495057; font-size: 1.1em;">${partnerData.name || 'Utilizador'}</div>
              <div style="color: #6c757d; font-size: 0.9em;">@${partnerData.username}</div>
            </div>
          </div>
          <button onclick="addPartnerConnection('${partnerId}', '${partnerData.name}', '${partnerData.username}')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
            ‚ûï Adicionar como Parceiro
          </button>
        </div>
      `;
    } catch (error) {
      console.error('Erro ao procurar utilizador:', error);
      searchResults.innerHTML = `
        <div style="text-align: center; padding: 20px; background: #f8d7da; border-radius: 8px; color: #721c24;">
          <p style="margin: 0; font-weight: 500;">‚ùå Erro ao procurar</p>
          <p style="margin: 5px 0 0 0; font-size: 0.9em;">${error.message}</p>
        </div>
      `;
    }
  }
  
  async function addPartnerConnection(partnerId, partnerName, partnerUsername) {
    try {
      const currentUser = firebase.auth().currentUser;
      if (!currentUser) {
        throw new Error('Utilizador n√£o autenticado');
      }
      
      // Criar conex√£o
      await db.collection('connections').add({
        userId: currentUser.uid,
        partnerId: partnerId,
        partnerName: partnerName,
        partnerUsername: partnerUsername,
        status: 'pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      alert('‚úÖ Parceiro adicionado com sucesso!\n\n' + partnerName + ' foi adicionado √† tua lista de parceiros.');
      
      closeAddPartnerModal();
      
      // Recarregar lista de parceiros
      if (typeof loadPartnersList === 'function') {
        loadPartnersList();
      }
    } catch (error) {
      console.error('Erro ao adicionar parceiro:', error);
      alert('‚ùå Erro ao adicionar parceiro:\n\n' + error.message);
    }
  }
  
  // Fechar modal ao clicar fora
  document.getElementById('addPartnerModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'addPartnerModal') {
      closeAddPartnerModal();
    }
  });
</script>

</body>
</html>
