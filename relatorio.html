<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relat√≥rio de Compatibilidade - Quest4Couple üíï</title>
  
  <!-- Favicons -->
  <link rel="icon" href="./favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  
  <!-- CSS Modules -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/themes.css">
  <link rel="stylesheet" href="css/questions.css">
    <style>
    /* Estilos espec√≠ficos para o relat√≥rio - FORMATO TABELA COMPACTO */
    body {
      padding-top: 20px;
      background: #f8f9fa;
    }
    
    .report-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* ========================================
       CATEGORIAS - Design Minimalista
       ======================================== */
    .compatibility-category {
      margin: 25px 0;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }
      .compatibility-category h3 {
      font-size: 1.1em;
      margin: 0;
      padding: 12px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      color: #495057;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .compatibility-category h3:hover {
      background: #e9ecef;
    }
    
    .category-toggle {
      font-size: 0.8em;
      color: #667eea;
      transition: transform 0.3s;
      display: inline-block;
    }
    
    .category-content {
      display: block;
      transition: all 0.3s ease;
    }
    
    /* ========================================
       TABELA DE COMPATIBILIDADE - Ultra Compacto
       ======================================== */    .compatibility-section {
      display: grid;
      grid-template-columns: 3.5fr 1.2fr 2fr 2fr;
      gap: 15px;
      padding: 10px 20px;
      margin: 0;
      border-bottom: 1px solid #f0f0f0;
      align-items: center;
      transition: background 0.2s;
      font-size: 0.9em;
    }
    
    .compatibility-section:last-child {
      border-bottom: none;
    }
    
    .compatibility-section:hover {
      background: #f8f9fa;
    }
    
    /* Cores das linhas baseadas nos packs */
    .pack.romantico .compatibility-section {
      border-left: 3px solid #f082a9;
    }
    
    .pack.experiencia .compatibility-section {
      border-left: 3px solid #006c80;
    }
    
    .pack.pimentinha .compatibility-section {
      border-left: 3px solid #ff6b6b;
    }
    
    .pack.poliamor .compatibility-section {
      border-left: 3px solid #6f42c1;
    }
    
    .pack.kinks .compatibility-section {
      border-left: 3px solid #1a1a1a;
    }
    
    /* Coluna 1: Quest√£o */
    .compatibility-section .question-text {
      color: #2c3e50;
      font-weight: 500;
      line-height: 1.4;
      margin: 0;
    }
    
    /* Coluna 2: Tipo de Match */
    .compatibility-section .match-type {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 600;
      white-space: nowrap;
    }
    
    /* Coluna 3 e 4: Respostas dos Users */
    .compatibility-section .user-answer {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .compatibility-section .user-name {
      font-size: 0.75em;
      color: #6c757d;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* ========================================
       CORES POR TIPO DE MATCH - S√≥brias
       ======================================== */
    /* Super Match */
    .compatibility-section.super-match .match-type {
      background: #d4edda;
      color: #155724;
    }
    
    /* Excelente */
    .compatibility-section.excellent .match-type {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    /* Bom Match */
    .compatibility-section.good-match .match-type {
      background: #d4edda;
      color: #155724;
    }
    
    /* Poss√≠vel */
    .compatibility-section.possible .match-type {
      background: #fff3cd;
      color: #856404;
    }
    
    /* Neutro */
    .compatibility-section.neutral .match-type {
      background: #e2e3e5;
      color: #383d41;
    }
      /* ========================================
       BADGES DE RESPOSTAS - Novas Cores
       ======================================== */
    .answer-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.85em;
      border: 1px solid;
    }
    
    /* Por favor! - AZUL */
    .answer-badge.porfavor {
      background: #cfe2ff;
      color: #084298;
      border-color: #b6d4fe;
    }
    
    /* Yup - VERDE */
    .answer-badge.yup {
      background: #d1e7dd;
      color: #0f5132;
      border-color: #badbcc;
    }
    
    /* Talvez - AMARELO (mant√©m) */
    .answer-badge.talvez {
      background: #fff3cd;
      color: #856404;
      border-color: #ffeaa7;
    }
    
    /* Meh - VERMELHO */
    .answer-badge.meh {
      background: #f8d7da;
      color: #842029;
      border-color: #f5c2c7;
    }
      /* ========================================
       INVERT MATCHING - Formato Tabela Adaptado
       ======================================== */
    .compatibility-section.inverted {
      background: #f5f7fa;
      border-left: 3px solid #667eea;
      grid-template-columns: 1fr;
      padding: 15px 20px;
    }
    
    .invert-container {
      display: grid;
      grid-template-columns: auto 1.2fr 40px 1.2fr;
      gap: 15px;
      align-items: center;
      margin-top: 10px;
    }
    
    .invert-label {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 0.75em;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .invert-label.giver {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .invert-label.receiver {
      background: #d6d8ff;
      color: #3d3d8f;
      border: 1px solid #b8bcff;
    }
    
    .invert-you, .invert-partner {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .invert-arrow {
      font-size: 1.5em;
      color: #667eea;
      text-align: center;
    }    .invert-description {
      margin-top: 10px;
      padding: 8px 12px;
      background: #e8eaf6;
      border-radius: 4px;
      font-size: 0.85em;
      color: #495057;
      border-left: 3px solid #667eea;
    }
    
    /* ========================================
       ESTILOS MELHORADOS PARA INVERT MATCHING
       ======================================== */
    .compatibility-section.inverted {
      animation: highlightInvert 0.5s ease-in-out;
    }
    
    @keyframes highlightInvert {
      0% { background: #fff8e1; }
      100% { background: linear-gradient(to right, #f9fbe7, #fff8e1); }
    }
    
    /* Badge "üîÑ MATCHING INVERTIDO" */
    .invert-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #667eea;
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 700;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* Container de explica√ß√£o da din√¢mica */
    .invert-explanation {
      margin-top: 12px;
      padding: 10px 15px;
      background: #e3f2fd;
      border-left: 3px solid #2196f3;
      border-radius: 6px;
      color: #1565c0;
      font-size: 0.9em;
      line-height: 1.5;
    }
    
    /* ========================================
       BOT√ÉO TOGGLE ALL
       ======================================== */
    #toggleAllBtn {
      transition: all 0.3s;
    }
    
    #toggleAllBtn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    #toggleAllBtn:active {
      transform: translateY(0);
    }
    
    /* Bot√µes de a√ß√£o */
    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .btn-action {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      font-size: 0.95em;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-action:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #d63384, #e83e8c);
      color: white;
    }
    
    .btn-outline {
      background: white;
      border: 2px solid #667eea;
      color: #667eea;
    }
      /* ========================================
       RESPONSIVIDADE - Mobile First
       ======================================== */
    @media (max-width: 1200px) {
      .compatibility-section {
        grid-template-columns: 2.5fr 1fr 1.5fr 1.5fr;
        font-size: 0.85em;
        gap: 10px;
      }
    }
    
    @media (max-width: 992px) {
      .compatibility-section {
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 15px 20px;
      }
      
      .compatibility-section .question-text {
        font-size: 1em;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e9ecef;
      }
      
      .compatibility-section .match-type {
        margin-bottom: 8px;
      }
      
      .compatibility-section .user-answer {
        flex-direction: row;
        align-items: center;
        gap: 8px;
      }
      
      .invert-container {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .invert-arrow {
        transform: rotate(90deg);
        margin: 5px 0;
      }
    }
    
    @media (max-width: 768px) {
      .report-container {
        padding: 10px;
      }
      
      .compatibility-category h3 {
        font-size: 1em;
        padding: 10px 15px;
      }
      
      .compatibility-section {
        padding: 12px 15px;
        font-size: 0.9em;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn-action {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>

<!-- Header -->
<div class="header">
  <!-- Logo e T√≠tulo (Centro) -->
  <div class="logo-section">
    <a href="index.html">
      <img src="./assets/logo.png" alt="Quest4Couple Logo" class="logo" onerror="this.src='./logo.png'; this.onerror=null;">
    </a>
    <h1>Quest4Couple</h1>
    <p class="tagline">Relat√≥rio de Compatibilidade üíï</p>
  </div>
  
  <!-- User Section (Canto Superior Direito) -->
  <div class="user-section-top">
    <span class="user-info" id="userInfo">
      üë§ <span id="currentUserName">Visitante</span>
    </span>
    
    <button class="btn btn-dashboard" onclick="window.location.href='dashboard.html'" title="Voltar ao Dashboard" id="dashboardBtn" style="display: none;">
      üìä Dashboard
    </button>
    
    <button class="btn btn-primary" onclick="window.location.href='app.html'" title="Responder Question√°rio">
      üìù Question√°rio
    </button>
    
    <button class="btn btn-secondary" onclick="window.location.href='index.html'" title="Voltar ao In√≠cio">
      üè† In√≠cio
    </button>
    
    <button class="btn btn-logout" onclick="logout()" title="Sair" id="logoutBtn" style="display: none;">
      üö™ Sair
    </button>
  </div>
  
  <div class="free-badge-small">
    ‚ú® 100% Gratuito
  </div>
</div>

<!-- Container do Relat√≥rio -->
<div class="report-container">
  
  <!-- Sec√ß√£o para carregar ficheiros -->
  <div id="uploadSection" style="max-width: 700px; margin: 0 auto; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.15);">
    <div style="text-align: center; margin-bottom: 30px;">
      <div style="font-size: 4em; margin-bottom: 15px;">üíë</div>
      <h2 style="color: #667eea; font-size: 2em; margin-bottom: 10px;">Gerar Relat√≥rio de Compatibilidade</h2>
      <p style="color: #6c757d; font-size: 1.1em;">Carreguem os vossos ficheiros .q4c para descobrir a compatibilidade!</p>
    </div>
    
    <div style="margin: 25px 0;">
      <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">üìÅ O teu ficheiro .q4c:</label>
      <input type="file" id="myFile" accept=".q4c" style="width: 100%; padding: 15px; border: 2px dashed #667eea; border-radius: 12px; cursor: pointer; font-size: 1em;">
    </div>
    
    <div style="margin: 25px 0;">
      <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">üìÅ Ficheiro .q4c do/a parceiro/a:</label>
      <input type="file" id="partnerFile" accept=".q4c" style="width: 100%; padding: 15px; border: 2px dashed #d63384; border-radius: 12px; cursor: pointer; font-size: 1em;">
    </div>
    
    <div style="margin: 25px 0;">
      <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">üîë C√≥digo de seguran√ßa:</label>
      <input type="password" id="securityCode" placeholder="C√≥digo utilizado ao guardar..." style="width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 1em;">
    </div>
      <button onclick="compareEncryptedAnswers()" style="width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 1.2em; font-weight: 700; cursor: pointer; transition: all 0.3s; margin-top: 10px;">
      üéØ Gerar Relat√≥rio
    </button>
    
    <!-- NOVA SEC√á√ÉO: Cloud Report -->
    <div style="margin: 35px 0 25px; padding: 25px; background: linear-gradient(135deg, #e0f7fa 0%, #e8eaf6 100%); border-radius: 12px; border: 2px solid #667eea;">
      <div style="text-align: center; margin-bottom: 15px;">
        <div style="font-size: 2.5em; margin-bottom: 5px;">‚òÅÔ∏è</div>
        <h3 style="color: #667eea; margin: 0 0 5px 0; font-size: 1.3em;">Gerar com Conta Quest4Couple</h3>
        <p style="color: #6c757d; margin: 0; font-size: 0.9em;">Sem ficheiros! Direto pela cloud üöÄ</p>
      </div>
      
      <div id="cloudSection">        <!-- Estado: N√£o autenticado -->
        <div id="cloudNotAuth" style="text-align: center;">
          <p style="color: #495057; margin-bottom: 15px;">
            <strong>‚ú® Novo!</strong> Se ambos t√™m conta Quest4Couple, podem gerar o relat√≥rio diretamente sem ficheiros .q4c!
          </p>
          <button onclick="window.location.href='auth.html?redirect=relatorio.html'" style="padding: 12px 25px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em;">
            üîê Fazer Login para Usar Cloud
          </button>
        </div>
        
        <!-- Estado: Autenticado (escondido por padr√£o) -->
        <div id="cloudAuth" style="display: none;">
          <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">üë• Escolher parceiro/a:</label>
            <select id="partnerSelect" style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em; cursor: pointer;">
              <option value="">Carregando parceiros...</option>
            </select>
          </div>
          
          <button onclick="generateCloudReport()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #00bcd4 0%, #667eea 100%); color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.3s;">
            ‚òÅÔ∏è Gerar Relat√≥rio pela Cloud
          </button>
          
          <p style="color: #6c757d; font-size: 0.85em; margin-top: 10px; text-align: center;">
            ‚ö° R√°pido e sem c√≥digo de seguran√ßa!
          </p>
        </div>
      </div>
    </div>
    <!-- FIM SEC√á√ÉO CLOUD -->
    
    <!-- SEC√á√ÉO PEDIDOS DE CONEX√ÉO (vis√≠vel s√≥ para autenticados) -->
    <div id="connectionRequestsSection" style="display: none; margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%); border-radius: 12px; border: 2px solid #667eea;">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
        <span style="font-size: 1.5em;">üì¨</span>
        <h3 style="margin: 0; color: #667eea; font-size: 1.2em;">Pedidos de Conex√£o</h3>
        <span id="requestsBadge" style="background: #667eea; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">0</span>
      </div>
      <div id="connectionRequestsList" style="display: flex; flex-direction: column; gap: 10px;">
        <!-- Pedidos ser√£o carregados aqui -->
        <p style="text-align: center; color: #999; padding: 15px;">Carregando pedidos...</p>
      </div>
    </div>
    
    <!-- SEC√á√ÉO CONEX√ïES (vis√≠vel s√≥ para autenticados) -->
    <div id="connectionsSection" style="display: none; margin-top: 25px; padding: 20px; background: white; border-radius: 12px; border: 1px solid #e9ecef;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
        <h3 style="margin: 0; color: #495057; font-size: 1.2em;">üë• As tuas Conex√µes</h3>
        <button onclick="openAddConnectionModal()" style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9em;">
          + Adicionar Parceiro
        </button>
      </div>
      <div id="connectionsList" style="display: flex; flex-direction: column; gap: 10px;">
        <!-- Conex√µes ser√£o carregadas aqui -->
        <p style="text-align: center; color: #999; padding: 15px;">Carregando conex√µes...</p>
      </div>
    </div>
    
    <!-- Add Connection Modal -->
    <div id="addConnectionModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
      <div style="background: white; padding: 25px; border-radius: 15px; max-width: 450px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0; color: #495057;">Adicionar Parceiro</h3>
          <button onclick="closeAddConnectionModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">&times;</button>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea;">
          <p style="margin: 0 0 8px 0; color: #495057; font-weight: 500;">üì± O teu username:</p>
          <div style="display: flex; align-items: center; gap: 10px;">
            <code id="myUsernameDisplay" style="background: white; padding: 8px 12px; border-radius: 6px; font-size: 1.1em; color: #667eea; font-weight: 600; flex: 1;">@carregando...</code>
            <button type="button" onclick="copyUsername()" style="background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">üìã</button>
          </div>
        </div>
        
        <p style="font-weight: 500; margin-bottom: 10px;">üîç Procura pelo username do parceiro:</p>
        <form onsubmit="searchPartnerUser(event)">
          <div style="display: flex; gap: 10px;">
            <input type="text" id="searchUsername" placeholder="@username" required style="flex: 1; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1em;">
            <button type="submit" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Procurar</button>
          </div>
        </form>
        
        <div id="searchResults" style="margin-top: 15px;">
          <!-- Resultados da pesquisa -->
        </div>
      </div>
    </div>
    
    <div style="margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 12px; border-left: 4px solid #17a2b8;">
      <div style="font-weight: 700; margin-bottom: 10px; color: #0c5460;">üí° Como funciona:</div>
      <ol style="margin: 10px 0 0 20px; line-height: 1.8; color: #6c757d;">
        <li>Cada pessoa responde aos question√°rios no <a href="app.html" style="color: #667eea; font-weight: 600;">app.html</a></li>
        <li>Guardam as respostas num ficheiro .q4c</li>
        <li>Partilham os ficheiros entre si</li>
        <li>Carregam ambos aqui para ver a compatibilidade!</li>
        <li>Usem o <strong>mesmo c√≥digo de seguran√ßa</strong></li>
      </ol>
    </div>
  </div>
  
  <!-- Container onde o relat√≥rio ser√° renderizado -->
  <div id="compatibilityReport" style="display: none; margin-top: 40px;"></div>
  
  <!-- Bot√µes de a√ß√£o (aparecem ap√≥s gerar relat√≥rio) -->
  <div id="actionButtons" style="display: none;" class="action-buttons">
    <button onclick="window.print()" class="btn-action btn-primary">
      üñ®Ô∏è Imprimir Relat√≥rio
    </button>
    <button onclick="window.location.href='app.html'" class="btn-action btn-secondary">
      üîÑ Responder Novamente
    </button>
    <a href="index.html" class="btn-action btn-outline">
      üè† Voltar ao In√≠cio
    </a>
  </div>
  
</div>

<!-- Footer -->
<footer style="margin-top: 60px; padding: 30px 20px; background: rgba(255,255,255,0.9); border-top: 2px solid #d63384; text-align: center;">
  <div style="max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-bottom: 20px;">
      <a href="pages/sobre.html" style="color: #d63384; text-decoration: none; font-weight: 600;">Sobre</a>
      <a href="pages/faq.html" style="color: #d63384; text-decoration: none; font-weight: 600;">FAQ</a>
      <a href="tutorial.html" style="color: #d63384; text-decoration: none; font-weight: 600;">Tutorial</a>
      <a href="pages/privacidade.html" style="color: #d63384; text-decoration: none; font-weight: 600;">Privacidade</a>
    </div>
    <p style="color: #6c757d; font-size: 0.9em; margin: 10px 0;">
      üíï Quest4Couple - Descubram-se juntos
    </p>
    <p style="color: #999; font-size: 0.8em;">
      ¬© 2025 Quest4Couple. Todos os direitos reservados.
    </p>
  </div>
</footer>

<!-- CryptoJS Library (necess√°rio para desencriptar) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<!-- App Scripts -->
<script src="js/firebase-config.js"></script>
<script src="js/auth.js"></script>
<script src="js/notifications.js"></script>

<!-- JavaScript Modules -->
<script src="js/invertMatching.js"></script>
<script src="js/comparison.js"></script>

<script>
  // ========================================
  // CARREGAR CONFIGURA√á√ÉO DE INVERT MATCHING
  // ========================================
  window.addEventListener('DOMContentLoaded', async () => {
    console.log('üì¶ A carregar configura√ß√£o de Invert Matching...');
    await loadInvertMatchingConfig();
    console.log('‚úÖ Configura√ß√£o carregada:', window.invertMatchingConfig ? 'OK' : 'FALHOU');
  });
  
  // ========================================
  // VERIFICA√á√ÉO DE CARREGAMENTO
  // ========================================
  console.log('üîç Verificando fun√ß√µes carregadas:');
  console.log('- compareEncryptedAnswers:', typeof compareEncryptedAnswers);
  console.log('- generateCompatibilityReport:', typeof generateCompatibilityReport);
  console.log('- CryptoJS:', typeof CryptoJS);
  console.log('- loadInvertMatchingConfig:', typeof loadInvertMatchingConfig);
  console.log('- getInvertPair:', typeof getInvertPair);
  
  // ========================================
  // CONTROLO DE AUTENTICA√á√ÉO
  // ========================================
  
  // Esperar que o Firebase esteja pronto
  window.addEventListener('DOMContentLoaded', () => {
    // Listener para mudan√ßas no estado de autentica√ß√£o
    if (typeof auth !== 'undefined') {
      auth.onAuthStateChanged(async (user) => {
        // Controlar sec√ß√£o cloud
        const cloudNotAuth = document.getElementById('cloudNotAuth');
        const cloudAuth = document.getElementById('cloudAuth');
        const connectionsSection = document.getElementById('connectionsSection');
        const connectionRequestsSection = document.getElementById('connectionRequestsSection');
        
        // Controlar header
        const currentUserName = document.getElementById('currentUserName');
        const dashboardBtn = document.getElementById('dashboardBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        if (user) {
          // User autenticado - mostrar sec√ß√£o cloud
          console.log('‚úÖ User autenticado em relatorio.html:', user.email);
          if (cloudNotAuth) cloudNotAuth.style.display = 'none';
          if (cloudAuth) cloudAuth.style.display = 'block';
          if (connectionsSection) connectionsSection.style.display = 'block';
          
          // Atualizar header
          if (currentUserName) currentUserName.textContent = user.displayName || user.email.split('@')[0];
          if (dashboardBtn) dashboardBtn.style.display = 'inline-block';
          if (logoutBtn) logoutBtn.style.display = 'inline-block';
          
          // Carregar conex√µes, pedidos e username
          await loadUserConnections(user.uid);
          await loadConnectionRequests(user.uid);
          await loadMyUsername(user.uid);
        } else {
          // User n√£o autenticado - mostrar bot√£o de login
          console.log('‚ùå User n√£o autenticado em relatorio.html');
          if (cloudNotAuth) cloudNotAuth.style.display = 'block';
          if (cloudAuth) cloudAuth.style.display = 'none';
          if (connectionsSection) connectionsSection.style.display = 'none';
          if (connectionRequestsSection) connectionRequestsSection.style.display = 'none';
          
          // Atualizar header
          if (currentUserName) currentUserName.textContent = 'Visitante';
          if (dashboardBtn) dashboardBtn.style.display = 'none';
          if (logoutBtn) logoutBtn.style.display = 'none';
        }
      });
    }
  });
  
  // ========================================
  // FUN√á√ïES DE CONEX√ïES
  // ========================================
  
  let currentUserUsername = '';
  
  // ========================================
  // PEDIDOS DE CONEX√ÉO
  // ========================================
  
  async function loadConnectionRequests(userId) {
    const requestsSection = document.getElementById('connectionRequestsSection');
    const requestsList = document.getElementById('connectionRequestsList');
    const badge = document.getElementById('requestsBadge');
    
    if (!requestsList) return;
    
    try {
      console.log('üîç Buscando pedidos de conex√£o para:', userId);
      
      // Buscar pedidos pendentes onde sou o destinat√°rio
      // Nota: removido orderBy para evitar problemas com √≠ndices
      const snapshot = await db.collection('connection_requests')
        .where('toUserId', '==', userId)
        .where('status', '==', 'pending')
        .get();
      
      const requests = [];
      snapshot.forEach(doc => {
        requests.push({ id: doc.id, ...doc.data() });
      });
      
      // Ordenar manualmente por data (mais recentes primeiro)
      requests.sort((a, b) => {
        const dateA = a.createdAt?.toDate?.() || new Date(0);
        const dateB = b.createdAt?.toDate?.() || new Date(0);
        return dateB - dateA;
      });
      
      console.log(`üì¨ ${requests.length} pedidos de conex√£o pendentes`);
      
      // Atualizar badge
      if (badge) badge.textContent = requests.length;
      
      // Mostrar/esconder sec√ß√£o
      if (requestsSection) {
        requestsSection.style.display = requests.length > 0 ? 'block' : 'none';
      }
      
      if (requests.length === 0) {
        requestsList.innerHTML = '<p style="text-align: center; color: #999; padding: 10px;">Nenhum pedido pendente</p>';
        return;
      }
      
      // Renderizar pedidos
      let html = '';
      requests.forEach(request => {
        const initials = request.fromUserName ? request.fromUserName.substring(0, 2).toUpperCase() : '??';
        const timeAgo = request.createdAt ? getTimeAgo(request.createdAt.toDate()) : 'agora';
        
        html += `
          <div style="background: white; border: 1px solid #e0e7ff; border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">${initials}</div>
              <div>
                <strong style="color: #333;">${request.fromUserName}</strong>
                <p style="margin: 0; color: #666; font-size: 0.85em;">${timeAgo}</p>
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button onclick="acceptRequest('${request.id}', '${request.fromUserId}', '${request.fromUserName.replace(/'/g, "\\'")}')" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                ‚úÖ Aceitar
              </button>
              <button onclick="rejectRequest('${request.id}', '${request.fromUserName.replace(/'/g, "\\'")}')" style="padding: 8px 16px; background: white; color: #ef4444; border: 2px solid #ef4444; border-radius: 6px; font-weight: 600; cursor: pointer;">
                ‚ùå
              </button>
            </div>
          </div>
        `;
      });
      
      requestsList.innerHTML = html;
      
    } catch (error) {
      console.error('Erro ao carregar pedidos:', error);
      if (requestsSection) requestsSection.style.display = 'none';
    }
  }
  
  // Aceitar pedido de conex√£o
  async function acceptRequest(requestId, fromUserId, fromUserName) {
    try {
      // Atualizar status do pedido
      await db.collection('connection_requests').doc(requestId).update({
        status: 'accepted',
        acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Criar conex√£o com ID previs√≠vel
      const currentUserId = auth.currentUser.uid;
      const connectionId = [currentUserId, fromUserId].sort().join('_');
      
      await db.collection('connections').doc(connectionId).set({
        users: [currentUserId, fromUserId],
        sharedPacks: [],
        report: null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Recarregar dados
      await loadConnectionRequests(currentUserId);
      await loadUserConnections(currentUserId);
      
      // Atualizar dropdown de parceiros
      if (typeof loadConnectedPartners === 'function') {
        await loadConnectedPartners(currentUserId);
      }
      
      alert(`‚úÖ Conectado com ${fromUserName}!`);
      
    } catch (error) {
      console.error('Erro ao aceitar pedido:', error);
      alert('‚ùå Erro ao aceitar pedido. Tenta novamente.');
    }
  }
  
  // Recusar pedido de conex√£o
  async function rejectRequest(requestId, fromUserName) {
    if (!confirm(`Tens a certeza que queres recusar o pedido de ${fromUserName}?`)) {
      return;
    }
    
    try {
      await db.collection('connection_requests').doc(requestId).update({
        status: 'rejected',
        rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      await loadConnectionRequests(auth.currentUser.uid);
      alert('Pedido recusado.');
      
    } catch (error) {
      console.error('Erro ao recusar pedido:', error);
      alert('‚ùå Erro ao recusar pedido. Tenta novamente.');
    }
  }
  
  // Helper: tempo relativo
  function getTimeAgo(date) {
    if (!date) return 'agora';
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'agora';
    if (minutes < 60) return `h√° ${minutes}m`;
    if (hours < 24) return `h√° ${hours}h`;
    if (days < 7) return `h√° ${days}d`;
    return date.toLocaleDateString('pt-PT');
  }
  
  async function loadMyUsername(userId) {
    try {
      const userDoc = await db.collection('users').doc(userId).get();
      if (userDoc.exists) {
        currentUserUsername = userDoc.data().username || '';
        const display = document.getElementById('myUsernameDisplay');
        if (display) {
          display.textContent = currentUserUsername ? `@${currentUserUsername}` : '(sem username)';
        }
      }
    } catch (error) {
      console.error('Erro ao carregar username:', error);
    }
  }
  
  async function loadUserConnections(userId) {
    const connectionsList = document.getElementById('connectionsList');
    if (!connectionsList) return;
    
    try {
      const connectionsSnapshot = await db.collection('connections')
        .where('users', 'array-contains', userId)
        .get();
      
      if (connectionsSnapshot.empty) {
        connectionsList.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #6c757d;">
            <div style="font-size: 2em; margin-bottom: 10px;">üíë</div>
            <p style="margin: 0;">Nenhuma conex√£o ainda. Adiciona o teu parceiro!</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      for (const doc of connectionsSnapshot.docs) {
        const connection = doc.data();
        const partnerId = connection.users.find(id => id !== userId);
        
        if (partnerId) {
          const partnerDoc = await db.collection('users').doc(partnerId).get();
          const partnerData = partnerDoc.exists ? partnerDoc.data() : {};
          const partnerName = partnerData.name || partnerData.email?.split('@')[0] || 'Parceiro';
          const partnerUsername = partnerData.username || '';
          
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #f8f9fa; border-radius: 8px; flex-wrap: wrap; gap: 10px;">
              <div>
                <strong style="color: #495057;">${partnerName}</strong>
                ${partnerUsername ? `<span style="color: #6c757d; font-size: 0.9em;"> @${partnerUsername}</span>` : ''}
              </div>
              <div style="display: flex; gap: 8px;">
                <button onclick="selectPartnerForReport('${partnerId}')" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 0.85em; cursor: pointer;">
                  üìä Gerar Relat√≥rio
                </button>
                <button onclick="deleteConnectionFromRelatorio('${doc.id}', '${partnerName.replace(/'/g, "\\'")}')" style="padding: 6px 12px; background: #fff5f5; color: #dc3545; border: 2px solid #dc3545; border-radius: 6px; font-size: 0.85em; cursor: pointer;" title="Remover conex√£o">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          `;
        }
      }
      
      connectionsList.innerHTML = html || '<p style="text-align: center; color: #999;">Erro ao carregar conex√µes</p>';
      
    } catch (error) {
      console.error('Erro ao carregar conex√µes:', error);
      connectionsList.innerHTML = '<p style="text-align: center; color: #dc3545;">Erro ao carregar conex√µes</p>';
    }
  }
  
  function selectPartnerForReport(partnerId) {
    const partnerSelect = document.getElementById('partnerSelect');
    if (partnerSelect) {
      partnerSelect.value = partnerId;
      // Scroll para a sec√ß√£o cloud e gerar
      document.getElementById('cloudSection').scrollIntoView({ behavior: 'smooth' });
      setTimeout(() => generateCloudReport(), 500);
    }
  }
  
  function openAddConnectionModal() {
    const modal = document.getElementById('addConnectionModal');
    if (modal) modal.style.display = 'flex';
  }
  
  function closeAddConnectionModal() {
    const modal = document.getElementById('addConnectionModal');
    if (modal) modal.style.display = 'none';
  }
  
  function copyUsername() {
    const username = currentUserUsername ? `@${currentUserUsername}` : '';
    if (username) {
      navigator.clipboard.writeText(username).then(() => {
        alert('Username copiado! Partilha com o teu parceiro üíï');
      });
    }
  }
  
  async function searchPartnerUser(event) {
    event.preventDefault();
    const searchInput = document.getElementById('searchUsername');
    const resultsDiv = document.getElementById('searchResults');
    const username = searchInput.value.replace('@', '').toLowerCase().trim();
    
    if (!username) {
      resultsDiv.innerHTML = '<p style="color: #dc3545;">Por favor, insere um username.</p>';
      return;
    }
    
    resultsDiv.innerHTML = '<p style="color: #6c757d;">üîç A procurar...</p>';
    
    try {
      const usersSnapshot = await db.collection('users')
        .where('username', '==', username)
        .limit(1)
        .get();
      
      if (usersSnapshot.empty) {
        resultsDiv.innerHTML = '<p style="color: #dc3545;">Utilizador n√£o encontrado. Verifica o username.</p>';
        return;
      }
      
      const userDoc = usersSnapshot.docs[0];
      const userData = userDoc.data();
      const foundUserId = userDoc.id;
      
      // Verificar se n√£o √© o pr√≥prio user
      if (foundUserId === auth.currentUser.uid) {
        resultsDiv.innerHTML = '<p style="color: #dc3545;">N√£o podes adicionar-te a ti mesmo!</p>';
        return;
      }
      
      resultsDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #e8f5e9; border-radius: 8px; margin-top: 10px;">
          <div>
            <strong>${userData.name || 'Utilizador'}</strong>
            <span style="color: #6c757d; font-size: 0.9em;"> @${userData.username}</span>
          </div>
          <button onclick="sendConnectionRequest('${foundUserId}', '${userData.name || 'Utilizador'}')" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
            ‚ûï Enviar Pedido
          </button>
        </div>
      `;
      
    } catch (error) {
      console.error('Erro ao procurar utilizador:', error);
      resultsDiv.innerHTML = '<p style="color: #dc3545;">Erro na pesquisa. Tenta novamente.</p>';
    }
  }
  
  async function sendConnectionRequest(toUserId, toUserName) {
    const resultsDiv = document.getElementById('searchResults');
    
    try {
      const user = auth.currentUser;
      
      // Verificar se j√° existe conex√£o
      const existingConnection = await db.collection('connections')
        .where('users', 'array-contains', user.uid)
        .get();
      
      let alreadyConnected = false;
      existingConnection.forEach(doc => {
        if (doc.data().users.includes(toUserId)) {
          alreadyConnected = true;
        }
      });
      
      if (alreadyConnected) {
        resultsDiv.innerHTML = '<p style="color: #ffc107; font-weight: 600;">‚ö†Ô∏è J√° tens conex√£o com este utilizador!</p>';
        return;
      }
      
      // Verificar se j√° existe pedido pendente
      const existingRequest = await db.collection('connection_requests')
        .where('fromUserId', '==', user.uid)
        .where('toUserId', '==', toUserId)
        .where('status', '==', 'pending')
        .get();
      
      if (!existingRequest.empty) {
        resultsDiv.innerHTML = '<p style="color: #ffc107; font-weight: 600;">‚ö†Ô∏è J√° enviaste um pedido para este utilizador!</p>';
        return;
      }
      
      // Obter nome do user atual
      const myUserDoc = await db.collection('users').doc(user.uid).get();
      const myName = myUserDoc.exists ? (myUserDoc.data().name || user.email.split('@')[0]) : user.email.split('@')[0];
      
      // Criar pedido de conex√£o
      await db.collection('connection_requests').add({
        fromUserId: user.uid,
        fromUserName: myName,
        toUserId: toUserId,
        toUserName: toUserName,
        status: 'pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      resultsDiv.innerHTML = `
        <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
          <div style="font-size: 2em; margin-bottom: 10px;">‚úÖ</div>
          <strong style="color: #155724;">Pedido enviado!</strong>
          <p style="margin: 10px 0 0 0; color: #155724;">Aguarda que ${toUserName} aceite o teu pedido.</p>
        </div>
      `;
      
      setTimeout(() => closeAddConnectionModal(), 2000);
      
    } catch (error) {
      console.error('Erro ao enviar pedido:', error);
      resultsDiv.innerHTML = '<p style="color: #dc3545;">Erro ao enviar pedido. Tenta novamente.</p>';
    }
  }
  
  // ========================================
  // FUN√á√ÉO DE LOGOUT
  // ========================================
  
  function logout() {
    if (confirm('Tens a certeza que queres sair?')) {
      auth.signOut().then(() => {
        console.log('‚úÖ Logout com sucesso');
        window.location.href = 'index.html';
      }).catch((error) => {
        console.error('‚ùå Erro no logout:', error);
        alert('Erro ao fazer logout. Por favor tenta novamente.');
      });
    }
  }
  
  // ========================================
  // ELIMINAR CONEX√ÉO COM PARCEIRO
  // ========================================
  async function deleteConnectionFromRelatorio(connectionId, partnerName) {
    // Primeiro aviso
    if (!confirm(`Tens a certeza que queres remover a conex√£o com ${partnerName}?`)) {
      return;
    }
    
    // Segundo aviso (dupla confirma√ß√£o)
    if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO: Ao remover a conex√£o:\n\n‚Ä¢ Voc√™s deixam de poder ver as respostas um do outro\n‚Ä¢ Para se reconectarem, ter√£o de enviar novo pedido\n\nTens a certeza ABSOLUTA que queres remover ${partnerName}?`)) {
      return;
    }
    
    try {
      // Apagar o documento de conex√£o
      await db.collection('connections').doc(connectionId).delete();
      
      console.log(`‚úÖ Conex√£o ${connectionId} eliminada com sucesso`);
      
      // Recarregar conex√µes
      await loadUserConnections(auth.currentUser.uid);
      
      // Atualizar tamb√©m o dropdown de parceiros
      if (typeof loadConnectedPartners === 'function') {
        await loadConnectedPartners(auth.currentUser.uid);
      }
      
      alert(`‚úÖ Conex√£o com ${partnerName} removida.`);
      
    } catch (error) {
      console.error('Erro ao eliminar conex√£o:', error);
      alert('‚ùå Erro ao remover conex√£o. Tenta novamente.');
    }
  }
  
  // ========================================
  // MOSTRAR BOT√ïES AP√ìS GERAR RELAT√ìRIO
  // ========================================
  
  // Mostrar bot√µes de a√ß√£o ap√≥s gerar relat√≥rio
  const originalGenerateReport = window.generateCompatibilityReport;
  if (originalGenerateReport) {
    window.generateCompatibilityReport = async function(...args) {
      await originalGenerateReport.apply(this, args);
      document.getElementById('actionButtons').style.display = 'flex';
      document.getElementById('uploadSection').style.display = 'none';
    };
  }
</script>

</body>
</html>
