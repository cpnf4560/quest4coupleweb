<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Test Firestore Permissions - Quest4Couple</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #ff6b9d;
      text-align: center;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 5px;
      border-left: 4px solid #ff6b9d;
    }
    .test-result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      background: #ff6b9d;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #ff4081;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }
    .log {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  
  <div class="test-container">
    <h1>ğŸ§ª Test Firestore Permissions</h1>
    <p style="text-align: center; color: #666;">Teste as permissÃµes do Firestore em tempo real</p>
    
    <!-- User Info -->
    <div class="test-section">
      <h3>ğŸ‘¤ Estado de AutenticaÃ§Ã£o</h3>
      <div id="authStatus" class="test-result info">
        â³ Verificando autenticaÃ§Ã£o...
      </div>
      <button onclick="checkAuth()">ğŸ”„ Verificar AutenticaÃ§Ã£o</button>
      <button onclick="testEmailSignup()">ğŸ“ Testar Registo Email</button>
      <button onclick="testGoogleSignIn()">ğŸ”µ Testar Google Sign-In</button>
      <button onclick="logout()">ğŸšª Logout</button>
    </div>
    
    <!-- Test Results -->
    <div class="test-section">
      <h3>ğŸ“Š Resultados dos Testes</h3>
      <div id="testResults"></div>
    </div>
    
    <!-- Firestore Rules Check -->
    <div class="test-section">
      <h3>ğŸ” VerificaÃ§Ã£o de Regras</h3>
      <button onclick="testReadUsers()">ğŸ“– Testar Leitura (users)</button>
      <button onclick="testCreateUser()">âœï¸ Testar CriaÃ§Ã£o (users)</button>
      <button onclick="testUpdateUser()">âœï¸ Testar AtualizaÃ§Ã£o (users)</button>
      <button onclick="testReadActivities()">ğŸ“š Testar Leitura (activities)</button>
      <div id="rulesResults"></div>
    </div>
    
    <!-- Console Logs -->
    <div class="test-section">
      <h3>ğŸ“ Console Logs</h3>
      <div id="consoleLogs" style="max-height: 400px; overflow-y: auto;"></div>
      <button onclick="clearLogs()">ğŸ—‘ï¸ Limpar Logs</button>
    </div>
  </div>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <!-- Firebase Config -->
  <script src="js/firebase-config.js"></script>
  
  <!-- Auth.js - Sistema de autenticaÃ§Ã£o (com createOrUpdateUserProfile) -->
  <script src="js/auth.js"></script>
  
  <script>
    // ============================================
    // LOGGING SYSTEM
    // ============================================
    const logs = [];
    
    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const emoji = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
      const logMessage = `${emoji} [${timestamp}] ${message}`;
      
      logs.push({ message: logMessage, type });
      console.log(logMessage);
      
      // Update UI
      const logsDiv = document.getElementById('consoleLogs');
      const logElement = document.createElement('div');
      logElement.className = `log test-result ${type}`;
      logElement.textContent = logMessage;
      logsDiv.insertBefore(logElement, logsDiv.firstChild);
    }
    
    function clearLogs() {
      document.getElementById('consoleLogs').innerHTML = '';
      logs.length = 0;
      addLog('Logs limpos', 'info');
    }
    
    function showTestResult(message, type = 'info') {
      const resultsDiv = document.getElementById('testResults');
      const resultElement = document.createElement('div');
      resultElement.className = `test-result ${type}`;
      resultElement.innerHTML = message;
      resultsDiv.insertBefore(resultElement, resultsDiv.firstChild);
    }
    
    function showRulesResult(message, type = 'info') {
      const resultsDiv = document.getElementById('rulesResults');
      const resultElement = document.createElement('div');
      resultElement.className = `test-result ${type}`;
      resultElement.innerHTML = message;
      resultsDiv.insertBefore(resultElement, resultsDiv.firstChild);
    }
      // ============================================
    // AUTH STATE OBSERVER (UI Update Only)
    // ============================================
    // Nota: O auth.js jÃ¡ tem um onAuthStateChanged que cria perfis
    // Este Ã© apenas para atualizar a UI
    auth.onAuthStateChanged((user) => {
      const statusDiv = document.getElementById('authStatus');
      
      if (user) {
        statusDiv.className = 'test-result success';
        statusDiv.innerHTML = `
          âœ… <strong>Autenticado</strong><br>
          ğŸ“§ Email: ${user.email}<br>
          ğŸ†” UID: ${user.uid}<br>
          ğŸ‘¤ Nome: ${user.displayName || 'N/A'}<br>
          ğŸ”‘ Provider: ${user.providerData[0]?.providerId || 'N/A'}
        `;
        addLog(`[UI] Utilizador autenticado: ${user.email}`, 'success');
      } else {
        statusDiv.className = 'test-result error';
        statusDiv.innerHTML = 'âŒ <strong>NÃ£o autenticado</strong><br>Por favor, faÃ§a login para testar as permissÃµes.';
        addLog('[UI] Utilizador nÃ£o autenticado', 'warning');
      }
    });
    
    // ============================================
    // AUTH TESTS
    // ============================================
    function checkAuth() {
      addLog('ğŸ” Verificando autenticaÃ§Ã£o...', 'info');
      const user = auth.currentUser;
      
      if (user) {
        addLog(`âœ… Utilizador: ${user.email} (UID: ${user.uid})`, 'success');
        showTestResult(`âœ… <strong>Autenticado:</strong> ${user.email}`, 'success');
      } else {
        addLog('âŒ Nenhum utilizador autenticado', 'error');
        showTestResult('âŒ <strong>NÃ£o autenticado.</strong> Por favor, faÃ§a login.', 'error');
      }
    }
    
    async function testEmailSignup() {
      addLog('ğŸ“ Iniciando teste de registo com email...', 'info');
      
      const testEmail = `test_${Date.now()}@quest4couple.test`;
      const testPassword = 'Test123456!';
      const testName = 'Test User';
      
      try {
        addLog(`ğŸ“§ Criando utilizador: ${testEmail}`, 'info');
        
        // Create user
        const userCredential = await auth.createUserWithEmailAndPassword(testEmail, testPassword);
        const user = userCredential.user;
        
        addLog(`âœ… Utilizador criado no Firebase Auth: ${user.uid}`, 'success');
        
        // Update profile
        await user.updateProfile({ displayName: testName });
        addLog('âœ… DisplayName atualizado', 'success');
        
        // Store data temporarily
        const additionalData = {
          displayName: testName,
          name: testName,
          gender: 'male',
          ageRange: '25-34',
          country: 'PT'
        };
        
        sessionStorage.setItem('pendingUserData', JSON.stringify(additionalData));
        addLog('ğŸ’¾ Dados adicionais guardados no sessionStorage', 'success');
        
        // Wait for profile creation
        addLog('â³ Aguardando criaÃ§Ã£o do perfil no Firestore...', 'info');
        
        setTimeout(async () => {
          try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            
            if (userDoc.exists) {
              addLog('âœ… Perfil criado no Firestore com sucesso!', 'success');
              showTestResult(`âœ… <strong>Registo bem-sucedido!</strong><br>Email: ${testEmail}<br>Perfil criado no Firestore.`, 'success');
            } else {
              addLog('âŒ Perfil NÃƒO foi criado no Firestore!', 'error');
              showTestResult(`âš ï¸ <strong>Registo parcial:</strong><br>Utilizador criado no Auth, mas perfil nÃ£o apareceu no Firestore.<br>Verificar logs do console para detalhes.`, 'error');
            }
          } catch (error) {
            addLog(`âŒ Erro ao verificar perfil: ${error.message}`, 'error');
            showTestResult(`âŒ <strong>Erro:</strong> ${error.message}`, 'error');
          }
        }, 3000);
        
      } catch (error) {
        addLog(`âŒ Erro no registo: ${error.code} - ${error.message}`, 'error');
        showTestResult(`âŒ <strong>Erro no registo:</strong><br>${error.code}<br>${error.message}`, 'error');
      }
    }
    
    async function testGoogleSignIn() {
      addLog('ğŸ”µ Iniciando Google Sign-In...', 'info');
      
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        
        addLog(`âœ… Login Google bem-sucedido: ${result.user.email}`, 'success');
        showTestResult(`âœ… <strong>Google Sign-In bem-sucedido!</strong><br>Email: ${result.user.email}`, 'success');
        
      } catch (error) {
        addLog(`âŒ Erro no Google Sign-In: ${error.code} - ${error.message}`, 'error');
        showTestResult(`âŒ <strong>Erro no Google Sign-In:</strong><br>${error.code}<br>${error.message}`, 'error');
      }
    }
    
    async function logout() {
      addLog('ğŸšª Fazendo logout...', 'info');
      
      try {
        await auth.signOut();
        addLog('âœ… Logout bem-sucedido', 'success');
        showTestResult('âœ… <strong>Logout bem-sucedido!</strong>', 'success');
      } catch (error) {
        addLog(`âŒ Erro no logout: ${error.message}`, 'error');
        showTestResult(`âŒ <strong>Erro no logout:</strong> ${error.message}`, 'error');
      }
    }
    
    // ============================================
    // FIRESTORE RULES TESTS
    // ============================================
    async function testReadUsers() {
      addLog('ğŸ“– Testando leitura da collection users...', 'info');
      
      const user = auth.currentUser;
      if (!user) {
        addLog('âŒ NÃ£o autenticado. FaÃ§a login primeiro.', 'error');
        showRulesResult('âŒ <strong>NÃ£o autenticado.</strong> FaÃ§a login para testar.', 'error');
        return;
      }
      
      try {
        addLog(`ğŸ” Buscando utilizadores... (auth.uid: ${user.uid})`, 'info');
        const snapshot = await db.collection('users').limit(5).get();
        
        addLog(`âœ… Leitura bem-sucedida! ${snapshot.size} documentos encontrados`, 'success');
        showRulesResult(`âœ… <strong>Leitura permitida!</strong><br>Documentos encontrados: ${snapshot.size}`, 'success');
        
      } catch (error) {
        addLog(`âŒ Erro na leitura: ${error.code} - ${error.message}`, 'error');
        showRulesResult(`âŒ <strong>Leitura negada!</strong><br>${error.code}<br>${error.message}`, 'error');
      }
    }
    
    async function testCreateUser() {
      addLog('âœï¸ Testando criaÃ§Ã£o de documento em users...', 'info');
      
      const user = auth.currentUser;
      if (!user) {
        addLog('âŒ NÃ£o autenticado. FaÃ§a login primeiro.', 'error');
        showRulesResult('âŒ <strong>NÃ£o autenticado.</strong> FaÃ§a login para testar.', 'error');
        return;
      }
      
      try {
        addLog(`ğŸ” Tentando criar perfil para UID: ${user.uid}`, 'info');
        addLog(`ğŸ“ Auth UID: ${user.uid}`, 'info');
        
        const userRef = db.collection('users').doc(user.uid);
        const doc = await userRef.get();
        
        if (doc.exists) {
          addLog('â„¹ï¸ Perfil jÃ¡ existe. Testando atualizaÃ§Ã£o...', 'info');
          await userRef.update({
            testField: firebase.firestore.FieldValue.serverTimestamp()
          });
          addLog('âœ… AtualizaÃ§Ã£o bem-sucedida!', 'success');
          showRulesResult('âœ… <strong>AtualizaÃ§Ã£o permitida!</strong><br>(Perfil jÃ¡ existia)', 'success');
        } else {
          addLog('ğŸ“ Criando novo perfil...', 'info');
          await userRef.set({
            uid: user.uid,
            email: user.email,
            displayName: user.displayName || 'Test User',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            isAdmin: false
          });
          addLog('âœ… CriaÃ§Ã£o bem-sucedida!', 'success');
          showRulesResult('âœ… <strong>CriaÃ§Ã£o permitida!</strong><br>Perfil criado com sucesso.', 'success');
        }
        
      } catch (error) {
        addLog(`âŒ Erro na criaÃ§Ã£o: ${error.code} - ${error.message}`, 'error');
        addLog(`âš ï¸ Auth UID: ${user.uid}`, 'warning');
        addLog(`âš ï¸ Document ID: ${user.uid}`, 'warning');
        showRulesResult(`âŒ <strong>CriaÃ§Ã£o negada!</strong><br>${error.code}<br>${error.message}<br><br>â„¹ï¸ Verificar se:<br>â€¢ Auth UID (${user.uid}) == Document ID<br>â€¢ Regra: allow create: if request.auth.uid == userId`, 'error');
      }
    }
    
    async function testUpdateUser() {
      addLog('âœï¸ Testando atualizaÃ§Ã£o de documento em users...', 'info');
      
      const user = auth.currentUser;
      if (!user) {
        addLog('âŒ NÃ£o autenticado. FaÃ§a login primeiro.', 'error');
        showRulesResult('âŒ <strong>NÃ£o autenticado.</strong> FaÃ§a login para testar.', 'error');
        return;
      }
      
      try {
        addLog(`ğŸ” Tentando atualizar perfil UID: ${user.uid}`, 'info');
        
        const userRef = db.collection('users').doc(user.uid);
        await userRef.update({
          lastTestAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        addLog('âœ… AtualizaÃ§Ã£o bem-sucedida!', 'success');
        showRulesResult('âœ… <strong>AtualizaÃ§Ã£o permitida!</strong>', 'success');
        
      } catch (error) {
        addLog(`âŒ Erro na atualizaÃ§Ã£o: ${error.code} - ${error.message}`, 'error');
        
        if (error.code === 'not-found') {
          showRulesResult(`âš ï¸ <strong>Documento nÃ£o existe.</strong><br>Crie o perfil primeiro.`, 'error');
        } else {
          showRulesResult(`âŒ <strong>AtualizaÃ§Ã£o negada!</strong><br>${error.code}<br>${error.message}`, 'error');
        }
      }
    }
    
    async function testReadActivities() {
      addLog('ğŸ“š Testando leitura da collection activities...', 'info');
      
      const user = auth.currentUser;
      if (!user) {
        addLog('âŒ NÃ£o autenticado. FaÃ§a login primeiro.', 'error');
        showRulesResult('âŒ <strong>NÃ£o autenticado.</strong> FaÃ§a login para testar.', 'error');
        return;
      }
      
      try {
        addLog('ğŸ” Buscando atividades...', 'info');
        const snapshot = await db.collection('activities').limit(5).get();
        
        addLog(`âœ… Leitura bem-sucedida! ${snapshot.size} documentos encontrados`, 'success');
        showRulesResult(`âœ… <strong>Leitura permitida!</strong><br>Documentos encontrados: ${snapshot.size}`, 'success');
        
      } catch (error) {
        addLog(`âŒ Erro na leitura: ${error.code} - ${error.message}`, 'error');
        showRulesResult(`âŒ <strong>Leitura negada!</strong><br>${error.code}<br>${error.message}`, 'error');
      }
    }
    
    // ============================================
    // INITIALIZE
    // ============================================
    addLog('ğŸš€ Sistema de testes iniciado', 'success');
    addLog('â„¹ï¸ Aguardando autenticaÃ§Ã£o...', 'info');
    
  </script>

</body>
</html>
