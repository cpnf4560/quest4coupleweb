<!DOCTYPE html>
<html lang="pt">
<head>  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin BackOffice - Quest4Couple</title>
  
  <!-- Microsoft Clarity -->
  <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "u8hwuw3ixs");
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    /* Login Container */
    .login-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-width: 400px;
      margin: 100px auto;
    }
    
    .admin-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .admin-header img {
      width: 120px;
      height: auto;
      margin-bottom: 15px;
    }
    
    .admin-header h1 {
      color: #667eea;
      font-size: 1.8em;
      margin-bottom: 5px;
    }
    
    .admin-header p {
      color: #6c757d;
      font-size: 0.9em;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #495057;
      font-weight: 600;
      font-size: 0.9em;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn-login {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-login:active {
      transform: translateY(0);
    }
    
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 0.9em;
      display: none;
      border: 1px solid #f5c6cb;
    }
    
    .error-message.show {
      display: block;
      animation: shake 0.3s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    .back-link {
      display: inline-block;
      margin-top: 20px;
      color: #667eea;
      text-decoration: none;
      font-size: 0.9em;
      transition: color 0.3s;
      text-align: center;
      width: 100%;
    }
    
    .back-link:hover {
      color: #764ba2;
    }
    
    /* Admin Dashboard */
    .admin-dashboard {
      display: none;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .dashboard-header {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .dashboard-header h1 {
      color: #667eea;
      font-size: 2em;
    }
    
    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .admin-info {
      font-size: 0.9em;
      color: #6c757d;
    }
    
    .btn-logout {
      padding: 10px 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .btn-logout:hover {
      background: #c82333;
    }
    
    /* Tabs Navigation */
    .tabs-nav {
      background: white;
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .tab-btn {
      padding: 12px 24px;
      background: #f8f9fa;
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95em;
      color: #6c757d;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tab-btn:hover {
      background: #e9ecef;
      border-color: #667eea;
    }
    
    .tab-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }
    
    /* Tab Content */
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      border-left: 5px solid;
      transition: transform 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card.purple { border-color: #667eea; }
    .stat-card.pink { border-color: #f093fb; }
    .stat-card.blue { border-color: #4facfe; }
    .stat-card.green { border-color: #43e97b; }
    
    .stat-card h3 {
      font-size: 0.85em;
      color: #6c757d;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-value {
      font-size: 2.5em;
      font-weight: 700;
      color: #495057;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.9em;
      color: #6c757d;
    }
    
    /* Content Card */
    .content-card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .content-card h2 {
      color: #495057;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Table Styles */
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }
    
    thead {
      background: #f8f9fa;
    }
    
    th {
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
    }
    
    /* Sortable Table Headers */
    th.sortable {
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    
    th.sortable:hover {
      background: #e9ecef;
    }
    
    th.sortable .sort-icon {
      margin-left: 5px;
      opacity: 0.4;
      font-size: 0.9em;
    }
    
    th.sortable.sorted-asc .sort-icon,
    th.sortable.sorted-desc .sort-icon {
      opacity: 1;
      color: #667eea;
    }
    
    th.sortable.sorted-asc .sort-icon::after {
      content: 'â†‘';
    }
    
    th.sortable.sorted-desc .sort-icon::after {
      content: 'â†“';
    }
    
    th.sortable.sorted-asc .sort-icon,
    th.sortable.sorted-desc .sort-icon {
      font-weight: bold;
    }
    
    td {
      padding: 15px 12px;
      border-bottom: 1px solid #f1f3f5;
      color: #495057;
    }
    
    tbody tr:hover {
      background: #f8f9fa;
    }
    
    .user-email {
      font-weight: 600;
      color: #667eea;
    }
    
    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
      display: inline-block;
    }
    
    .badge-male {
      background: #cfe2ff;
      color: #084298;
    }
    
    .badge-female {
      background: #f8d7da;
      color: #842029;
    }
    
    .badge-other {
      background: #fff3cd;
      color: #664d03;
    }
    
    /* Filters */
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.85em;
      color: #6c757d;
      font-weight: 600;
    }
    
    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 0.9em;
    }
    
    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn-filter {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .btn-filter:hover {
      background: #5568d3;
    }
    
    .btn-reset {
      padding: 10px 20px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .btn-reset:hover {
      background: #5a6268;
    }
    
    /* Activity Log */
    .activity-item {
      padding: 15px;
      border-left: 4px solid #667eea;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .activity-type {
      font-weight: 600;
      color: #667eea;
    }
    
    .activity-time {
      font-size: 0.85em;
      color: #6c757d;
    }
    
    .activity-details {
      font-size: 0.9em;
      color: #495057;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Export Button */
    .btn-export {
      padding: 8px 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9em;
      transition: background 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
      .btn-export:hover {
      background: #218838;
    }
    
    /* Analytics Cards */
    .report-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
    }
    
    .question-analytics-card {
      transition: all 0.3s;
    }
    
    .question-analytics-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      animation: fadeIn 0.3s;
    }
    
    .modal-content {
      background-color: white;
      margin: 2% auto;
      padding: 0;
      border-radius: 15px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow: hidden;
      animation: slideDown 0.3s;
      box-shadow: 0 10px 50px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      margin: 0;
      font-size: 1.5em;
    }
    
    .modal-close {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.5em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .modal-close:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }
    
    .modal-body {
      padding: 30px;
      max-height: calc(90vh - 160px);
      overflow-y: auto;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideDown {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        gap: 15px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .filters {
        flex-direction: column;
      }
      
      table {
        font-size: 0.8em;
      }
      
      th, td {
        padding: 10px 8px;
      }
    }
  </style>
</head>
<body>

  <!-- LOGIN FORM -->
  <div class="login-container" id="loginContainer">
    <div class="admin-header">
      <img src="../assets/logo.png" alt="Quest4Couple">
      <h1>ğŸ” Admin BackOffice</h1>
      <p>Acesso Restrito - Administradores</p>
    </div>
    
    <div class="error-message" id="errorMessage">
      âŒ Credenciais invÃ¡lidas!
    </div>
    
    <form id="adminLoginForm">
      <div class="form-group">
        <label for="adminUsername">ğŸ‘¤ Username</label>
        <input 
          type="text" 
          id="adminUsername" 
          placeholder="user admin" 
          required 
          autocomplete="username"
        >
      </div>
      
      <div class="form-group">
        <label for="adminPassword">ğŸ”’ Password</label>
        <input 
          type="password" 
          id="adminPassword" 
          placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" 
          required
          autocomplete="current-password"
        >
      </div>
      
      <button type="submit" class="btn-login">
        ğŸ”“ Entrar no BackOffice
      </button>
    </form>
    
    <a href="../index.html" class="back-link">â† Voltar ao site</a>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div class="admin-dashboard" id="adminDashboard">
      <!-- Header -->
    <div class="dashboard-header">
      <div>
        <h1>ğŸ“Š Quest4Couple - BackOffice</h1>
        <div class="admin-info">Bem-vindo, <strong id="adminName">Admin</strong></div>
      </div>
      <div class="header-actions">
        <button class="btn-primary" onclick="manualReloadAllData()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 10px;">
          ğŸ”„ Recarregar Todos os Dados
        </button>
        <button class="btn-logout" onclick="logout()">ğŸšª Sair</button>
      </div>
    </div>
    
    <!-- Data Loading Status -->
    <div id="dataLoadingStatus" style="display: none; background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="color: #667eea; margin: 0;">âš™ï¸ Carregamento de Dados</h3>
        <span id="lastLoadTime" style="color: #6c757d; font-size: 0.9em;">Ãšltimo carregamento: Nunca</span>
      </div>
      <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <span style="font-weight: 600; color: #495057;">Carregamento AutomÃ¡tico:</span>
          <span id="autoLoadStatus" style="color: #28a745; font-weight: 600;">âœ… Ativo (7h00 e 19h00)</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 600; color: #495057;">PrÃ³ximo carregamento:</span>
          <span id="nextLoadTime" style="color: #667eea; font-weight: 600;">--:--</span>
        </div>
      </div>
      <div id="loadingProgressContainer" style="display: none;">
        <div style="margin-bottom: 10px;">
          <span id="loadingStage" style="font-weight: 600; color: #667eea;">A carregar...</span>
          <span id="loadingPercentage" style="float: right; color: #6c757d; font-weight: 600;">0%</span>
        </div>
        <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden;">
          <div id="loadingProgressBar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
        </div>
      </div>
    </div>
    
    <!-- Tabs Navigation -->
    <div class="tabs-nav">
      <button class="tab-btn active" onclick="showTab('dashboard')">
        ğŸ“Š Dashboard
      </button>
      <button class="tab-btn" onclick="showTab('users')">
        ğŸ‘¥ Utilizadores
      </button>
      <button class="tab-btn" onclick="showTab('partialReports')">
        ğŸ“ Respostas
      </button>
      <button class="tab-btn" onclick="showTab('fullReports')">
        ğŸ“‹ RelatÃ³rios Completos
      </button>
      <button class="tab-btn" onclick="showTab('questions')">
        ğŸ” AnÃ¡lise de QuestÃµes
      </button>
      <button class="tab-btn" onclick="showTab('activity')">
        ğŸ“œ Log de Atividade
      </button>
    </div>
    
    <!-- TAB: DASHBOARD -->
    <div id="tab-dashboard" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card purple">
          <h3>ğŸ‘¥ Total Utilizadores</h3>
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-label">registados na plataforma</div>
        </div>
        
        <div class="stat-card pink">
          <h3>ğŸ†• Novos Hoje</h3>
          <div class="stat-value" id="newUsersToday">0</div>
          <div class="stat-label">registos nas Ãºltimas 24h</div>
        </div>
        
        <div class="stat-card blue">
          <h3>ğŸ’‘ Casais Ativos</h3>
          <div class="stat-value" id="activeCouples">0</div>
          <div class="stat-label">conexÃµes estabelecidas</div>
        </div>
        
        <div class="stat-card green">
          <h3>ğŸ“Š RelatÃ³rios</h3>
          <div class="stat-value" id="totalReports">0</div>
          <div class="stat-label">relatÃ³rios gerados</div>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card purple">
          <h3>â™‚ï¸ Masculino</h3>
          <div class="stat-value" id="maleUsers">0</div>
          <div class="stat-label">utilizadores</div>
        </div>
        
        <div class="stat-card pink">
          <h3>â™€ï¸ Feminino</h3>
          <div class="stat-value" id="femaleUsers">0</div>
          <div class="stat-label">utilizadores</div>
        </div>
          <div class="stat-card blue">
          <h3>âš§ï¸ Outro/ND</h3>
          <div class="stat-value" id="otherUsers">0</div>
          <div class="stat-label">utilizadores</div>
        </div>
        
        <div class="stat-card green">
          <h3>ğŸŒ PaÃ­ses</h3>
          <div class="stat-value" id="totalCountries">0</div>
          <div class="stat-label">paÃ­ses diferentes</div>
        </div>
      </div>
      
      <!-- EstatÃ­sticas de RelatÃ³rios e Respostas -->
      <div class="stats-grid">
        <div class="stat-card purple">
          <h3>ğŸ“ Total Respostas</h3>
          <div class="stat-value" id="totalAnswers">0</div>
          <div class="stat-label">questÃµes respondidas</div>
        </div>
        
        <div class="stat-card pink">
          <h3>ğŸ“… RelatÃ³rios Hoje</h3>
          <div class="stat-value" id="reportsToday">0</div>
          <div class="stat-label">gerados nas Ãºltimas 24h</div>
        </div>
        
        <div class="stat-card blue">
          <h3>ğŸ“† Esta Semana</h3>
          <div class="stat-value" id="reportsWeek">0</div>
          <div class="stat-label">Ãºltimos 7 dias</div>
        </div>
        
        <div class="stat-card green">
          <h3>ğŸ“Š MÃ©dia/Casal</h3>
          <div class="stat-value" id="reportsAvg">0</div>
          <div class="stat-label">relatÃ³rios por casal</div>
        </div>
      </div>
    </div>
    
    <!-- TAB: USERS -->    <div id="tab-users" class="tab-content">
      <div class="content-card">
        <h2>
          ğŸ‘¥ Utilizadores Registados
          <button class="btn-export" onclick="exportUsers()">
            ğŸ“¥ Exportar CSV
          </button>
          <button class="btn-export" onclick="migrateUsernames()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            ğŸ”§ Migrar Usernames
          </button>
        </h2>
        
        <div id="migrationAlert" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.5em;">âš ï¸</span>
            <div style="flex: 1;">
              <strong>Utilizadores sem username:</strong> <span id="usersWithoutUsername">0</span>
              <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #856404;">
                Alguns utilizadores ainda nÃ£o tÃªm username definido. Clique em "Migrar Usernames" para adicionar automaticamente.
              </p>
            </div>
          </div>
        </div>
        
        <div class="filters">          <div class="filter-group">
            <label for="searchUser">ğŸ” Pesquisar</label>
            <input type="text" id="searchUser" placeholder="Nome ou email..." onkeyup="filterUsers()">
          </div>
          <div class="filter-group">
            <label for="filterGender">âš§ï¸ Sexo</label>
            <select id="filterGender" onchange="filterUsers()">
              <option value="">Todos</option>
              <option value="M">â™‚ï¸ Masculino</option>
              <option value="F">â™€ï¸ Feminino</option>
              <option value="outro">âš§ï¸ Outro</option>
              <option value="nd">â“ NÃ£o definido</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterCountry">ğŸŒ PaÃ­s</label>
            <select id="filterCountry" onchange="filterUsers()">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="filter-group" style="display: flex; align-items: flex-end; gap: 10px;">
            <button class="btn-reset" onclick="resetFilters()">ğŸ”„ Limpar</button>
          </div>
        </div>
        
        <div class="loading" id="loadingUsers">
          <div class="loading-spinner"></div>
          <p>A carregar utilizadores...</p>
        </div>
        
        <div class="table-container" id="usersTableContainer" style="display: none;">
          <table id="usersTable">            <thead>
              <tr>
                <th class="sortable" onclick="sortUsersTable(0, 'string')">Email <span class="sort-icon">â‡…</span></th>
                <th class="sortable" onclick="sortUsersTable(1, 'string')">Nome <span class="sort-icon">â‡…</span></th>
                <th class="sortable" onclick="sortUsersTable(2, 'string')">Username <span class="sort-icon">â‡…</span></th>
                <th class="sortable" onclick="sortUsersTable(3, 'string')">Sexo <span class="sort-icon">â‡…</span></th>
                <th class="sortable" onclick="sortUsersTable(4, 'string')">Idade <span class="sort-icon">â‡…</span></th>
                <th class="sortable" onclick="sortUsersTable(5, 'string')">PaÃ­s <span class="sort-icon">â‡…</span></th>
                <th class="sortable" onclick="sortUsersTable(6, 'string')">Cidade <span class="sort-icon">â‡…</span></th>
                <th class="sortable" onclick="sortUsersTable(7, 'date')">Data Registo <span class="sort-icon">â‡…</span></th>
                <th class="sortable" onclick="sortUsersTable(8, 'date')">Ãšltimo Login <span class="sort-icon">â‡…</span></th>
                <th>AÃ§Ãµes</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- Users will be loaded here -->
            </tbody>
          </table>
          
          <!-- Controlos de PaginaÃ§Ã£o -->
          <div id="paginationControls">
            <!-- SerÃ¡ preenchido dinamicamente -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- TAB: PARTIAL REPORTS (Individual Pack Answers) -->
    <div id="tab-partialReports" class="tab-content">
      <div class="content-card">
        <h2>
          ğŸ“ Respostas Individuais
          <span style="font-size: 0.7em; color: #6c757d; font-weight: normal; margin-left: 15px;">
            Packs completados por utilizador
          </span>
        </h2>
        
        <div class="filters">          <div class="filter-group">
            <label for="filterPartialPack">ğŸ“¦ Pack</label>
            <select id="filterPartialPack" onchange="loadIndividualAnswers()">
              <option value="">Todos os Packs</option>
              <option value="romantico">ğŸ’• Pack RomÃ¢ntico</option>
              <option value="experiencia">ğŸŒ ExploraÃ§Ã£o e Aventura</option>
              <option value="pimentinha">ğŸŒ¶ï¸ Pimentinha</option>
              <option value="poliamor">ğŸ’œ Poliamor</option>
              <option value="kinks">ğŸ”¥ Fetiches</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterPartialGender">âš§ï¸ GÃ©nero</label>
            <select id="filterPartialGender" onchange="loadIndividualAnswers()">
              <option value="">Todos</option>
              <option value="M">â™‚ï¸ Masculino</option>
              <option value="F">â™€ï¸ Feminino</option>
              <option value="outro">âš§ï¸ Outro</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterPartialUser">ğŸ” Procurar utilizador</label>
            <input type="text" id="filterPartialUser" placeholder="Nome ou email..." 
                   oninput="loadIndividualAnswers()" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px;">
          </div>
          <div class="filter-group" style="display: flex; align-items: flex-end; gap: 10px;">
            <button class="btn-reset" onclick="resetPartialReportFilters()">ğŸ”„ Limpar</button>
          </div>
        </div>
        
        <div id="partialReportsStats" style="margin-bottom: 20px;">
          <!-- Stats will be loaded here -->
        </div>
        
        <div id="partialReportsContainer">
          <!-- Individual answers will be loaded here -->
        </div>
        
        <!-- Modal para ver respostas -->
        <div id="answersModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
          <div style="background: white; margin: 30px auto; max-width: 800px; border-radius: 16px; box-shadow: 0 10px 50px rgba(0,0,0,0.3);">
            <div id="answersModalContent">
              <!-- Modal content will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: FULL REPORTS -->
    <div id="tab-fullReports" class="tab-content">
      <div class="content-card">
        <h2>
          ğŸ“‹ RelatÃ³rios Completos
          <span style="font-size: 0.7em; color: #6c757d; font-weight: normal; margin-left: 15px;">
            (Nomes anonimizados para privacidade)
          </span>
        </h2>
        
        <div class="filters">          <div class="filter-group">
            <label for="filterReportPeriod">ğŸ“… PerÃ­odo</label>
            <select id="filterReportPeriod" onchange="loadFullReportsWithFilters()">
              <option value="">Todos</option>
              <option value="today">Hoje</option>
              <option value="week">Ãšltima Semana</option>
              <option value="month">Ãšltimo MÃªs</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterReportCompat">ğŸ¯ Compatibilidade</label>
            <select id="filterReportCompat" onchange="loadFullReportsWithFilters()">
              <option value="">Todas</option>
              <option value="high">Alta (â‰¥80%)</option>
              <option value="medium">MÃ©dia (60-79%)</option>
              <option value="low">Baixa (&lt;60%)</option>
            </select>
          </div>
          <div class="filter-group" style="display: flex; align-items: flex-end; gap: 10px;">
            <button class="btn-reset" onclick="resetFullReportFilters()">ğŸ”„ Limpar</button>
          </div>
        </div>
        
        <div id="fullReportsContainer">
          <!-- Reports will be loaded here by admin-analytics.js -->
        </div>
      </div>
    </div>

    <!-- TAB: QUESTION ANALYTICS -->
    <div id="tab-questions" class="tab-content">
      <div class="content-card">
        <h2>ğŸ“Š AnÃ¡lise de QuestÃµes</h2>
        
        <div class="filters">          <div class="filter-group">
            <label for="filterQuestionPack">ğŸ“¦ Pacote</label>
            <select id="filterQuestionPack" onchange="loadQuestionAnalyticsWithFilters()">
              <option value="">Todos os Pacotes</option>
              <option value="romantico">ğŸ’• Pack RomÃ¢ntico</option>
              <option value="experiencia">ğŸŒ ExploraÃ§Ã£o</option>
              <option value="pimentinha">ğŸŒ¶ï¸ Pimentinha</option>
              <option value="poliamor">ğŸ’œ Poliamor</option>
              <option value="kinks">ğŸ”¥ Fetiches</option>
            </select>
          </div>          <div class="filter-group">
            <label for="filterQuestionGender">âš§ï¸ GÃ©nero</label>
            <select id="filterQuestionGender" onchange="loadQuestionAnalyticsWithFilters()">
              <option value="">Todos</option>
              <option value="M">â™‚ï¸ Masculino</option>
              <option value="F">â™€ï¸ Feminino</option>
              <option value="outro">âš§ï¸ Outro</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterQuestionAge">ğŸ‚ Faixa EtÃ¡ria</label>
            <select id="filterQuestionAge" onchange="loadQuestionAnalyticsWithFilters()">
              <option value="">Todas as idades</option>
              <option value="18-25">18-25 anos</option>
              <option value="26-35">26-35 anos</option>
              <option value="36-45">36-45 anos</option>
              <option value="46-55">46-55 anos</option>
              <option value="56+">56+ anos</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterMinResponses">ğŸ”¢ MÃ­nimo Respostas</label>
            <input type="number" id="filterMinResponses" min="0" value="0" 
                   onchange="loadQuestionAnalyticsWithFilters()" 
                   placeholder="Filtrar por nÂº de respostas"
                   style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px;">          </div>

          <div class="filter-group" style="display: flex; align-items: flex-end; gap: 10px;">
            <button class="btn-reset" onclick="resetQuestionFilters()">ğŸ”„ Limpar Filtros</button>
            <button class="btn-primary" onclick="rebuildAnalyticsCache()" 
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                           color: white; border: none; padding: 8px 16px; border-radius: 6px; 
                           cursor: pointer;" 
                    title="ForÃ§ar reconstruÃ§Ã£o do cache de analytics">
              ğŸ”ƒ Reconstruir Cache
            </button>
            <button class="btn-primary" onclick="publishPublicStatistics()" 
                    style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
                           color: white; border: none; padding: 8px 16px; border-radius: 6px; 
                           cursor: pointer;" 
                    title="Publicar estatÃ­sticas para a pÃ¡gina pÃºblica (auto: 7h e 19h)">
              ğŸ“¤ Publicar EstatÃ­sticas
            </button>
          </div>
        </div>
        
        <div id="questionAnalyticsContainer">
          <!-- Question analytics will be loaded here by admin-analytics.js -->
        </div>
      </div>
    </div>

    <!-- TAB: ACTIVITY -->
    <div id="tab-activity" class="tab-content">
      <div class="content-card">
        <h2>
          ğŸ“ Log de Atividade
          <span style="font-size: 0.7em; color: #6c757d; font-weight: normal; margin-left: 15px;">
            Ãšltimas 100 atividades
          </span>
          <button class="btn-export" onclick="exportActivity()">
            ğŸ“¥ Exportar LOG
          </button>
        </h2>
        
        <!-- Stats Container -->
        <div id="activityStats" style="display: none; margin-bottom: 20px;">
          <!-- Will be populated by JS -->
        </div>
        
        <div class="filters">          <div class="filter-group">
            <label for="filterActivityType">ğŸ” Tipo de Atividade</label>
            <select id="filterActivityType" onchange="filterActivity()">
              <option value="">Todas</option>
              <option value="register">ğŸ†• Registos</option>
              <option value="login">ğŸ”“ Logins</option>
              <option value="answer">âœï¸ Respostas</option>
              <option value="report">ğŸ“Š RelatÃ³rios</option>
              <option value="connection">ğŸ’‘ ConexÃµes</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterActivityDate">ğŸ“… Data</label>
            <input type="date" id="filterActivityDate" onchange="filterActivity()" 
                   style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px;">
          </div>
          <div class="filter-group" style="display: flex; align-items: flex-end; gap: 10px;">
            <button class="btn-reset" onclick="resetActivityFilters()">ğŸ”„ Limpar</button>
          </div>
        </div>
        
        <div class="loading" id="loadingActivity">
          <div class="loading-spinner"></div>
          <p>A carregar atividades...</p>
        </div>
          <div id="activityLog" style="display: none;">
          <!-- Activity items will be loaded here -->
        </div>
      </div>
    </div>
    
  </div>

  <!-- Modal for Report Details -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ“‹ Detalhes do RelatÃ³rio</h2>
        <button class="modal-close" onclick="closeReportModal()">Ã—</button>
      </div>
      <div class="modal-body" id="reportModalBody">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <script src="../js/firebase-config.js"></script>
  <script src="../js/analytics.js"></script>
  <script src="../js/admin-analytics.js"></script>
  
  <script>
    // ===========================
    // ADMIN AUTHENTICATION
    // ===========================
    // âš ï¸ IMPORTANTE: A autenticaÃ§Ã£o Ã© feita exclusivamente via Firebase Auth
    // O utilizador deve ter isAdmin=true no Firestore para aceder ao backoffice
    // NÃƒO armazenar credenciais em cÃ³digo!
      // ===========================
    // GLOBAL VARIABLES
    // ===========================
    let allUsers = [];
    let allActivity = [];
    
    // ===========================
    // CACHE SYSTEM
    // ===========================
    let dataCache = {
      loaded: false,
      lastLoadTime: null,
      users: [],
      activity: []
    };
    
    function isDataCacheValid() {
      return dataCache.loaded && dataCache.lastLoadTime !== null;
    }
    
    function saveDataToCache(users, activity) {
      dataCache = {
        loaded: true,
        lastLoadTime: new Date(),
        users: users || [],
        activity: activity || []
      };
      console.log('ğŸ’¾ Dados guardados em cache:', {
        users: dataCache.users.length,
        activity: dataCache.activity.length,
        timestamp: dataCache.lastLoadTime
      });
    }
    
    function loadDataFromCache() {
      if (!isDataCacheValid()) {
        console.warn('âš ï¸ Cache nÃ£o disponÃ­vel ou invÃ¡lido');
        return false;
      }
      
      allUsers = [...dataCache.users];
      allActivity = [...dataCache.activity];
      
      console.log('ğŸ“¦ Dados carregados do cache:', {
        users: allUsers.length,
        activity: allActivity.length,
        cachedAt: dataCache.lastLoadTime
      });
      
      return true;
    }
    
    function clearDataCache() {
      dataCache = {
        loaded: false,
        lastLoadTime: null,
        users: [],
        activity: []
      };
      console.log('ğŸ—‘ï¸ Cache limpo');
    }
    
    // ===========================
    // TESTING FUNCTIONS
    // ===========================
    
    /**
     * ğŸ§ª FUNÃ‡ÃƒO DE TESTE: Simula carregamento automÃ¡tico
     * Para testar sem esperar pelas 7h/19h
     */
    function testAutoLoad() {
      console.log('ğŸ§ª ========================================');
      console.log('ğŸ§ª TESTE: Simulando carregamento automÃ¡tico');
      console.log('ğŸ§ª ========================================');
      
      // 1. Verificar estado do cache ANTES
      console.log('ğŸ“Š Cache ANTES do reload:', {
        loaded: dataCache.loaded,
        lastLoadTime: dataCache.lastLoadTime,
        usersCount: dataCache.users.length,
        activityCount: dataCache.activity.length
      });
      
      // 2. Simular carregamento automÃ¡tico (igual ao que acontece Ã s 7h/19h)
      console.log('â° Simulando carregamento automÃ¡tico...');
      manualReloadAllData().then(() => {
        // 3. Verificar estado do cache DEPOIS
        console.log('ğŸ“Š Cache DEPOIS do reload:', {
          loaded: dataCache.loaded,
          lastLoadTime: dataCache.lastLoadTime,
          usersCount: dataCache.users.length,
          activityCount: dataCache.activity.length
        });
        
        // 4. Testar se mudanÃ§a de tab nÃ£o recarrega
        console.log('ğŸ”„ Testando mudanÃ§a de tabs...');
        console.log('Tab atual: Dashboard');
        
        setTimeout(() => {
          console.log('ğŸ“‘ Simulando mudanÃ§a para tab Users...');
          console.log('âš¡ Se cache funcionar, NÃƒO deve recarregar do Firebase');
          // showTab irÃ¡ usar loadDataFromCache() em vez de recarregar
        }, 2000);
        
        console.log('âœ… Teste concluÃ­do! Verifique os logs acima.');
      });
    }
    
    /**
     * ğŸ§ª FUNÃ‡ÃƒO DE TESTE: ForÃ§a prÃ³ximo reload para daqui a 1 minuto
     * Ãštil para testar o sistema de agendamento
     */
    function testScheduledLoadIn1Minute() {
      console.log('ğŸ§ª ========================================');
      console.log('ğŸ§ª TESTE: Agendando reload para daqui a 1 minuto');
      console.log('ğŸ§ª ========================================');
      
      const now = new Date();
      const testTime = new Date(now.getTime() + 60000); // +1 minuto
      
      nextScheduledLoad = testTime;
      console.log('â° PrÃ³ximo reload forÃ§ado para:', testTime.toLocaleTimeString('pt-PT'));
      console.log('â³ Aguarde 1 minuto...');
      console.log('ğŸ“ O reload deve acontecer automaticamente e atualizar o cache');
      
      updateNextLoadTimeDisplay();
    }
    
    /**
     * ğŸ§ª FUNÃ‡ÃƒO DE TESTE: Verifica integridade do cache
     */
    function testCacheIntegrity() {
      console.log('ğŸ§ª ========================================');
      console.log('ğŸ§ª TESTE: Verificando integridade do cache');
      console.log('ğŸ§ª ========================================');
      
      const tests = {
        'Cache carregado': dataCache.loaded === true,
        'Timestamp vÃ¡lido': dataCache.lastLoadTime !== null,
        'Users em cache': dataCache.users.length > 0,
        'Users em memÃ³ria': allUsers.length > 0,
        'Cache = MemÃ³ria': dataCache.users.length === allUsers.length,
        'Activity em cache': dataCache.activity.length >= 0
      };
      
      console.table(tests);
      
      const allPassed = Object.values(tests).every(t => t === true);
      
      if (allPassed) {
        console.log('âœ… Todos os testes passaram! Cache Ã­ntegro.');
      } else {
        console.error('âŒ Alguns testes falharam! Verifique o cache.');
      }
      
      return allPassed;
    }
      // ===========================
    // EXPOR FUNÃ‡Ã•ES DE TESTE GLOBALMENTE
    // ===========================
    // Garantir que as funÃ§Ãµes estÃ£o disponÃ­veis no console do browser
    window.testAutoLoad = testAutoLoad;
    window.testScheduledLoadIn1Minute = testScheduledLoadIn1Minute;
    window.testCacheIntegrity = testCacheIntegrity;
    window.clearDataCache = clearDataCache;
    
    // Debug: Verificar se funÃ§Ãµes foram registradas
    console.log('ğŸ§ª ========================================');
    console.log('ğŸ§ª FUNÃ‡Ã•ES DE TESTE CARREGADAS');
    console.log('ğŸ§ª ========================================');
    console.log('âœ… testAutoLoad:', typeof window.testAutoLoad);
    console.log('âœ… testScheduledLoadIn1Minute:', typeof window.testScheduledLoadIn1Minute);
    console.log('âœ… testCacheIntegrity:', typeof window.testCacheIntegrity);
    console.log('âœ… clearDataCache:', typeof window.clearDataCache);
    console.log('');
    console.log('ğŸ“ Para executar, copie e cole no console:');
    console.log('  â€¢ testAutoLoad()');
    console.log('  â€¢ testScheduledLoadIn1Minute()');
    console.log('  â€¢ testCacheIntegrity()');
    console.log('  â€¢ clearDataCache()');
    console.log('ğŸ§ª ========================================');
    
    // FunÃ§Ã£o helper para listar funÃ§Ãµes disponÃ­veis
    window.listTestFunctions = function() {
      console.log('ğŸ§ª ========================================');
      console.log('ğŸ§ª FUNÃ‡Ã•ES DE TESTE DISPONÃVEIS');
      console.log('ğŸ§ª ========================================');
      console.log('');
      console.log('1ï¸âƒ£ testAutoLoad()');
      console.log('   â†’ Simula carregamento automÃ¡tico');
      console.log('   â†’ Mostra estado do cache antes e depois');
      console.log('');
      console.log('2ï¸âƒ£ testScheduledLoadIn1Minute()');
      console.log('   â†’ Agenda reload para daqui a 1 minuto');
      console.log('   â†’ Testa sistema de agendamento 7h/19h');
      console.log('');
      console.log('3ï¸âƒ£ testCacheIntegrity()');
      console.log('   â†’ Verifica integridade do cache');
      console.log('   â†’ Mostra tabela com todos os testes');
      console.log('');
      console.log('4ï¸âƒ£ clearDataCache()');
      console.log('   â†’ Limpa cache manualmente');
      console.log('   â†’ ForÃ§a reload do Firebase no prÃ³ximo acesso');
      console.log('');
      console.log('5ï¸âƒ£ listTestFunctions()');
      console.log('   â†’ Mostra esta lista novamente');
      console.log('');
      console.log('ğŸ§ª ========================================');
      console.log('ğŸ“‹ Status das funÃ§Ãµes:');
      console.log('   testAutoLoad:', typeof window.testAutoLoad === 'function' ? 'âœ…' : 'âŒ');
      console.log('   testScheduledLoadIn1Minute:', typeof window.testScheduledLoadIn1Minute === 'function' ? 'âœ…' : 'âŒ');
      console.log('   testCacheIntegrity:', typeof window.testCacheIntegrity === 'function' ? 'âœ…' : 'âŒ');
      console.log('   clearDataCache:', typeof window.clearDataCache === 'function' ? 'âœ…' : 'âŒ');
      console.log('ğŸ§ª ========================================');
    };
    
    // ===========================
    // LOGIN LOGIC
    // ===========================
    const loginContainer = document.getElementById('loginContainer');
    const adminDashboard = document.getElementById('adminDashboard');
    const errorMessage = document.getElementById('errorMessage');
    const adminLoginForm = document.getElementById('adminLoginForm');
      // Check if already logged in
    const isAdminLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';
    if (isAdminLoggedIn) {
      // Use setTimeout to allow async execution
      setTimeout(() => showDashboard(), 0);
    }    // Login form handler
    adminLoginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      console.log('ğŸ” Tentativa de login admin...');
      
      const username = document.getElementById('adminUsername').value.trim();
      const password = document.getElementById('adminPassword').value;
        console.log('ğŸ‘¤ Username/Email inserido:', username);
      
      // Construir email se necessÃ¡rio (permitir login com username ou email)
      const email = username.includes('@') ? username : `${username}@quest4couple.com`;
      
      console.log('ğŸ“§ Email para autenticaÃ§Ã£o:', email);
      
      try {
        console.log('ğŸ”‘ Autenticando com Firebase Auth...');
        
        // âœ… Login com Firebase Auth
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        console.log('âœ… Utilizador autenticado:', user.email);
        console.log('ğŸ” Verificando se Ã© admin...');
        
        // Verificar se Ã© admin no Firestore
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (userDoc.exists && userDoc.data().isAdmin === true) {
          console.log('âœ… Admin confirmado!');
          console.log('ğŸ‘¤ Admin data:', userDoc.data());
          
          sessionStorage.setItem('adminLoggedIn', 'true');
          sessionStorage.setItem('adminUsername', user.email);
          errorMessage.classList.remove('show');
          showDashboard();
        } else {
          console.error('âŒ Utilizador nÃ£o Ã© administrador');
          console.log('ğŸ“„ User data:', userDoc.exists ? userDoc.data() : 'Document nÃ£o existe');
          
          errorMessage.textContent = 'Acesso negado. NÃ£o Ã© administrador.';
          errorMessage.classList.add('show');
          
          await auth.signOut(); // Logout
          document.getElementById('adminPassword').value = '';
          setTimeout(() => {
            errorMessage.classList.remove('show');
            errorMessage.textContent = 'Credenciais invÃ¡lidas';
          }, 3000);
        }
      } catch (error) {
        console.error('âŒ Erro no login admin:', error);
        console.error('âŒ Error code:', error.code);
        console.error('âŒ Error message:', error.message);
        
        let errorMsg = 'Erro no login';
        
        switch(error.code) {
          case 'auth/user-not-found':
            errorMsg = 'Utilizador nÃ£o encontrado';
            break;
          case 'auth/wrong-password':
            errorMsg = 'Password incorreta';
            break;
          case 'auth/invalid-email':
            errorMsg = 'Email invÃ¡lido';
            break;
          case 'auth/too-many-requests':
            errorMsg = 'Demasiadas tentativas. Aguarde alguns minutos.';
            break;
          default:
            errorMsg = error.message;
        }
        
        errorMessage.textContent = errorMsg;
        errorMessage.classList.add('show');
        document.getElementById('adminPassword').value = '';
        setTimeout(() => {
          errorMessage.classList.remove('show');
          errorMessage.textContent = 'Credenciais invÃ¡lidas';
        }, 3000);
      }
    });
    
    // ===========================
    // DASHBOARD FUNCTIONS
    // ===========================
    function showDashboard() {
      console.log('ğŸ“Š A mostrar dashboard...');
      
      // Verificar se Firebase estÃ¡ disponÃ­vel
      if (typeof firebase === 'undefined') {
        console.error('âŒ Firebase nÃ£o estÃ¡ carregado!');
        alert('Erro: Firebase nÃ£o estÃ¡ disponÃ­vel. Por favor recarregue a pÃ¡gina.');
        return;
      }
      
      if (typeof db === 'undefined') {
        console.error('âŒ Firestore (db) nÃ£o estÃ¡ disponÃ­vel!');
        alert('Erro: Base de dados nÃ£o estÃ¡ disponÃ­vel. Por favor recarregue a pÃ¡gina.');
        return;
      }
      
      console.log('âœ… Firebase carregado:', firebase);
      console.log('âœ… Firestore disponÃ­vel:', db);
      
      loginContainer.style.display = 'none';
      adminDashboard.style.display = 'block';
      document.body.style.alignItems = 'flex-start';
        const adminName = sessionStorage.getItem('adminUsername') || ADMIN_USERNAME;
      document.getElementById('adminName').textContent = adminName;
      
      // Mostrar painel de status de carregamento
      document.getElementById('dataLoadingStatus').style.display = 'block';
      
      // Inicializar sistema de carregamento agendado
      initScheduledDataLoading();
      
      loadAllData();
    }
    
    // ===========================
    // SCHEDULED DATA LOADING
    // ===========================
    let scheduledLoadInterval = null;
    let nextScheduledLoad = null;
    
    function initScheduledDataLoading() {
      console.log('â° Inicializando carregamento agendado de dados...');
      
      // Calcular prÃ³ximo carregamento
      updateNextScheduledLoad();
      
      // Atualizar display a cada minuto
      if (scheduledLoadInterval) {
        clearInterval(scheduledLoadInterval);
      }
      
      scheduledLoadInterval = setInterval(() => {
        const now = new Date();
        
        // Verificar se chegou a hora de carregar
        if (nextScheduledLoad && now >= nextScheduledLoad) {
          console.log('â° Hora de carregar dados automaticamente!');
          manualReloadAllData();
          updateNextScheduledLoad();
        }
        
        // Atualizar display do prÃ³ximo carregamento
        updateNextLoadTimeDisplay();
      }, 60000); // Verificar a cada minuto
      
      // Atualizar display imediatamente
      updateNextLoadTimeDisplay();
    }
    
    function updateNextScheduledLoad() {
      const now = new Date();
      const scheduled = [7, 19]; // 7h00 e 19h00
      
      // Encontrar prÃ³xima hora de carregamento
      let nextHour = null;
      for (const hour of scheduled) {
        const scheduledTime = new Date(now);
        scheduledTime.setHours(hour, 0, 0, 0);
        
        if (scheduledTime > now) {
          nextHour = scheduledTime;
          break;
        }
      }
      
      // Se nÃ£o encontrou hoje, usar primeira hora de amanhÃ£
      if (!nextHour) {
        nextHour = new Date(now);
        nextHour.setDate(nextHour.getDate() + 1);
        nextHour.setHours(scheduled[0], 0, 0, 0);
      }
      
      nextScheduledLoad = nextHour;
      console.log('â° PrÃ³ximo carregamento agendado:', nextScheduledLoad.toLocaleString('pt-PT'));
    }
    
    function updateNextLoadTimeDisplay() {
      const nextLoadSpan = document.getElementById('nextLoadTime');
      if (!nextScheduledLoad || !nextLoadSpan) return;
      
      const now = new Date();
      const diff = nextScheduledLoad - now;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      
      if (hours > 0) {
        nextLoadSpan.textContent = `${nextScheduledLoad.getHours()}:00 (em ${hours}h ${minutes}m)`;
      } else {
        nextLoadSpan.textContent = `${nextScheduledLoad.getHours()}:00 (em ${minutes}m)`;
    }
    }
    
    function updateLastLoadTime() {
      const lastLoadSpan = document.getElementById('lastLoadTime');
      if (!lastLoadSpan) return;
      
      const now = new Date();
      const timeStr = now.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
      const dateStr = now.toLocaleDateString('pt-PT');
      lastLoadSpan.textContent = `Ãšltimo carregamento: ${dateStr} Ã s ${timeStr}`;
    }
    
    // ===========================
    // MANUAL DATA RELOAD
    // ===========================
    async function manualReloadAllData() {
      try {
        console.log('ğŸ”„ Recarregamento manual de todos os dados...');
        
        // ğŸ’¡ NÃƒO limpar cache - apenas atualizar com novos dados
        console.log('ğŸ“Š Cache serÃ¡ atualizado apÃ³s carregamento');
        
        // Mostrar barra de progresso
        const progressContainer = document.getElementById('loadingProgressContainer');
        const progressBar = document.getElementById('loadingProgressBar');
        const loadingStage = document.getElementById('loadingStage');
        const loadingPercentage = document.getElementById('loadingPercentage');
        
        if (progressContainer) {
          progressContainer.style.display = 'block';
        }
        
        // Etapa 1: Utilizadores (50%)
        if (loadingStage) loadingStage.textContent = 'ğŸ‘¥ A carregar utilizadores...';
        if (progressBar) progressBar.style.width = '10%';
        if (loadingPercentage) loadingPercentage.textContent = '10%';
        
        await loadUsersWithProgress();
        
        if (progressBar) progressBar.style.width = '50%';
        if (loadingPercentage) loadingPercentage.textContent = '50%';
        
        // Etapa 2: Dashboard Stats (70%)
        if (loadingStage) loadingStage.textContent = 'ğŸ“Š A atualizar estatÃ­sticas...';
        if (progressBar) progressBar.style.width = '70%';
        if (loadingPercentage) loadingPercentage.textContent = '70%';
        
        await updateDashboardStats();
        loadUsersTable();
        
        // Etapa 3: Atividade (85%)
        if (loadingStage) loadingStage.textContent = 'ğŸ“œ A carregar atividades...';
        if (progressBar) progressBar.style.width = '85%';
        if (loadingPercentage) loadingPercentage.textContent = '85%';
        
        await checkUsersWithoutUsername();
        await loadActivityLog();
        
        // ConcluÃ­do (100%)
        if (loadingStage) loadingStage.textContent = 'âœ… Carregamento concluÃ­do!';
        if (progressBar) progressBar.style.width = '100%';
        if (loadingPercentage) loadingPercentage.textContent = '100%';
        
        // ğŸ’¾ Guardar dados em cache
        saveDataToCache(allUsers, allActivity);
        
        // Atualizar timestamp
        updateLastLoadTime();
        
        // Esconder barra apÃ³s 2 segundos
        setTimeout(() => {
          if (progressContainer) {
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
          }
        }, 2000);
        
        console.log('âœ… Recarregamento manual concluÃ­do e guardado em cache!');
        
      } catch (error) {
        console.error('âŒ Erro no recarregamento manual:', error);
        alert('Erro ao recarregar dados. Verifique a consola para detalhes.');
        
        // Esconder barra em caso de erro
        const progressContainer = document.getElementById('loadingProgressContainer');
        if (progressContainer) {
          progressContainer.style.display = 'none';
        }
      }
    }
    
    async function loadUsersWithProgress() {
      console.log('ğŸ‘¥ A buscar utilizadores com progresso...');
      const usersSnapshot = await db.collection('users').get();
      console.log('âœ… Snapshot recebido:', usersSnapshot.size, 'utilizadores');
      
      allUsers = [];
      usersSnapshot.forEach(doc => {
        allUsers.push({ id: doc.id, ...doc.data() });
      });
      
      console.log('âœ… Utilizadores carregados:', allUsers.length);
      
      // Ordenar por data de registo (mais recentes primeiro)
      allUsers.sort((a, b) => {
        const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
        const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
        return dateB - dateA;
      });
    }
      function logout() {
      sessionStorage.removeItem('adminLoggedIn');
      sessionStorage.removeItem('adminUsername');
      window.location.reload();
    }
    
    // FunÃ§Ã£o para forÃ§ar reconstruÃ§Ã£o do cache de analytics
    function rebuildAnalyticsCache() {
      console.log('ğŸ”„ ForÃ§ando reconstruÃ§Ã£o do cache de analytics...');
      
      // Limpar cache existente (estÃ¡ em admin-analytics.js)
      if (typeof window.questionAnalyticsCache !== 'undefined') {
        window.questionAnalyticsCache = null;
      }
      
      // Recarregar analytics
      loadQuestionAnalyticsWithFilters();
      
      console.log('âœ… Cache serÃ¡ reconstruÃ­do na prÃ³xima consulta');
    }
    
    // ===========================
    // TAB NAVIGATION
    // ===========================
    function showTab(tabName) {
      console.log(`ğŸ“‘ Mudando para tab: ${tabName}`);
      
      // Esconder todos os tabs
      const allTabs = document.querySelectorAll('.tab-content');
      allTabs.forEach(tab => tab.classList.remove('active'));
      
      // Remover active de todos os botÃµes
      const allBtns = document.querySelectorAll('.tab-btn');
      allBtns.forEach(btn => btn.classList.remove('active'));
      
      // Mostrar tab selecionado
      const selectedTab = document.getElementById(`tab-${tabName}`);
      if (selectedTab) {
        selectedTab.classList.add('active');
      }
      
      // Marcar botÃ£o como active
      event.target.classList.add('active');
      
      // Carregar dados especÃ­ficos do tab se necessÃ¡rio
      // Usar cache quando disponÃ­vel
      if (isDataCacheValid()) {
        console.log('ğŸ“¦ Usando dados do cache para tab:', tabName);
        
        switch(tabName) {
          case 'dashboard':
            // Dashboard jÃ¡ estÃ¡ carregado
            break;
            
          case 'users':
            // Users jÃ¡ estÃ£o carregados, apenas renderizar se necessÃ¡rio
            if (filteredUsers.length === 0) {
              filteredUsers = [...allUsers];
              renderUsersPage();
            }
            break;
            
          case 'partialReports':
            loadIndividualAnswers();
            break;
            
          case 'fullReports':
            loadFullReportsWithFilters();
            break;
            
          case 'questions':
            loadQuestionAnalyticsWithFilters();
            break;
            
          case 'activity':
            // Re-renderizar activity log do cache
            renderActivityLog();
            break;
        }
      } else {
        console.warn('âš ï¸ Cache nÃ£o disponÃ­vel, pode ser necessÃ¡rio recarregar dados');
        
        // Se nÃ£o hÃ¡ cache, carregar dados conforme necessÃ¡rio
        switch(tabName) {
          case 'partialReports':
            loadIndividualAnswers();
            break;
            
          case 'fullReports':
            loadFullReportsWithFilters();
            break;
            
          case 'questions':
            loadQuestionAnalyticsWithFilters();
            break;
            
          case 'activity':
            loadActivityLog();
            break;
        }
      }
    }
    
    // ===========================
    // RESPOSTAS INDIVIDUAIS
    // ===========================
    let allUserAnswers = []; // Cache de respostas individuais
    let packQuestionsData = null; // Cache dos dados das perguntas
    
    async function loadIndividualAnswers() {
      const container = document.getElementById('partialReportsContainer');
      const statsContainer = document.getElementById('partialReportsStats');
      const packFilter = document.getElementById('filterPartialPack')?.value || '';
      const genderFilter = document.getElementById('filterPartialGender')?.value || '';
      const userFilter = (document.getElementById('filterPartialUser')?.value || '').toLowerCase().trim();
      
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #6c757d;">
          <div style="font-size: 2em; margin-bottom: 10px;">â³</div>
          <p>A carregar respostas individuais...</p>
        </div>
      `;
      
      try {
        // Carregar dados dos packs se ainda nÃ£o carregou
        if (!packQuestionsData) {
          const response = await fetch('../data/packs_data_clean.json');
          packQuestionsData = await response.json();
        }
        
        // Recolher respostas de todos os utilizadores
        if (allUserAnswers.length === 0) {
          console.log('ğŸ“¥ A carregar respostas de todos os utilizadores...');
          
          for (const user of allUsers) {
            try {
              const answersDoc = await db.collection('users').doc(user.id).collection('answers').doc('all').get();
              if (answersDoc.exists) {
                const answersData = answersDoc.data() || {};
                const packs = Object.keys(answersData);
                
                for (const packId of packs) {
                  const packAnswers = answersData[packId] || {};
                  const answerCount = Object.keys(packAnswers).length;
                  
                  if (answerCount > 0) {
                    const commentsCount = Object.values(packAnswers).filter(ans => ans.comment && ans.comment.trim()).length;
                    
                    allUserAnswers.push({
                      oderId: user.id,
                      userName: user.name || user.displayName || user.username || user.email?.split('@')[0] || 'Sem nome',
                      userEmail: user.email || '-',
                      userGender: user.gender || null,
                      packId: packId,
                      answerCount: answerCount,
                      commentsCount: commentsCount,
                      answers: packAnswers,
                      lastUpdated: packAnswers[Object.keys(packAnswers).pop()]?.timestamp || null
                    });
                  }
                }
              }
            } catch (e) {
              // Ignorar erros de permissÃ£o
            }
          }
          
          allUserAnswers.sort((a, b) => {
            if (a.lastUpdated && b.lastUpdated) {
              const dateA = a.lastUpdated?.toDate ? a.lastUpdated.toDate() : new Date(a.lastUpdated);
              const dateB = b.lastUpdated?.toDate ? b.lastUpdated.toDate() : new Date(b.lastUpdated);
              return dateB - dateA;
            }
            return a.userName.localeCompare(b.userName);
          });
          
          console.log(`âœ… ${allUserAnswers.length} packs individuais encontrados`);
        }
        
        // Aplicar filtros
        let filtered = [...allUserAnswers];
        
        if (packFilter) {
          filtered = filtered.filter(item => item.packId === packFilter);
        }
        
        if (genderFilter) {
          if (genderFilter === 'outro') {
            filtered = filtered.filter(item => item.userGender && item.userGender !== 'M' && item.userGender !== 'F');
          } else {
            filtered = filtered.filter(item => item.userGender === genderFilter);
          }
        }
        
        if (userFilter) {
          filtered = filtered.filter(item => 
            item.userName.toLowerCase().includes(userFilter) ||
            item.userEmail.toLowerCase().includes(userFilter)
          );
        }
        
        // EstatÃ­sticas
        const packStats = {};
        let totalAnswers = 0;
        let totalComments = 0;
        
        allUserAnswers.forEach(item => {
          packStats[item.packId] = (packStats[item.packId] || 0) + 1;
          totalAnswers += item.answerCount;
          totalComments += item.commentsCount || 0;
        });
        
        const packInfo = {
          'romantico': { icon: 'ğŸ’•', name: 'RomÃ¢ntico', color: '#e91e63' },
          'experiencia': { icon: 'ğŸŒ', name: 'ExploraÃ§Ã£o', color: '#ff9800' },
          'pimentinha': { icon: 'ğŸŒ¶ï¸', name: 'Pimentinha', color: '#f44336' },
          'poliamor': { icon: 'ğŸ’œ', name: 'Poliamor', color: '#9c27b0' },
          'kinks': { icon: 'ğŸ”¥', name: 'Fetiches', color: '#673ab7' }
        };
        
        if (statsContainer) {
          statsContainer.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px;">
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 12px; text-align: center; color: white;">
                <div style="font-size: 1.8em; font-weight: 700;">${allUserAnswers.length}</div>
                <div style="font-size: 0.8em; opacity: 0.9;">Packs Preenchidos</div>
              </div>
              <div style="background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="font-size: 1.8em; font-weight: 700; color: #28a745;">${totalAnswers.toLocaleString('pt-PT')}</div>
                <div style="font-size: 0.8em; color: #6c757d;">Total Respostas</div>
              </div>
              <div style="background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 3px solid #ffc107;">
                <div style="font-size: 1.8em; font-weight: 700; color: #856404;">${totalComments.toLocaleString('pt-PT')}</div>
                <div style="font-size: 0.8em; color: #6c757d;">ğŸ’¬ ComentÃ¡rios</div>
              </div>
              ${Object.keys(packStats).map(pid => {
                const info = packInfo[pid] || { icon: 'ğŸ“‹', name: pid, color: '#6c757d' };
                return `
                  <div style="background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 3px solid ${info.color};">
                    <div style="font-size: 1.5em; font-weight: 700; color: ${info.color};">${packStats[pid]}</div>
                    <div style="font-size: 0.75em; color: #6c757d;">${info.icon} ${info.name}</div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
        
        // Renderizar lista
        if (filtered.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #6c757d;">
              <div style="font-size: 3em; margin-bottom: 15px;">ğŸ”</div>
              <h3>Nenhum resultado encontrado</h3>
              <p>Tente ajustar os filtros.</p>
            </div>
          `;
          return;
        }
        
        let html = `<div style="display: grid; gap: 12px;">`;
        
        filtered.forEach((item, idx) => {
          const info = packInfo[item.packId] || { icon: 'ğŸ“‹', name: item.packId, color: '#6c757d' };
          const maskedEmail = maskEmail(item.userEmail);
          const genderIcon = item.userGender === 'M' ? 'â™‚ï¸' : item.userGender === 'F' ? 'â™€ï¸' : item.userGender ? 'âš§ï¸' : '';
          
          html += `
            <div class="answer-card" style="background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; cursor: pointer; border-left: 4px solid ${info.color};"
                 onclick="showUserPackAnswers('${item.oderId}', '${item.packId}')"
                 onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.12)';"
                 onmouseout="this.style.transform='none'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)';">
              <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 45px; height: 45px; background: linear-gradient(135deg, ${info.color}22, ${info.color}44); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.4em;">
                  ${info.icon}
                </div>
                <div>
                  <div style="font-weight: 600; color: #333; margin-bottom: 3px;">${genderIcon} ${item.userName}</div>
                  <div style="font-size: 0.85em; color: #6c757d;" title="${item.userEmail}">${maskedEmail}</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 20px;">
                <div style="text-align: right;">
                  <div style="font-size: 0.85em; color: ${info.color}; font-weight: 600;">${info.name}</div>
                  <div style="font-size: 0.8em; color: #6c757d;">
                    ${item.answerCount} respostas
                    ${item.commentsCount > 0 ? `<span style="margin-left: 8px; background: #ffc107; color: #333; padding: 2px 6px; border-radius: 8px; font-size: 0.85em; font-weight: 600;">ğŸ’¬ ${item.commentsCount}</span>` : ''}
                  </div>
                </div>
                <div style="color: #667eea; font-size: 1.2em;">â–¶</div>
              </div>
            </div>
          `;
        });
        
        html += `</div>`;
        container.innerHTML = html;
        
      } catch (error) {
        console.error('âŒ Erro ao carregar respostas individuais:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #dc3545;">
            <div style="font-size: 2em; margin-bottom: 10px;">âŒ</div>
            <p>Erro ao carregar dados: ${error.message}</p>
          </div>
        `;
      }
    }
    
    async function showUserPackAnswers(userId, packId) {
      const modal = document.getElementById('answersModal');
      const content = document.getElementById('answersModalContent');
      
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      content.innerHTML = `
        <div style="padding: 40px; text-align: center;">
          <div style="font-size: 2em; margin-bottom: 10px;">â³</div>
          <p>A carregar respostas...</p>
        </div>
      `;
      
      try {
        const userDoc = await db.collection('users').doc(userId).get();
        const userData = userDoc.exists ? userDoc.data() : {};
        const userName = userData.name || userData.displayName || userData.username || userData.email?.split('@')[0] || 'Utilizador';
        
        const answersDoc = await db.collection('users').doc(userId).collection('answers').doc('all').get();
        const allAnswers = answersDoc.exists ? answersDoc.data() : {};
        const packAnswers = allAnswers[packId] || {};
        
        const packInfoMap = {
          'romantico': { icon: 'ğŸ’•', name: 'Pack RomÃ¢ntico', color: '#e91e63', colorKey: 'romantico' },
          'experiencia': { icon: 'ğŸŒ', name: 'ExploraÃ§Ã£o e Aventura', color: '#ff9800', colorKey: 'experiencia' },
          'pimentinha': { icon: 'ğŸŒ¶ï¸', name: 'Pimentinha', color: '#f44336', colorKey: 'pimentinha' },
          'poliamor': { icon: 'ğŸ’œ', name: 'Poliamor', color: '#9c27b0', colorKey: 'poliamor' },
          'kinks': { icon: 'ğŸ”¥', name: 'Fetiches', color: '#673ab7', colorKey: 'kinks' }
        };
        
        const info = packInfoMap[packId] || { icon: 'ğŸ“‹', name: packId, color: '#667eea', colorKey: packId };
        const packData = packQuestionsData?.find(p => p.color === info.colorKey);
        const allQuestions = packData?.categories?.flatMap(cat => cat.questions) || [];
        
        const sortedAnswers = Object.entries(packAnswers).sort((a, b) => {
          const numA = parseInt(a[0].replace('q', ''));
          const numB = parseInt(b[0].replace('q', ''));
          return numA - numB;
        });
        
        const answerCounts = { porfavor: 0, yup: 0, talvez: 0, meh: 0 };
        sortedAnswers.forEach(([key, val]) => {
          const ans = val.answer;
          if (answerCounts[ans] !== undefined) answerCounts[ans]++;
        });
        
        const answerLabels = {
          porfavor: { label: 'Por favor! ğŸ¤©', color: '#28a745', bg: '#d4edda' },
          yup: { label: 'Sim! ğŸ˜Š', color: '#17a2b8', bg: '#d1ecf1' },
          talvez: { label: 'Talvez ğŸ¤”', color: '#ffc107', bg: '#fff3cd' },
          meh: { label: 'NÃ£o, obrigado ğŸ˜…', color: '#dc3545', bg: '#f8d7da' }
        };
        
        let html = `
          <div style="padding: 25px; border-bottom: 1px solid #eee; background: linear-gradient(135deg, ${info.color}15, ${info.color}05);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h2 style="margin: 0 0 8px 0; color: #333;">${info.icon} ${info.name}</h2>
                <p style="margin: 0; color: #6c757d;"><strong>${userName}</strong> â€¢ ${sortedAnswers.length} respostas</p>
              </div>
              <button onclick="closeAnswersModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #6c757d; padding: 5px;">âœ•</button>
            </div>
          </div>
          
          <div style="padding: 20px; background: #f8f9fa;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
              ${Object.entries(answerCounts).map(([key, count]) => {
                const labelInfo = answerLabels[key];
                return `
                  <div style="background: ${labelInfo.bg}; padding: 12px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.3em; font-weight: 700; color: ${labelInfo.color};">${count}</div>
                    <div style="font-size: 0.75em; color: ${labelInfo.color};">${labelInfo.label}</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
          
          <div style="padding: 20px; max-height: 400px; overflow-y: auto;">
        `;
        
        const commentsCount = sortedAnswers.filter(([key, val]) => val.comment && val.comment.trim()).length;
        
        if (commentsCount > 0) {
          html += `
            <div style="background: #e8f4fd; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 1.2em;">ğŸ’¬</span>
              <span style="color: #1976d2; font-weight: 500;">${commentsCount} resposta${commentsCount > 1 ? 's' : ''} com comentÃ¡rio</span>
            </div>
          `;
        }
        
        sortedAnswers.forEach(([qKey, answerData], idx) => {
          const qIndex = parseInt(qKey.replace('q', '')) - 1;
          const questionText = allQuestions[qIndex] || `Pergunta ${qIndex + 1}`;
          const answer = answerData.answer;
          const comment = answerData.comment?.trim() || '';
          const labelInfo = answerLabels[answer] || { label: answer, color: '#6c757d', bg: '#f8f9fa' };
          
          html += `
            <div style="padding: 12px 15px; margin-bottom: 10px; background: white; border-radius: 10px; border-left: 3px solid ${labelInfo.color}; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                <div style="flex: 1;">
                  <span style="color: #999; font-size: 0.8em; margin-right: 8px;">#${qIndex + 1}</span>
                  <span style="color: #333;">${questionText}</span>
                </div>
                <span style="background: ${labelInfo.bg}; color: ${labelInfo.color}; padding: 4px 10px; border-radius: 15px; font-size: 0.8em; font-weight: 600; white-space: nowrap;">
                  ${labelInfo.label}
                </span>
              </div>
              ${comment ? `
                <div style="margin-top: 10px; padding: 10px 12px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #667eea;">
                  <div style="display: flex; align-items: flex-start; gap: 8px;">
                    <span style="color: #667eea; font-size: 1em;">ğŸ’¬</span>
                    <div style="flex: 1;">
                      <div style="font-size: 0.75em; color: #667eea; font-weight: 600; margin-bottom: 4px;">ComentÃ¡rio:</div>
                      <div style="color: #495057; font-size: 0.9em; font-style: italic; line-height: 1.4;">"${comment}"</div>
                    </div>
                  </div>
                </div>
              ` : ''}
            </div>
          `;
        });
        
        html += `
          </div>
          <div style="padding: 20px; border-top: 1px solid #eee; text-align: center;">
            <button onclick="closeAnswersModal()" style="padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
              Fechar
            </button>
          </div>
        `;
        
        content.innerHTML = html;
        
      } catch (error) {
        console.error('âŒ Erro ao carregar respostas:', error);
        content.innerHTML = `
          <div style="padding: 40px; text-align: center;">
            <div style="font-size: 2em; margin-bottom: 10px;">âŒ</div>
            <p style="color: #dc3545;">Erro ao carregar respostas: ${error.message}</p>
            <button onclick="closeAnswersModal()" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">Fechar</button>
          </div>
        `;
      }
    }
    
    function closeAnswersModal() {
      document.getElementById('answersModal').style.display = 'none';
      document.body.style.overflow = '';
    }
    
    function resetPartialReportFilters() {
      document.getElementById('filterPartialPack').value = '';
      document.getElementById('filterPartialGender').value = '';
      document.getElementById('filterPartialUser').value = '';
      loadIndividualAnswers();
    }
    
    // Fechar modal ao clicar fora
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('answersModal');
      if (e.target === modal) {
        closeAnswersModal();
      }
    });
    
    // Fechar modal com ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('answersModal');
        if (modal && modal.style.display !== 'none') {
          closeAnswersModal();
        }
      }
    });
    
    // FunÃ§Ã£o para re-renderizar activity log do cache sem recarregar
    function renderActivityLog() {
      if (!allActivity || allActivity.length === 0) {
        console.warn('âš ï¸ Nenhuma atividade em cache');
        loadActivityLog();
        return;
      }
      
      console.log('ğŸ“¦ Re-renderizando activity log do cache:', allActivity.length, 'atividades');
      
      const loadingActivity = document.getElementById('loadingActivity');
      const activityLog = document.getElementById('activityLog');
      
      if (loadingActivity) loadingActivity.style.display = 'none';
      if (activityLog) {
        activityLog.style.display = 'block';
        
        // Re-renderizar itens (usar mesma lÃ³gica do loadActivityLog)
        activityLog.innerHTML = '';
        allActivity.slice(0, 100).forEach(activity => {
          const item = createActivityItem(activity);
          activityLog.appendChild(item);
        });
      }
    }
    
    // ===========================
    // LOAD DATA
    // ===========================
    async function loadAllData() {
      try {
        console.log('ğŸ”„ A carregar dados do Firebase...');
        console.log('ğŸ“¦ Firestore instance:', db);
        
        // Mostrar barra de progresso
        const progressContainer = document.getElementById('loadingProgressContainer');
        const progressBar = document.getElementById('loadingProgressBar');
        const loadingStage = document.getElementById('loadingStage');
        const loadingPercentage = document.getElementById('loadingPercentage');
        
        if (progressContainer) {
          progressContainer.style.display = 'block';
        }
        
        // Etapa 1: Carregar utilizadores (0-50%)
        if (loadingStage) loadingStage.textContent = 'ğŸ‘¥ A carregar utilizadores...';
        if (progressBar) progressBar.style.width = '10%';
        if (loadingPercentage) loadingPercentage.textContent = '10%';
        
        console.log('ğŸ‘¥ A buscar utilizadores...');
        const usersSnapshot = await db.collection('users').get();
        console.log('âœ… Snapshot recebido:', usersSnapshot.size, 'utilizadores');
        
        if (progressBar) progressBar.style.width = '30%';
        if (loadingPercentage) loadingPercentage.textContent = '30%';
        
        allUsers = [];
        usersSnapshot.forEach(doc => {
          allUsers.push({ id: doc.id, ...doc.data() });
        });
        console.log('âœ… Utilizadores carregados:', allUsers.length);
        
        if (progressBar) progressBar.style.width = '50%';
        if (loadingPercentage) loadingPercentage.textContent = '50%';
        
        // Ordenar por data de registo (mais recentes primeiro)
        allUsers.sort((a, b) => {
          const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
          const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
          return dateB - dateA; // Descendente (mais recentes primeiro)
        });
        
        // Etapa 2: Dashboard Stats (50-70%)
        if (loadingStage) loadingStage.textContent = 'ğŸ“Š A atualizar estatÃ­sticas...';
        if (progressBar) progressBar.style.width = '60%';
        if (loadingPercentage) loadingPercentage.textContent = '60%';
        
        await updateDashboardStats();
        
        if (progressBar) progressBar.style.width = '70%';
        if (loadingPercentage) loadingPercentage.textContent = '70%';
        
        // Etapa 3: Tabela de utilizadores (70-80%)
        if (loadingStage) loadingStage.textContent = 'ğŸ“‹ A renderizar tabela...';
        if (progressBar) progressBar.style.width = '75%';
        if (loadingPercentage) loadingPercentage.textContent = '75%';
        
        loadUsersTable();
        
        if (progressBar) progressBar.style.width = '80%';
        if (loadingPercentage) loadingPercentage.textContent = '80%';
        
        // Etapa 4: VerificaÃ§Ãµes e logs (80-100%)
        if (loadingStage) loadingStage.textContent = 'ğŸ” A verificar dados...';
        if (progressBar) progressBar.style.width = '90%';
        if (loadingPercentage) loadingPercentage.textContent = '90%';
          await checkUsersWithoutUsername();
        loadActivityLog();
        
        // ConcluÃ­do
        if (loadingStage) loadingStage.textContent = 'âœ… Carregamento concluÃ­do!';
        if (progressBar) progressBar.style.width = '100%';
        if (loadingPercentage) loadingPercentage.textContent = '100%';
        
        // ğŸ’¾ Guardar dados em cache
        saveDataToCache(allUsers, allActivity);
        
        // Atualizar timestamp
        updateLastLoadTime();
        
        // Esconder barra apÃ³s 2 segundos
        setTimeout(() => {
          if (progressContainer) {
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
          }
        }, 2000);
        
      } catch (error) {
        console.error('âŒ ERRO CRÃTICO ao carregar dados:', error);
        console.error('ğŸ“‹ Stack trace:', error.stack);
        
        // Esconder barra de progresso
        const progressContainer = document.getElementById('loadingProgressContainer');
        if (progressContainer) {
          progressContainer.style.display = 'none';
        }
        
        // Mostrar erro detalhado
        const errorDetails = `
âŒ ERRO AO CARREGAR DADOS DO ADMIN

Tipo: ${error.name}
Mensagem: ${error.message}

Por favor:
1. Verifique a consola do browser (F12)
2. Verifique se o Firebase estÃ¡ configurado
3. Verifique a conexÃ£o Ã  internet

Detalhes tÃ©cnicos:
${error.stack || 'Sem stack trace'}
        `;
        
        alert(errorDetails);
        
        // Fazer logout para evitar problemas
        logout();
      }
    }
    
    // ===========================
    // DASHBOARD STATS
    // ===========================
    async function updateDashboardStats() {
      // Total users
      document.getElementById('totalUsers').textContent = allUsers.length;
      
      // New users today
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const newToday = allUsers.filter(user => {
        const createdAt = user.createdAt?.toDate();
        return createdAt && createdAt >= today;
      }).length;
      document.getElementById('newUsersToday').textContent = newToday;
        // Gender stats
      const maleCount = allUsers.filter(u => u.gender === 'M').length;
      const femaleCount = allUsers.filter(u => u.gender === 'F').length;
      // "Outro" pode ser guardado como 'outro', 'O', 'other', etc.
      const otherCount = allUsers.filter(u => u.gender && u.gender !== 'M' && u.gender !== 'F').length;
      const undefinedCount = allUsers.filter(u => !u.gender).length;
      
      console.log('ğŸ“Š GÃ©neros:', { M: maleCount, F: femaleCount, Outro: otherCount, 'NÃ£o definido': undefinedCount });
      console.log('ğŸ“Š Valores Ãºnicos de gender:', [...new Set(allUsers.map(u => u.gender))]);
      
      document.getElementById('maleUsers').textContent = maleCount;
      document.getElementById('femaleUsers').textContent = femaleCount;
      document.getElementById('otherUsers').textContent = otherCount + undefinedCount; // Junta Outro + NÃ£o definido
      
      // Countries
      const countries = new Set(allUsers.filter(u => u.country).map(u => u.country));
      document.getElementById('totalCountries').textContent = countries.size;
      
      // Buscar dados reais do Firestore
      try {
        const db = firebase.firestore();
        
        // === CONEXÃ•ES ATIVAS (casais) ===
        const connectionsSnapshot = await db.collection('connections').get();
        document.getElementById('activeCouples').textContent = connectionsSnapshot.size;
        
        // === RELATÃ“RIOS ===
        const reportsSnapshot = await db.collection('analytics_full_reports').get();
        const totalReports = reportsSnapshot.size;
        document.getElementById('totalReports').textContent = totalReports;
        
        // RelatÃ³rios hoje e esta semana
        const now = new Date();
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekStart = new Date(todayStart);
        weekStart.setDate(weekStart.getDate() - 7);
        
        let reportsToday = 0;
        let reportsWeek = 0;
        
        reportsSnapshot.forEach(doc => {
          const data = doc.data();
          const timestamp = data.timestamp?.toDate();
          if (timestamp) {
            if (timestamp >= todayStart) reportsToday++;
            if (timestamp >= weekStart) reportsWeek++;
          }
        });
        
        document.getElementById('reportsToday').textContent = reportsToday;
        document.getElementById('reportsWeek').textContent = reportsWeek;
        
        // MÃ©dia de relatÃ³rios por casal
        const avgReports = connectionsSnapshot.size > 0 
          ? (totalReports / connectionsSnapshot.size).toFixed(1) 
          : '0';
        document.getElementById('reportsAvg').textContent = avgReports;
        
        // === TOTAL DE RESPOSTAS ===
        // Contar todas as respostas de todos os utilizadores
        let totalAnswers = 0;
        let usersWithAnswers = 0;
        
        console.log('ğŸ“Š A contar respostas de', allUsers.length, 'utilizadores...');
        
        for (const user of allUsers) {
          try {
            const answersDoc = await db.collection('users').doc(user.id).collection('answers').doc('all').get();
            if (answersDoc.exists) {
              const answersData = answersDoc.data() || {};
              let userTotal = 0;
              // Contar respostas em cada pack
              Object.values(answersData).forEach(packAnswers => {
                if (packAnswers && typeof packAnswers === 'object') {
                  userTotal += Object.keys(packAnswers).length;
                }
              });
              if (userTotal > 0) {
                totalAnswers += userTotal;
                usersWithAnswers++;
              }
            }
          } catch (e) {
            // Ignorar erros de permissÃ£o em utilizadores individuais
          }
        }
        
        console.log(`âœ… Total de respostas: ${totalAnswers} de ${usersWithAnswers} utilizadores com respostas`);
        
        document.getElementById('totalAnswers').textContent = totalAnswers.toLocaleString('pt-PT');
        
      } catch (error) {
        console.error('âŒ Erro ao carregar estatÃ­sticas:', error);
        // Mostrar valores de fallback
        document.getElementById('activeCouples').textContent = '-';
        document.getElementById('totalReports').textContent = '-';
        document.getElementById('reportsToday').textContent = '-';
        document.getElementById('reportsWeek').textContent = '-';
        document.getElementById('reportsAvg').textContent = '-';
        document.getElementById('totalAnswers').textContent = '-';
      }
    }
    
    // ===========================
    // USERS TABLE - Com PaginaÃ§Ã£o
    // ===========================
    let currentPage = 1;
    const usersPerPage = 20;
    let filteredUsers = [];
    
    // FunÃ§Ã£o para mascarar email parcialmente
    function maskEmail(email) {
      if (!email || email === '-') return '-';
      
      const parts = email.split('@');
      if (parts.length !== 2) return email;
      
      const [localPart, domain] = parts;
      
      // Mascarar parte local do email
      let maskedLocal;
      if (localPart.length <= 2) {
        maskedLocal = localPart[0] + '*';
      } else if (localPart.length <= 4) {
        maskedLocal = localPart[0] + '**' + localPart.slice(-1);
      } else {
        // Mostrar primeiros 2 caracteres e Ãºltimo, mascarar o resto
        const visibleStart = localPart.slice(0, 2);
        const visibleEnd = localPart.slice(-1);
        const maskedLength = Math.min(localPart.length - 3, 5);
        maskedLocal = visibleStart + '*'.repeat(maskedLength) + visibleEnd;
      }
      
      // Mascarar domÃ­nio parcialmente
      const domainParts = domain.split('.');
      let maskedDomain;
      if (domainParts.length >= 2) {
        const domainName = domainParts[0];
        const extension = domainParts.slice(1).join('.');
        if (domainName.length <= 3) {
          maskedDomain = domainName[0] + '*' + '.' + extension;
        } else {
          maskedDomain = domainName[0] + '**' + domainName.slice(-1) + '.' + extension;
        }
      } else {
        maskedDomain = domain;
      }
        return maskedLocal + '@' + maskedDomain;
    }
    
    // Mascarar nome (manter primeiro nome completo, mascarar segundos nomes)
    function maskName(fullName) {
      if (!fullName || typeof fullName !== 'string') return fullName;
      
      const nameParts = fullName.trim().split(/\s+/); // Split por espaÃ§os
      
      if (nameParts.length === 1) {
        // SÃ³ tem um nome - retornar completo
        return nameParts[0];
      }
      
      // Manter primeiro nome completo, mascarar os restantes
      const firstName = nameParts[0];
      const maskedLastNames = nameParts.slice(1).map(name => {
        if (name.length === 0) return '';
        if (name.length === 1) return name[0] + '.';
        // Mostrar primeira letra + asteriscos
        return name[0] + '*'.repeat(Math.min(name.length - 1, 4)) + '.';
      });
      
      return firstName + ' ' + maskedLastNames.join(' ');
    }
    
    function loadUsersTable() {
      const loadingUsers = document.getElementById('loadingUsers');
      const tableContainer = document.getElementById('usersTableContainer');
      
      // Populate country filter
      const countries = new Set(allUsers.filter(u => u.country).map(u => u.country));
      const countrySelect = document.getElementById('filterCountry');
      countrySelect.innerHTML = '<option value="">Todos</option>';
      Array.from(countries).sort().forEach(country => {
        countrySelect.innerHTML += `<option value="${country}">${country}</option>`;
      });
      
      // Inicializar lista filtrada com todos os users
      filteredUsers = [...allUsers];
      currentPage = 1;
      
      renderUsersPage();
      
      loadingUsers.style.display = 'none';
      tableContainer.style.display = 'block';
    }
    
    function renderUsersPage() {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';
      
      if (filteredUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #6c757d; padding: 40px;">Nenhum utilizador encontrado.</td></tr>';
        updatePaginationInfo(0, 0, 0);
        return;
      }
      
      // Calcular Ã­ndices da pÃ¡gina
      const startIndex = (currentPage - 1) * usersPerPage;
      const endIndex = Math.min(startIndex + usersPerPage, filteredUsers.length);
      const pageUsers = filteredUsers.slice(startIndex, endIndex);
      
      // Renderizar apenas os users da pÃ¡gina atual
      pageUsers.forEach(user => {
        const row = createUserRow(user);
        tbody.appendChild(row);
      });
      
      // Atualizar info de paginaÃ§Ã£o
      updatePaginationInfo(startIndex + 1, endIndex, filteredUsers.length);
    }
    
    function updatePaginationInfo(start, end, total) {
      const totalPages = Math.ceil(total / usersPerPage);
      const paginationDiv = document.getElementById('paginationControls');
      
      if (!paginationDiv) return;
      
      paginationDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 10px; margin-top: 15px;">
          <span style="color: #6c757d;">
            A mostrar <strong>${start}-${end}</strong> de <strong>${total}</strong> utilizadores
          </span>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''} 
                    style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; background: ${currentPage === 1 ? '#e9ecef' : 'white'}; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};">
              â®ï¸ Primeira
            </button>
            <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} 
                    style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; background: ${currentPage === 1 ? '#e9ecef' : 'white'}; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};">
              â—€ï¸ Anterior
            </button>
            <span style="padding: 8px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 6px; font-weight: 600;">
              ${currentPage} / ${totalPages || 1}
            </span>
            <button onclick="goToPage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''} 
                    style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; background: ${currentPage >= totalPages ? '#e9ecef' : 'white'}; cursor: ${currentPage >= totalPages ? 'not-allowed' : 'pointer'};">
              Seguinte â–¶ï¸
            </button>
            <button onclick="goToPage(${totalPages})" ${currentPage >= totalPages ? 'disabled' : ''} 
                    style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; background: ${currentPage >= totalPages ? '#e9ecef' : 'white'}; cursor: ${currentPage >= totalPages ? 'not-allowed' : 'pointer'};">
              Ãšltima â­ï¸
            </button>
          </div>
        </div>
      `;
    }
    
    function goToPage(page) {
      const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderUsersPage();
    }
    
    function createUserRow(user) {
      const tr = document.createElement('tr');
      tr.setAttribute('data-user-id', user.id);
      tr.setAttribute('data-gender', user.gender || '');
      tr.setAttribute('data-country', user.country || '');
      
      const createdAt = user.createdAt?.toDate();
      const lastLogin = user.lastLogin?.toDate();
      
      const createdStr = createdAt ? createdAt.toLocaleDateString('pt-PT') + ' ' + createdAt.toLocaleTimeString('pt-PT', {hour: '2-digit', minute: '2-digit'}) : '-';
      const loginStr = lastLogin ? lastLogin.toLocaleDateString('pt-PT') + ' ' + lastLogin.toLocaleTimeString('pt-PT', {hour: '2-digit', minute: '2-digit'}) : '-';
      
      // GÃ©nero com possibilidade de ediÃ§Ã£o se nÃ£o definido ou "outro"
      let genderCell;
      if (user.gender === 'M') {
        genderCell = '<span class="badge badge-male">â™‚ï¸ Masculino</span>';
      } else if (user.gender === 'F') {
        genderCell = '<span class="badge badge-female">â™€ï¸ Feminino</span>';
      } else {
        // Sem gÃ©nero ou "outro" - mostrar botÃ£o para editar
        genderCell = `
          <div style="display: flex; align-items: center; gap: 5px;">
            <span class="badge badge-other">âš§ï¸ ${user.gender === 'outro' ? 'Outro' : 'N/D'}</span>
            <button onclick="showGenderEdit('${user.id}')" 
                    style="padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75em;" 
                    title="Editar gÃ©nero">
              âœï¸
            </button>
          </div>
        `;
      }
      
      const usernameBadge = user.username ? 
        `<span style="color: #667eea; font-weight: 500;">@${user.username}</span>` :
        '<span style="color: #dc3545; font-size: 0.85em;">âŒ Sem username</span>';
        // Mascarar email para privacidade
      const maskedEmail = maskEmail(user.email);
      
      // Mascarar apelido para privacidade
      const maskedName = maskName(user.name);
      
      tr.innerHTML = `
        <td><span class="user-email" title="${user.email || ''}">${maskedEmail}</span></td>
        <td><span title="${user.name || '-'}">${maskedName || '-'}</span></td>
        <td>${usernameBadge}</td>
        <td id="gender-cell-${user.id}">${genderCell}</td>
        <td>${user.ageRange || '-'}</td>
        <td>${user.country || '-'}</td>
        <td>${user.city || '-'}</td>
        <td>${createdStr}</td>
        <td>${loginStr}</td>
        <td>
          <button onclick="deleteUser('${user.id}', '${maskEmail(user.email)}')" 
                  style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; transition: all 0.2s;"
                  onmouseover="this.style.background='#c82333'" 
                  onmouseout="this.style.background='#dc3545'"
                  title="Eliminar utilizador">
            ğŸ—‘ï¸ Eliminar
          </button>
        </td>
      `;
      
      return tr;
    }
    
    // ===========================
    // FILTERS - Corrigido
    // ===========================
    function filterUsers() {
      const searchTerm = document.getElementById('searchUser').value.toLowerCase().trim();
      const genderFilter = document.getElementById('filterGender').value;
      const countryFilter = document.getElementById('filterCountry').value;
      
      // Filtrar a lista de utilizadores (nÃ£o as linhas da tabela)
      filteredUsers = allUsers.filter(user => {
        // Filtro de pesquisa (nome ou email)
        const matchSearch = !searchTerm || 
          (user.email && user.email.toLowerCase().includes(searchTerm)) ||
          (user.name && user.name.toLowerCase().includes(searchTerm)) ||
          (user.username && user.username.toLowerCase().includes(searchTerm));
        
        // Filtro de gÃ©nero (inclui "nd" para nÃ£o definido)
        let matchGender = !genderFilter;
        if (genderFilter === 'nd') {
          // Filtrar utilizadores sem gÃ©nero definido
          matchGender = !user.gender || user.gender === '';
        } else if (genderFilter) {
          matchGender = user.gender === genderFilter;
        }
        
        // Filtro de paÃ­s
        const matchCountry = !countryFilter || user.country === countryFilter;
        
        return matchSearch && matchGender && matchCountry;
      });
      
      // Voltar Ã  primeira pÃ¡gina e re-renderizar
      currentPage = 1;
      renderUsersPage();
    }
    
    function resetFilters() {
      document.getElementById('searchUser').value = '';
      document.getElementById('filterGender').value = '';
      document.getElementById('filterCountry').value = '';
      filteredUsers = [...allUsers];
      currentPage = 1;
      renderUsersPage();
    }
    
    // ===========================
    // EDIT GENDER
    // ===========================
    function showGenderEdit(userId) {
      const cell = document.getElementById(`gender-cell-${userId}`);
      if (!cell) return;
      
      cell.innerHTML = `
        <select id="gender-select-${userId}" style="padding: 6px 10px; border: 2px solid #667eea; border-radius: 6px; font-size: 0.9em;">
          <option value="">Selecionar...</option>
          <option value="M">â™‚ï¸ Masculino</option>
          <option value="F">â™€ï¸ Feminino</option>
          <option value="outro">âš§ï¸ Outro</option>
        </select>
        <button onclick="saveGender('${userId}')" 
                style="padding: 6px 10px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 5px;">
          âœ“
        </button>
        <button onclick="cancelGenderEdit('${userId}')" 
                style="padding: 6px 10px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 3px;">
          âœ•
        </button>
      `;
    }
    
    async function saveGender(userId) {
      const select = document.getElementById(`gender-select-${userId}`);
      const newGender = select?.value;
      
      if (!newGender) {
        alert('Por favor seleciona um gÃ©nero.');
        return;
      }
      
      try {
        // Atualizar no Firestore
        await db.collection('users').doc(userId).update({
          gender: newGender
        });
        
        // Atualizar na lista local
        const userIndex = allUsers.findIndex(u => u.id === userId);
        if (userIndex !== -1) {
          allUsers[userIndex].gender = newGender;
        }
        
        // Atualizar na lista filtrada
        const filteredIndex = filteredUsers.findIndex(u => u.id === userId);
        if (filteredIndex !== -1) {
          filteredUsers[filteredIndex].gender = newGender;
        }
        
        // Re-renderizar a pÃ¡gina atual
        renderUsersPage();
        
        // Atualizar stats do dashboard
        updateDashboardStats();
        
        console.log(`âœ… GÃ©nero do utilizador ${userId} atualizado para ${newGender}`);
        
      } catch (error) {
        console.error('Erro ao atualizar gÃ©nero:', error);
        alert('âŒ Erro ao atualizar gÃ©nero: ' + error.message);
      }
    }
    
    function cancelGenderEdit(userId) {
      // Re-renderizar para voltar ao estado original
      renderUsersPage();
    }
    
    // ===========================
    // SORT USERS TABLE - Ordenar a lista filtrada
    // ===========================
    let currentSortColumn = -1;
    let currentSortOrder = 'asc';
    
    // Mapeamento de colunas para propriedades do objeto user
    const columnMapping = {
      0: 'email',
      1: 'name',
      2: 'username',
      3: 'gender',
      4: 'ageRange',
      5: 'country',
      6: 'city',
      7: 'createdAt',
      8: 'lastLogin'
    };
    
    function sortUsersTable(columnIndex, type) {
      const table = document.getElementById('usersTable');
      const headers = table.querySelectorAll('th.sortable');
      
      // Determinar a ordem (toggle entre asc e desc)
      if (currentSortColumn === columnIndex) {
        currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortOrder = 'asc';
        currentSortColumn = columnIndex;
      }
      
      // Remover classes de ordenaÃ§Ã£o de todos os headers
      headers.forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        const icon = th.querySelector('.sort-icon');
        if (icon) icon.textContent = 'â‡…';
      });
      
      // Adicionar classe ao header atual
      const currentHeader = headers[columnIndex];
      if (currentHeader) {
        currentHeader.classList.add(currentSortOrder === 'asc' ? 'sorted-asc' : 'sorted-desc');
        const icon = currentHeader.querySelector('.sort-icon');
        if (icon) icon.textContent = currentSortOrder === 'asc' ? 'â†‘' : 'â†“';
      }
      
      // Obter a propriedade a ordenar
      const property = columnMapping[columnIndex];
      
      // Ordenar a lista filtrada
      filteredUsers.sort((a, b) => {
        let aValue = a[property];
        let bValue = b[property];
        
        // Tratar timestamps do Firestore
        if (type === 'date') {
          aValue = aValue?.toDate ? aValue.toDate() : (aValue || new Date(0));
          bValue = bValue?.toDate ? bValue.toDate() : (bValue || new Date(0));
          
          const comparison = aValue - bValue;
          return currentSortOrder === 'asc' ? comparison : -comparison;
        }
        
        // Tratar valores nulos/undefined
        aValue = aValue || '';
        bValue = bValue || '';
        
        // OrdenaÃ§Ã£o de strings (case insensitive)
        const comparison = aValue.toString().toLowerCase().localeCompare(bValue.toString().toLowerCase(), 'pt');
        return currentSortOrder === 'asc' ? comparison : -comparison;
      });
      
      // Re-renderizar a pÃ¡gina atual
      renderUsersPage();
      
      console.log(`ğŸ“Š Lista ordenada por ${property} - ${currentSortOrder}`);
    }
    
    // ===========================
    // DELETE USER
    // ===========================
    async function deleteUser(userId, userEmail) {
      // ConfirmaÃ§Ã£o dupla para seguranÃ§a
      if (!confirm(`âš ï¸ ATENÃ‡ÃƒO!\n\nTens a certeza que queres eliminar o utilizador:\n${userEmail}\n\nEsta aÃ§Ã£o Ã© IRREVERSÃVEL!`)) {
        return;
      }
      
      if (!confirm(`ğŸ”´ CONFIRMAÃ‡ÃƒO FINAL\n\nVais eliminar permanentemente:\n${userEmail}\n\nTodos os dados serÃ£o perdidos!\n\nContinuar?`)) {
        return;
      }
      
      try {
        // Mostrar loading
        const loadingUsers = document.getElementById('loadingUsers');
        const tableContainer = document.getElementById('usersTableContainer');
        if (loadingUsers) loadingUsers.style.display = 'flex';
        if (tableContainer) tableContainer.style.display = 'none';
        
        // Eliminar documento do Firestore
        await db.collection('users').doc(userId).delete();
        
        // Eliminar subcoleÃ§Ãµes (answers, progress, etc.)
        try {
          const answersRef = db.collection('users').doc(userId).collection('answers');
          const answersSnapshot = await answersRef.get();
          for (const doc of answersSnapshot.docs) {
            await doc.ref.delete();
          }
        } catch (e) { console.log('Sem respostas para eliminar'); }
        
        try {
          const progressRef = db.collection('users').doc(userId).collection('progress');
          const progressSnapshot = await progressRef.get();
          for (const doc of progressSnapshot.docs) {
            await doc.ref.delete();
          }
        } catch (e) { console.log('Sem progresso para eliminar'); }
        
        // Eliminar conexÃµes onde o utilizador participa
        try {
          const connectionsSnapshot = await db.collection('connections')
            .where('users', 'array-contains', userId)
            .get();
          for (const doc of connectionsSnapshot.docs) {
            await doc.ref.delete();
          }
        } catch (e) { console.log('Sem conexÃµes para eliminar'); }
        
        // Eliminar pedidos de conexÃ£o
        try {
          const requestsFrom = await db.collection('connection_requests')
            .where('fromUserId', '==', userId)
            .get();
          for (const doc of requestsFrom.docs) {
            await doc.ref.delete();
          }
          
          const requestsTo = await db.collection('connection_requests')
            .where('toUserId', '==', userId)
            .get();
          for (const doc of requestsTo.docs) {
            await doc.ref.delete();
          }
        } catch (e) { console.log('Sem pedidos para eliminar'); }
        
        // Atualizar lista local
        allUsers = allUsers.filter(u => u.id !== userId);
        
        // Re-renderizar
        loadUsersTable();
        updateDashboardStats();
        
        alert(`âœ… Utilizador ${userEmail} eliminado com sucesso!`);
        
      } catch (error) {
        console.error('Erro ao eliminar utilizador:', error);
        alert(`âŒ Erro ao eliminar utilizador: ${error.message}`);
        
        // Restaurar tabela
        const loadingUsers = document.getElementById('loadingUsers');
        const tableContainer = document.getElementById('usersTableContainer');
        if (loadingUsers) loadingUsers.style.display = 'none';
        if (tableContainer) tableContainer.style.display = 'block';
      }
    }
    
    // ===========================
    // ACTIVITY LOG
    // ===========================
    async function loadActivityLog() {
      const loadingActivity = document.getElementById('loadingActivity');
      const activityLog = document.getElementById('activityLog');
      
      console.log('ğŸ“‹ A carregar log de atividade completo...');
      
      allActivity = [];
      
      // 1. REGISTOS E LOGINS (de users)
      allUsers.forEach(user => {        if (user.createdAt) {
          const maskedNameForActivity = maskName(user.name);
          allActivity.push({
            type: 'register',
            user: user.email,
            userName: maskedNameForActivity || 'Sem nome',
            timestamp: user.createdAt.toDate(),
            details: `Novo registo: ${maskedNameForActivity || 'Sem nome'}`
          });
        }
        
        if (user.lastLogin) {
          const maskedNameForActivity = maskName(user.name);
          allActivity.push({
            type: 'login',
            user: user.email,
            userName: maskedNameForActivity || 'Sem nome',
            timestamp: user.lastLogin.toDate(),
            details: `Login realizado`
          });
        }
      });
      
      console.log('âœ… Registos e logins carregados:', allActivity.length);
      
      // 2. RESPOSTAS (de userAnswers)
      try {
        const answersSnapshot = await db.collection('userAnswers').get();
        console.log('ğŸ“ Documentos de respostas encontrados:', answersSnapshot.size);
        
        answersSnapshot.forEach(doc => {
          const data = doc.data();
          const userId = doc.id;
          const user = allUsers.find(u => u.id === userId);
          const userEmail = user?.email || userId;
          const userName = user?.name || 'Utilizador desconhecido';
          
          // Contar respostas por pack
          Object.keys(data).forEach(packId => {
            if (typeof data[packId] === 'object' && data[packId] !== null) {
              const answers = data[packId];
              const answerCount = Object.keys(answers).length;
              
              if (answerCount > 0) {
                // Usar updatedAt se existir, senÃ£o usar createdAt do user
                const timestamp = data.updatedAt?.toDate() || user?.createdAt?.toDate() || new Date();
                
                allActivity.push({
                  type: 'answer',
                  user: userEmail,
                  userName: userName,
                  timestamp: timestamp,
                  details: `Respondeu a ${answerCount} perguntas do pack "${packId}"`
                });
              }
            }
          });
        });
        
        console.log('âœ… Respostas carregadas. Total atividades:', allActivity.length);
      } catch (error) {
        console.error('âŒ Erro ao carregar respostas:', error);
      }
      
      // 3. RELATÃ“RIOS (de partnerConnections com reportViewed)
      try {
        const connectionsSnapshot = await db.collection('partnerConnections').get();
        console.log('ğŸ“Š ConexÃµes encontradas:', connectionsSnapshot.size);
        
        connectionsSnapshot.forEach(doc => {
          const data = doc.data();
          
          if (data.reportViewed) {
            const user1 = allUsers.find(u => u.id === data.userId);
            const user2 = allUsers.find(u => u.id === data.partnerId);
            
            const user1Name = user1?.name || 'Utilizador 1';
            const user2Name = user2?.name || 'Utilizador 2';
            const user1Email = user1?.email || data.userId;
            
            allActivity.push({
              type: 'report',
              user: user1Email,
              userName: user1Name,
              timestamp: data.reportViewed.toDate(),
              details: `Gerou relatÃ³rio com ${user2Name}`
            });
          }
        });
        
        console.log('âœ… RelatÃ³rios carregados. Total atividades:', allActivity.length);
      } catch (error) {
        console.error('âŒ Erro ao carregar relatÃ³rios:', error);
      }
      
      // 4. CONEXÃ•ES (de partnerConnections com createdAt)
      try {
        const connectionsSnapshot = await db.collection('partnerConnections').get();
        
        connectionsSnapshot.forEach(doc => {
          const data = doc.data();
          
          if (data.createdAt) {
            const user1 = allUsers.find(u => u.id === data.userId);
            const user2 = allUsers.find(u => u.id === data.partnerId);
            
            const user1Name = user1?.name || 'Utilizador 1';
            const user2Name = user2?.name || 'Utilizador 2';
            const user1Email = user1?.email || data.userId;
            
            allActivity.push({
              type: 'connection',
              user: user1Email,
              userName: user1Name,
              timestamp: data.createdAt.toDate(),
              details: `Conectou-se com ${user2Name}`
            });
          }
        });
        
        console.log('âœ… ConexÃµes carregadas. Total atividades:', allActivity.length);
      } catch (error) {
        console.error('âŒ Erro ao carregar conexÃµes:', error);
      }
      
      // Sort by timestamp desc
      allActivity.sort((a, b) => b.timestamp - a.timestamp);
      
      console.log('ğŸ“Š Total de atividades:', allActivity.length);
      
      // Calcular estatÃ­sticas por tipo
      const activityCounts = {
        register: allActivity.filter(a => a.type === 'register').length,
        login: allActivity.filter(a => a.type === 'login').length,
        answer: allActivity.filter(a => a.type === 'answer').length,
        report: allActivity.filter(a => a.type === 'report').length,
        connection: allActivity.filter(a => a.type === 'connection').length
      };
      
      // Atividades hoje
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayActivity = allActivity.filter(a => a.timestamp >= today).length;
      
      // Mostrar estatÃ­sticas
      const statsContainer = document.getElementById('activityStats');
      if (statsContainer) {
        statsContainer.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border-radius: 10px; text-align: center; color: white;">
              <div style="font-size: 1.5em; font-weight: 700;">${allActivity.length}</div>
              <div style="font-size: 0.75em; opacity: 0.9;">Total</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-top: 3px solid #28a745;">
              <div style="font-size: 1.5em; font-weight: 700; color: #28a745;">${todayActivity}</div>
              <div style="font-size: 0.75em; color: #6c757d;">Hoje</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
              <div style="font-size: 1.5em; font-weight: 700; color: #17a2b8;">ğŸ†• ${activityCounts.register}</div>
              <div style="font-size: 0.75em; color: #6c757d;">Registos</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
              <div style="font-size: 1.5em; font-weight: 700; color: #6c757d;">ğŸ”“ ${activityCounts.login}</div>
              <div style="font-size: 0.75em; color: #6c757d;">Logins</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
              <div style="font-size: 1.5em; font-weight: 700; color: #fd7e14;">âœï¸ ${activityCounts.answer}</div>
              <div style="font-size: 0.75em; color: #6c757d;">Respostas</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
              <div style="font-size: 1.5em; font-weight: 700; color: #e91e63;">ğŸ’‘ ${activityCounts.connection}</div>
              <div style="font-size: 0.75em; color: #6c757d;">ConexÃµes</div>
            </div>
          </div>
        `;
        statsContainer.style.display = 'block';
      }
      
      // Show only last 100
      const recentActivity = allActivity.slice(0, 100);
      
      activityLog.innerHTML = '';
      
      if (recentActivity.length === 0) {
        activityLog.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">Nenhuma atividade registada.</p>';
      } else {
        recentActivity.forEach(activity => {
          const item = createActivityItem(activity);
          activityLog.appendChild(item);
        });
      }
      
      loadingActivity.style.display = 'none';
      activityLog.style.display = 'block';
    }
      function createActivityItem(activity) {
      const div = document.createElement('div');
      div.className = 'activity-item';
      div.setAttribute('data-type', activity.type);
      
      const typeConfig = {
        register: { icon: 'ğŸ†•', label: 'Registo', color: '#17a2b8' },
        login: { icon: 'ğŸ”“', label: 'Login', color: '#6c757d' },
        answer: { icon: 'âœï¸', label: 'Resposta', color: '#fd7e14' },
        report: { icon: 'ğŸ“Š', label: 'RelatÃ³rio', color: '#28a745' },
        connection: { icon: 'ğŸ’‘', label: 'ConexÃ£o', color: '#e91e63' }
      };
      
      const config = typeConfig[activity.type] || { icon: 'ğŸ“', label: activity.type, color: '#667eea' };
      
      const timeStr = activity.timestamp.toLocaleDateString('pt-PT') + ' Ã s ' + 
                      activity.timestamp.toLocaleTimeString('pt-PT', {hour: '2-digit', minute: '2-digit'});
      
      div.style.borderLeftColor = config.color;
      
      div.innerHTML = `
        <div class="activity-header">
          <div class="activity-type" style="color: ${config.color};">${config.icon} ${config.label}</div>
          <div class="activity-time">${timeStr}</div>
        </div>
        <div class="activity-details">
          <strong>${activity.user}</strong> - ${activity.details}
        </div>
      `;
      
      return div;
    }
    
    // ===========================
    // RENDER ACTIVITY LOG (FROM CACHE)
    // ===========================
    function renderActivityLog() {
      console.log('ğŸ“‹ A renderizar log de atividade do cache...');
      
      const activityLog = document.getElementById('activityLog');
      
      if (!allActivity || allActivity.length === 0) {
        activityLog.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">Nenhuma atividade registada.</p>';
        return;
      }
      
      // Calcular estatÃ­sticas
      const activityCounts = {
        register: allActivity.filter(a => a.type === 'register').length,
        login: allActivity.filter(a => a.type === 'login').length,
        answer: allActivity.filter(a => a.type === 'answer').length,
        report: allActivity.filter(a => a.type === 'report').length,
        connection: allActivity.filter(a => a.type === 'connection').length
      };
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayActivity = allActivity.filter(a => a.timestamp >= today).length;
      
      // Atualizar estatÃ­sticas
      const statsContainer = document.getElementById('activityStats');
      if (statsContainer) {
        statsContainer.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border-radius: 10px; text-align: center; color: white;">
              <div style="font-size: 1.5em; font-weight: 700;">${allActivity.length}</div>
              <div style="font-size: 0.75em; opacity: 0.9;">Total</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-top: 3px solid #28a745;">
              <div style="font-size: 1.5em; font-weight: 700; color: #28a745;">${todayActivity}</div>
              <div style="font-size: 0.75em; color: #6c757d;">Hoje</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
              <div style="font-size: 1.5em; font-weight: 700; color: #17a2b8;">ğŸ†• ${activityCounts.register}</div>
              <div style="font-size: 0.75em; color: #6c757d;">Registos</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
              <div style="font-size: 1.5em; font-weight: 700; color: #6c757d;">ğŸ”“ ${activityCounts.login}</div>
              <div style="font-size: 0.75em; color: #6c757d;">Logins</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
              <div style="font-size: 1.5em; font-weight: 700; color: #fd7e14;">âœï¸ ${activityCounts.answer}</div>
              <div style="font-size: 0.75em; color: #6c757d;">Respostas</div>
            </div>
            <div style="background: white; padding: 12px; border-radius: 10px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
              <div style="font-size: 1.5em; font-weight: 700; color: #e91e63;">ğŸ’‘ ${activityCounts.connection}</div>
              <div style="font-size: 0.75em; color: #6c757d;">ConexÃµes</div>
            </div>
          </div>
        `;
      }
      
      // Renderizar Ãºltimas 100 atividades
      const recentActivity = allActivity.slice(0, 100);
      activityLog.innerHTML = '';
      
      recentActivity.forEach(activity => {
        const item = createActivityItem(activity);
        activityLog.appendChild(item);
      });
      
      console.log('âœ… Log de atividade renderizado:', recentActivity.length, 'itens');
    }
    
    function filterActivity() {
      const typeFilter = document.getElementById('filterActivityType').value;
      const dateFilter = document.getElementById('filterActivityDate').value;
      
      const items = document.querySelectorAll('.activity-item');
      let visibleCount = 0;
      
      items.forEach(item => {
        const itemType = item.getAttribute('data-type');
        const dateText = item.querySelector('.activity-time').textContent;
        
        const matchType = !typeFilter || itemType === typeFilter;
        
        let matchDate = true;
        if (dateFilter) {
          const itemDate = dateText.split(' ')[0];
          const filterDate = new Date(dateFilter).toLocaleDateString('pt-PT');
          matchDate = itemDate === filterDate;
        }
        
        const visible = matchType && matchDate;
        item.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
      });
      
      // Mostrar mensagem se nÃ£o houver resultados
      const activityLog = document.getElementById('activityLog');
      const noResultsMsg = activityLog.querySelector('.no-results-msg');
      
      if (visibleCount === 0 && (typeFilter || dateFilter)) {
        if (!noResultsMsg) {
          const msg = document.createElement('div');
          msg.className = 'no-results-msg';
          msg.style.cssText = 'text-align: center; color: #6c757d; padding: 30px;';
          msg.innerHTML = 'ğŸ” Nenhuma atividade encontrada com os filtros selecionados.';
          activityLog.appendChild(msg);
        }
      } else if (noResultsMsg) {
        noResultsMsg.remove();
      }
    }
    
    function resetActivityFilters() {
      document.getElementById('filterActivityType').value = '';
      document.getElementById('filterActivityDate').value = '';
      filterActivity();
    }
    
    // ===========================
    // EXPORT FUNCTIONS    // ===========================
    // USERNAME MIGRATION
    // ===========================
    async function checkUsersWithoutUsername() {
      const usersWithoutUsername = allUsers.filter(user => !user.username);
      const count = usersWithoutUsername.length;
      
      const alertDiv = document.getElementById('migrationAlert');
      const countSpan = document.getElementById('usersWithoutUsername');
      
      if (count > 0) {
        countSpan.textContent = count;
        alertDiv.style.display = 'block';
      } else {
        alertDiv.style.display = 'none';
      }
      
      return count;
    }
    
    async function migrateUsernames() {
      if (!confirm('âš ï¸ AtenÃ§Ã£o!\n\nEsta operaÃ§Ã£o vai adicionar automaticamente um username a todos os utilizadores que ainda nÃ£o tÃªm um definido.\n\nOs usernames serÃ£o gerados com base no nome ou email do utilizador.\n\nDesejas continuar?')) {
        return;
      }
      
      try {
        const usersWithoutUsername = allUsers.filter(user => !user.username);
        
        if (usersWithoutUsername.length === 0) {
          alert('âœ… Todos os utilizadores jÃ¡ tÃªm username!');
          return;
        }
        
        console.log(`ğŸ”„ Migrando ${usersWithoutUsername.length} utilizadores...`);
        
        let successCount = 0;
        let errorCount = 0;
        const errors = [];
        
        for (const user of usersWithoutUsername) {
          try {
            // Gerar username base a partir do nome ou email
            let baseUsername = '';
            if (user.name) {
              baseUsername = user.name
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove acentos
                .replace(/[^a-z0-9]/g, '')        // Remove caracteres especiais
                .substring(0, 15);
            } else if (user.email) {
              baseUsername = user.email
                .split('@')[0]
                .toLowerCase()
                .replace(/[^a-z0-9]/g, '')
                .substring(0, 15);
            } else {
              baseUsername = 'user';
            }
            
            // Garantir que tem pelo menos 3 caracteres
            if (baseUsername.length < 3) {
              baseUsername = baseUsername + '123';
            }
            
            // Verificar se username jÃ¡ existe e adicionar nÃºmero se necessÃ¡rio
            let username = baseUsername;
            let counter = 1;
            let isUnique = false;
            
            while (!isUnique) {
              const check = await db.collection('users')
                .where('username', '==', username)
                .limit(1)
                .get();
              
              if (check.empty) {
                isUnique = true;
              } else {
                username = `${baseUsername}${counter}`;
                counter++;
              }
            }
            
            // Atualizar documento com o username
            await db.collection('users').doc(user.uid).update({
              username: username,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            console.log(`âœ… ${user.email || user.uid} -> @${username}`);
            successCount++;
            
          } catch (error) {
            console.error(`âŒ Erro ao processar ${user.uid}:`, error);
            errors.push({ user: user.email || user.uid, error: error.message });
            errorCount++;
          }
        }
        
        // Mostrar resultado
        let message = 'ğŸ“Š MIGRAÃ‡ÃƒO CONCLUÃDA\n\n';
        message += `âœ… Sucesso: ${successCount} utilizadores\n`;
        message += `âŒ Erros: ${errorCount} utilizadores\n\n`;
        
        if (errors.length > 0) {
          message += 'âš ï¸ Erros encontrados:\n';
          errors.forEach(e => {
            message += `  - ${e.user}: ${e.error}\n`;
          });
        }
          if (errorCount === 0) {
          message += 'ğŸ‰ Todos os usernames foram adicionados com sucesso!';
        }
        
        alert(message);
        
        // Recarregar utilizadores
        try {
          const usersSnapshot = await db.collection('users').get();
          allUsers = [];
          
          usersSnapshot.forEach(doc => {
            allUsers.push({ id: doc.id, uid: doc.id, ...doc.data() });
          });
          
          console.log('âœ… Utilizadores recarregados:', allUsers.length);
          
          // Atualizar tabela e estatÃ­sticas
          loadUsersTable();
          updateDashboardStats();
          await checkUsersWithoutUsername();
        } catch (reloadError) {
          console.error('âš ï¸ Erro ao recarregar dados:', reloadError);
        }
        
      } catch (error) {
        console.error('âŒ Erro fatal na migraÃ§Ã£o:', error);
        alert('âŒ Erro ao migrar usernames:\n\n' + error.message);
      }
    }
    
    // ===========================
    // EXPORT FUNCTIONS
    // ===========================
    function exportUsers() {
      const csv = ['Email,Nome,Username,Sexo,Idade,PaÃ­s,Cidade,Data Registo,Ãšltimo Login'];
        allUsers.forEach(user => {      const createdAt = user.createdAt?.toDate();
        const lastLogin = user.lastLogin?.toDate();
        
        // Mascarar nome no export para privacidade
        const maskedNameForExport = maskName(user.name);
        
        const row = [
          user.email || '',
          maskedNameForExport || '',
          user.username ? `@${user.username}` : 'Sem username',
          user.gender || '',
          user.ageRange || '',
          user.country || '',
          user.city || '',
          createdAt ? createdAt.toLocaleString('pt-PT') : '',
          lastLogin ? lastLogin.toLocaleString('pt-PT') : ''
        ];
        
        csv.push(row.join(','));
      });
      
      downloadCSV(csv.join('\n'), 'quest4couple_users.csv');
    }
    
    function exportActivity() {
      const csv = ['Tipo,Utilizador,Data/Hora,Detalhes'];
      
      allActivity.forEach(activity => {
        const row = [
          activity.type,
          activity.user,
          activity.timestamp.toLocaleString('pt-PT'),
          activity.details
        ];
        
        csv.push(row.join(','));
      });
      
      downloadCSV(csv.join('\n'), 'quest4couple_activity.csv');
    }
      function downloadCSV(content, filename) {
      const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // ===========================
    // MODAL FUNCTIONS
    // ===========================
    function closeReportModal() {
      const modal = document.getElementById('reportModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('reportModal');
      if (event.target === modal) {
        closeReportModal();
      }
    };
    
    // Close modal with ESC key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeReportModal();
      }
    });
  </script>

</body>
</html>
