<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin BackOffice - Quest4Couple</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    /* Login Container */
    .login-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-width: 400px;
      margin: 100px auto;
    }
    
    .admin-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .admin-header img {
      width: 120px;
      height: auto;
      margin-bottom: 15px;
    }
    
    .admin-header h1 {
      color: #667eea;
      font-size: 1.8em;
      margin-bottom: 5px;
    }
    
    .admin-header p {
      color: #6c757d;
      font-size: 0.9em;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #495057;
      font-weight: 600;
      font-size: 0.9em;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn-login {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-login:active {
      transform: translateY(0);
    }
    
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 0.9em;
      display: none;
      border: 1px solid #f5c6cb;
    }
    
    .error-message.show {
      display: block;
      animation: shake 0.3s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    .back-link {
      display: inline-block;
      margin-top: 20px;
      color: #667eea;
      text-decoration: none;
      font-size: 0.9em;
      transition: color 0.3s;
      text-align: center;
      width: 100%;
    }
    
    .back-link:hover {
      color: #764ba2;
    }
    
    /* Admin Dashboard */
    .admin-dashboard {
      display: none;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .dashboard-header {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .dashboard-header h1 {
      color: #667eea;
      font-size: 2em;
    }
    
    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .admin-info {
      font-size: 0.9em;
      color: #6c757d;
    }
    
    .btn-logout {
      padding: 10px 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .btn-logout:hover {
      background: #c82333;
    }
    
    /* Tabs Navigation */
    .tabs-nav {
      background: white;
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .tab-btn {
      padding: 12px 24px;
      background: #f8f9fa;
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95em;
      color: #6c757d;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tab-btn:hover {
      background: #e9ecef;
      border-color: #667eea;
    }
    
    .tab-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }
    
    /* Tab Content */
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      border-left: 5px solid;
      transition: transform 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card.purple { border-color: #667eea; }
    .stat-card.pink { border-color: #f093fb; }
    .stat-card.blue { border-color: #4facfe; }
    .stat-card.green { border-color: #43e97b; }
    
    .stat-card h3 {
      font-size: 0.85em;
      color: #6c757d;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-value {
      font-size: 2.5em;
      font-weight: 700;
      color: #495057;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.9em;
      color: #6c757d;
    }
    
    /* Content Card */
    .content-card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .content-card h2 {
      color: #495057;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Table Styles */
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }
    
    thead {
      background: #f8f9fa;
    }
    
    th {
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
    }
    
    td {
      padding: 15px 12px;
      border-bottom: 1px solid #f1f3f5;
      color: #495057;
    }
    
    tbody tr:hover {
      background: #f8f9fa;
    }
    
    .user-email {
      font-weight: 600;
      color: #667eea;
    }
    
    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
      display: inline-block;
    }
    
    .badge-male {
      background: #cfe2ff;
      color: #084298;
    }
    
    .badge-female {
      background: #f8d7da;
      color: #842029;
    }
    
    .badge-other {
      background: #fff3cd;
      color: #664d03;
    }
    
    /* Filters */
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.85em;
      color: #6c757d;
      font-weight: 600;
    }
    
    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 0.9em;
    }
    
    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn-filter {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .btn-filter:hover {
      background: #5568d3;
    }
    
    .btn-reset {
      padding: 10px 20px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .btn-reset:hover {
      background: #5a6268;
    }
    
    /* Activity Log */
    .activity-item {
      padding: 15px;
      border-left: 4px solid #667eea;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .activity-type {
      font-weight: 600;
      color: #667eea;
    }
    
    .activity-time {
      font-size: 0.85em;
      color: #6c757d;
    }
    
    .activity-details {
      font-size: 0.9em;
      color: #495057;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Export Button */
    .btn-export {
      padding: 8px 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9em;
      transition: background 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
      .btn-export:hover {
      background: #218838;
    }
    
    /* Analytics Cards */
    .report-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
    }
    
    .question-analytics-card {
      transition: all 0.3s;
    }
    
    .question-analytics-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      animation: fadeIn 0.3s;
    }
    
    .modal-content {
      background-color: white;
      margin: 2% auto;
      padding: 0;
      border-radius: 15px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow: hidden;
      animation: slideDown 0.3s;
      box-shadow: 0 10px 50px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      margin: 0;
      font-size: 1.5em;
    }
    
    .modal-close {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.5em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .modal-close:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }
    
    .modal-body {
      padding: 30px;
      max-height: calc(90vh - 160px);
      overflow-y: auto;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideDown {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        gap: 15px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .filters {
        flex-direction: column;
      }
      
      table {
        font-size: 0.8em;
      }
      
      th, td {
        padding: 10px 8px;
      }
    }
  </style>
</head>
<body>

  <!-- LOGIN FORM -->
  <div class="login-container" id="loginContainer">
    <div class="admin-header">
      <img src="../assets/logo.png" alt="Quest4Couple">
      <h1>üîê Admin BackOffice</h1>
      <p>Acesso Restrito - Administradores</p>
    </div>
    
    <div class="error-message" id="errorMessage">
      ‚ùå Credenciais inv√°lidas!
    </div>
    
    <form id="adminLoginForm">
      <div class="form-group">
        <label for="adminUsername">üë§ Username</label>
        <input 
          type="text" 
          id="adminUsername" 
          placeholder="carlos.sousacorreia" 
          required 
          autocomplete="username"
        >
      </div>
      
      <div class="form-group">
        <label for="adminPassword">üîí Password</label>
        <input 
          type="password" 
          id="adminPassword" 
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
          required
          autocomplete="current-password"
        >
      </div>
      
      <button type="submit" class="btn-login">
        üîì Entrar no BackOffice
      </button>
    </form>
    
    <a href="../index.html" class="back-link">‚Üê Voltar ao site</a>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div class="admin-dashboard" id="adminDashboard">
    
    <!-- Header -->
    <div class="dashboard-header">
      <div>
        <h1>üìä Quest4Couple - BackOffice</h1>
        <div class="admin-info">Bem-vindo, <strong id="adminName">Admin</strong></div>
      </div>
      <div class="header-actions">
        <button class="btn-logout" onclick="logout()">üö™ Sair</button>
      </div>
    </div>
    
    <!-- Tabs Navigation -->
    <div class="tabs-nav">
      <button class="tab-btn active" onclick="showTab('dashboard')">
        üìä Dashboard
      </button>
      <button class="tab-btn" onclick="showTab('users')">
        üë• Utilizadores
      </button>      <button class="tab-btn" onclick="showTab('reports')">
        üìà Relat√≥rios
      </button>
      <button class="tab-btn" onclick="showTab('fullReports')">
        üìã Relat√≥rios Completos
      </button>
      <button class="tab-btn" onclick="showTab('questions')">
        üìä An√°lise de Quest√µes
      </button>
      <button class="tab-btn" onclick="showTab('activity')">
        üìù Log de Atividade
      </button>
    </div>
    
    <!-- TAB: DASHBOARD -->
    <div id="tab-dashboard" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card purple">
          <h3>üë• Total Utilizadores</h3>
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-label">registados na plataforma</div>
        </div>
        
        <div class="stat-card pink">
          <h3>üÜï Novos Hoje</h3>
          <div class="stat-value" id="newUsersToday">0</div>
          <div class="stat-label">registos nas √∫ltimas 24h</div>
        </div>
        
        <div class="stat-card blue">
          <h3>üíë Casais Ativos</h3>
          <div class="stat-value" id="activeCouples">0</div>
          <div class="stat-label">conex√µes estabelecidas</div>
        </div>
        
        <div class="stat-card green">
          <h3>üìä Relat√≥rios</h3>
          <div class="stat-value" id="totalReports">0</div>
          <div class="stat-label">relat√≥rios gerados</div>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card purple">
          <h3>‚ôÇÔ∏è Masculino</h3>
          <div class="stat-value" id="maleUsers">0</div>
          <div class="stat-label">utilizadores</div>
        </div>
        
        <div class="stat-card pink">
          <h3>‚ôÄÔ∏è Feminino</h3>
          <div class="stat-value" id="femaleUsers">0</div>
          <div class="stat-label">utilizadores</div>
        </div>
        
        <div class="stat-card blue">
          <h3>‚ößÔ∏è Outro</h3>
          <div class="stat-value" id="otherUsers">0</div>
          <div class="stat-label">utilizadores</div>
        </div>
        
        <div class="stat-card green">
          <h3>üåç Pa√≠ses</h3>
          <div class="stat-value" id="totalCountries">0</div>
          <div class="stat-label">pa√≠ses diferentes</div>
        </div>
      </div>
    </div>
    
    <!-- TAB: USERS -->
    <div id="tab-users" class="tab-content">
      <div class="content-card">
        <h2>
          üë• Utilizadores Registados
          <button class="btn-export" onclick="exportUsers()">
            üì• Exportar CSV
          </button>
        </h2>
        
        <div class="filters">
          <div class="filter-group">
            <label>üîç Pesquisar</label>
            <input type="text" id="searchUser" placeholder="Nome ou email..." onkeyup="filterUsers()">
          </div>
          <div class="filter-group">
            <label>‚ößÔ∏è Sexo</label>
            <select id="filterGender" onchange="filterUsers()">
              <option value="">Todos</option>
              <option value="M">Masculino</option>
              <option value="F">Feminino</option>
              <option value="outro">Outro</option>
            </select>
          </div>
          <div class="filter-group">
            <label>üåç Pa√≠s</label>
            <select id="filterCountry" onchange="filterUsers()">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="filter-group" style="display: flex; align-items: flex-end; gap: 10px;">
            <button class="btn-reset" onclick="resetFilters()">üîÑ Limpar</button>
          </div>
        </div>
        
        <div class="loading" id="loadingUsers">
          <div class="loading-spinner"></div>
          <p>A carregar utilizadores...</p>
        </div>
        
        <div class="table-container" id="usersTableContainer" style="display: none;">
          <table id="usersTable">
            <thead>
              <tr>
                <th>Email</th>
                <th>Nome</th>
                <th>Sexo</th>
                <th>Idade</th>
                <th>Pa√≠s</th>
                <th>Cidade</th>
                <th>Data Registo</th>
                <th>√öltimo Login</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- Users will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- TAB: REPORTS -->
    <div id="tab-reports" class="tab-content">
      <div class="content-card">
        <h2>üìà Estat√≠sticas de Relat√≥rios</h2>
        
        <div class="stats-grid">
          <div class="stat-card purple">
            <h3>üìä Total Relat√≥rios</h3>
            <div class="stat-value" id="reportsTotal">0</div>
            <div class="stat-label">relat√≥rios gerados</div>
          </div>
          
          <div class="stat-card pink">
            <h3>üìÖ Hoje</h3>
            <div class="stat-value" id="reportsToday">0</div>
            <div class="stat-label">gerados hoje</div>
          </div>
          
          <div class="stat-card blue">
            <h3>üìÜ Esta Semana</h3>
            <div class="stat-value" id="reportsWeek">0</div>
            <div class="stat-label">√∫ltimos 7 dias</div>
          </div>
          
          <div class="stat-card green">
            <h3>üìä M√©dia/Casal</h3>
            <div class="stat-value" id="reportsAvg">0</div>
            <div class="stat-label">relat√≥rios por casal</div>
          </div>
        </div>
        
        <h3 style="margin: 30px 0 15px 0; color: #495057;">üìã Question√°rios Mais Respondidos</h3>
        <div id="packStats"></div>
      </div>
    </div>
      <!-- TAB: FULL REPORTS -->
    <div id="tab-fullReports" class="tab-content">
      <div class="content-card">
        <h2>
          üìã Relat√≥rios Completos
          <span style="font-size: 0.7em; color: #6c757d; font-weight: normal; margin-left: 15px;">
            (Nomes anonimizados para privacidade)
          </span>
        </h2>
        
        <div class="filters">
          <div class="filter-group">
            <label>üìÖ Per√≠odo</label>
            <select id="filterReportPeriod" onchange="loadFullReportsWithFilters()">
              <option value="">Todos</option>
              <option value="today">Hoje</option>
              <option value="week">√öltima Semana</option>
              <option value="month">√öltimo M√™s</option>
            </select>
          </div>
          <div class="filter-group">
            <label>üéØ Compatibilidade</label>
            <select id="filterReportCompat" onchange="loadFullReportsWithFilters()">
              <option value="">Todas</option>
              <option value="high">Alta (‚â•80%)</option>
              <option value="medium">M√©dia (60-79%)</option>
              <option value="low">Baixa (&lt;60%)</option>
            </select>
          </div>
          <div class="filter-group" style="display: flex; align-items: flex-end; gap: 10px;">
            <button class="btn-reset" onclick="resetFullReportFilters()">üîÑ Limpar</button>
          </div>
        </div>
        
        <div id="fullReportsContainer">
          <!-- Reports will be loaded here by admin-analytics.js -->
        </div>
      </div>
    </div>

    <!-- TAB: QUESTION ANALYTICS -->
    <div id="tab-questions" class="tab-content">
      <div class="content-card">
        <h2>üìä An√°lise de Quest√µes</h2>
        
        <div class="filters">
          <div class="filter-group">
            <label>üì¶ Pacote</label>
            <select id="filterQuestionPack" onchange="loadQuestionAnalyticsWithFilters()">
              <option value="">Todos os Pacotes</option>
              <!-- Pack options will be loaded dynamically -->
            </select>
          </div>
          <div class="filter-group">
            <label>üî¢ M√≠nimo Respostas</label>
            <input type="number" id="filterMinResponses" min="0" value="0" 
                   onchange="loadQuestionAnalyticsWithFilters()" 
                   placeholder="Filtrar por n¬∫ de respostas">
          </div>
          <div class="filter-group" style="display: flex; align-items: flex-end; gap: 10px;">
            <button class="btn-reset" onclick="resetQuestionFilters()">üîÑ Limpar</button>
          </div>
        </div>
        
        <div id="questionAnalyticsContainer">
          <!-- Question analytics will be loaded here by admin-analytics.js -->
        </div>
      </div>
    </div>

    <!-- TAB: ACTIVITY -->
    <div id="tab-activity" class="tab-content">
      <div class="content-card">
        <h2>
          üìù Log de Atividade
          <button class="btn-export" onclick="exportActivity()">
            üì• Exportar LOG
          </button>
        </h2>
        
        <div class="filters">
          <div class="filter-group">
            <label>üîç Tipo de Atividade</label>
            <select id="filterActivityType" onchange="filterActivity()">
              <option value="">Todas</option>
              <option value="register">Registos</option>
              <option value="login">Logins</option>
              <option value="answer">Respostas</option>
              <option value="report">Relat√≥rios</option>
              <option value="connection">Conex√µes</option>
            </select>
          </div>
          <div class="filter-group">
            <label>üìÖ Data</label>
            <input type="date" id="filterActivityDate" onchange="filterActivity()">
          </div>
          <div class="filter-group" style="display: flex; align-items: flex-end; gap: 10px;">
            <button class="btn-reset" onclick="resetActivityFilters()">üîÑ Limpar</button>
          </div>
        </div>
        
        <div class="loading" id="loadingActivity">
          <div class="loading-spinner"></div>
          <p>A carregar atividades...</p>
        </div>
          <div id="activityLog" style="display: none;">
          <!-- Activity items will be loaded here -->
        </div>
      </div>
    </div>
    
  </div>

  <!-- Modal for Report Details -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìã Detalhes do Relat√≥rio</h2>
        <button class="modal-close" onclick="closeReportModal()">√ó</button>
      </div>
      <div class="modal-body" id="reportModalBody">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <script src="../js/firebase-config.js"></script>
  <script src="../js/analytics.js"></script>
  <script src="../js/admin-analytics.js"></script>
  
  <script>
    // ===========================
    // ADMIN CREDENTIALS
    // ===========================
    const ADMIN_USERNAME = 'carlos.sousacorreia';
    const ADMIN_PASSWORD = 'rzq7xgq8';
    
    // ===========================
    // GLOBAL VARIABLES
    // ===========================
    let allUsers = [];
    let allActivity = [];
    
    // ===========================
    // LOGIN LOGIC
    // ===========================
    const loginContainer = document.getElementById('loginContainer');
    const adminDashboard = document.getElementById('adminDashboard');
    const errorMessage = document.getElementById('errorMessage');
    const adminLoginForm = document.getElementById('adminLoginForm');
    
    // Check if already logged in
    const isAdminLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';
    if (isAdminLoggedIn) {
      showDashboard();
    }
    
    // Login form handler
    adminLoginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const username = document.getElementById('adminUsername').value.trim();
      const password = document.getElementById('adminPassword').value;
      
      if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        sessionStorage.setItem('adminLoggedIn', 'true');
        sessionStorage.setItem('adminUsername', username);
        errorMessage.classList.remove('show');
        showDashboard();
      } else {
        errorMessage.classList.add('show');
        document.getElementById('adminPassword').value = '';
        setTimeout(() => errorMessage.classList.remove('show'), 3000);
      }
    });
    
    // ===========================
    // DASHBOARD FUNCTIONS
    // ===========================
    function showDashboard() {
      loginContainer.style.display = 'none';
      adminDashboard.style.display = 'block';
      document.body.style.alignItems = 'flex-start';
      
      const adminName = sessionStorage.getItem('adminUsername') || ADMIN_USERNAME;
      document.getElementById('adminName').textContent = adminName;
      
      loadAllData();
    }
    
    function logout() {
      sessionStorage.removeItem('adminLoggedIn');
      sessionStorage.removeItem('adminUsername');
      window.location.reload();
    }
      // ===========================
    // TAB NAVIGATION
    // ===========================
    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active from all buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(`tab-${tabName}`).classList.add('active');
      
      // Highlight active button
      event.target.classList.add('active');
      
      // Load data for specific tabs when they are opened
      if (tabName === 'fullReports') {
        loadFullReportsWithFilters();
      } else if (tabName === 'questions') {
        loadQuestionAnalyticsWithFilters();
      }
    }
    
    // ===========================
    // FULL REPORTS TAB FUNCTIONS
    // ===========================
    function loadFullReportsWithFilters() {
      const period = document.getElementById('filterReportPeriod').value;
      const compat = document.getElementById('filterReportCompat').value;
      
      const filters = {};
      if (period) filters.period = period;
      if (compat) filters.compatibility = compat;
      
      // Call function from admin-analytics.js
      if (typeof loadFullReports === 'function') {
        loadFullReports(filters);
      }
    }
    
    function resetFullReportFilters() {
      document.getElementById('filterReportPeriod').value = '';
      document.getElementById('filterReportCompat').value = '';
      loadFullReportsWithFilters();
    }
    
    // ===========================
    // QUESTION ANALYTICS TAB FUNCTIONS
    // ===========================
    function loadQuestionAnalyticsWithFilters() {
      const packId = document.getElementById('filterQuestionPack').value;
      const minResponses = parseInt(document.getElementById('filterMinResponses').value) || 0;
      
      // Call function from admin-analytics.js
      if (typeof loadQuestionAnalytics === 'function') {
        loadQuestionAnalytics(packId, minResponses);
      }
    }
    
    function resetQuestionFilters() {
      document.getElementById('filterQuestionPack').value = '';
      document.getElementById('filterMinResponses').value = '0';
      loadQuestionAnalyticsWithFilters();
    }
    
    // ===========================
    // LOAD DATA
    // ===========================
    async function loadAllData() {
      try {
        console.log('üîÑ A carregar dados...');
        
        // Load users
        const usersSnapshot = await db.collection('users').get();
        allUsers = [];
        
        usersSnapshot.forEach(doc => {
          allUsers.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('‚úÖ Utilizadores carregados:', allUsers.length);
        
        // Update dashboard stats
        updateDashboardStats();
        
        // Load users table
        loadUsersTable();
        
        // Load reports stats
        loadReportsStats();
        
        // Load activity log
        loadActivityLog();
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar dados:', error);
        alert('Erro ao carregar dados: ' + error.message);
      }
    }
    
    // ===========================
    // DASHBOARD STATS
    // ===========================
    function updateDashboardStats() {
      // Total users
      document.getElementById('totalUsers').textContent = allUsers.length;
      
      // New users today
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const newToday = allUsers.filter(user => {
        const createdAt = user.createdAt?.toDate();
        return createdAt && createdAt >= today;
      }).length;
      document.getElementById('newUsersToday').textContent = newToday;
      
      // Gender stats
      const maleCount = allUsers.filter(u => u.gender === 'M').length;
      const femaleCount = allUsers.filter(u => u.gender === 'F').length;
      const otherCount = allUsers.filter(u => u.gender === 'outro').length;
      
      document.getElementById('maleUsers').textContent = maleCount;
      document.getElementById('femaleUsers').textContent = femaleCount;
      document.getElementById('otherUsers').textContent = otherCount;
      
      // Countries
      const countries = new Set(allUsers.filter(u => u.country).map(u => u.country));
      document.getElementById('totalCountries').textContent = countries.size;
      
      // Active couples (users with connections)
      const couplesCount = Math.floor(allUsers.length / 2); // Simplified
      document.getElementById('activeCouples').textContent = couplesCount;
      
      // Reports (estimated)
      const reportsCount = Math.floor(allUsers.length * 1.5);
      document.getElementById('totalReports').textContent = reportsCount;
    }
    
    // ===========================
    // USERS TABLE
    // ===========================
    function loadUsersTable() {
      const loadingUsers = document.getElementById('loadingUsers');
      const tableContainer = document.getElementById('usersTableContainer');
      const tbody = document.getElementById('usersTableBody');
      
      tbody.innerHTML = '';
      
      // Populate country filter
      const countries = new Set(allUsers.filter(u => u.country).map(u => u.country));
      const countrySelect = document.getElementById('filterCountry');
      countrySelect.innerHTML = '<option value="">Todos</option>';
      countries.forEach(country => {
        countrySelect.innerHTML += `<option value="${country}">${country}</option>`;
      });
      
      if (allUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #6c757d; padding: 40px;">Nenhum utilizador encontrado.</td></tr>';
      } else {
        allUsers.forEach(user => {
          const row = createUserRow(user);
          tbody.appendChild(row);
        });
      }
      
      loadingUsers.style.display = 'none';
      tableContainer.style.display = 'block';
    }
    
    function createUserRow(user) {
      const tr = document.createElement('tr');
      
      const createdAt = user.createdAt?.toDate();
      const lastLogin = user.lastLogin?.toDate();
      
      const createdStr = createdAt ? createdAt.toLocaleDateString('pt-PT') + ' ' + createdAt.toLocaleTimeString('pt-PT', {hour: '2-digit', minute: '2-digit'}) : '-';
      const loginStr = lastLogin ? lastLogin.toLocaleDateString('pt-PT') + ' ' + lastLogin.toLocaleTimeString('pt-PT', {hour: '2-digit', minute: '2-digit'}) : '-';
      
      const genderBadge = user.gender === 'M' ? 
        '<span class="badge badge-male">‚ôÇÔ∏è Masculino</span>' :
        user.gender === 'F' ?
        '<span class="badge badge-female">‚ôÄÔ∏è Feminino</span>' :
        '<span class="badge badge-other">‚ößÔ∏è Outro</span>';
      
      tr.innerHTML = `
        <td><span class="user-email">${user.email || '-'}</span></td>
        <td>${user.name || '-'}</td>
        <td>${genderBadge}</td>
        <td>${user.ageRange || '-'}</td>
        <td>${user.country || '-'}</td>
        <td>${user.city || '-'}</td>
        <td>${createdStr}</td>
        <td>${loginStr}</td>
      `;
      
      return tr;
    }
    
    // ===========================
    // FILTERS
    // ===========================
    function filterUsers() {
      const searchTerm = document.getElementById('searchUser').value.toLowerCase();
      const genderFilter = document.getElementById('filterGender').value;
      const countryFilter = document.getElementById('filterCountry').value;
      
      const rows = document.querySelectorAll('#usersTableBody tr');
      
      rows.forEach(row => {
        const cells = row.cells;
        if (!cells || cells.length === 0) return;
        
        const email = cells[0].textContent.toLowerCase();
        const name = cells[1].textContent.toLowerCase();
        const gender = cells[2].textContent;
        const country = cells[4].textContent;
        
        const matchSearch = !searchTerm || email.includes(searchTerm) || name.includes(searchTerm);
        const matchGender = !genderFilter || 
          (genderFilter === 'M' && gender.includes('Masculino')) ||
          (genderFilter === 'F' && gender.includes('Feminino')) ||
          (genderFilter === 'outro' && gender.includes('Outro'));
        const matchCountry = !countryFilter || country === countryFilter;
        
        row.style.display = matchSearch && matchGender && matchCountry ? '' : 'none';
      });
    }
    
    function resetFilters() {
      document.getElementById('searchUser').value = '';
      document.getElementById('filterGender').value = '';
      document.getElementById('filterCountry').value = '';
      filterUsers();
    }
    
    // ===========================
    // REPORTS STATS
    // ===========================
    function loadReportsStats() {
      // Simplified stats (in real app, fetch from reports collection)
      const total = Math.floor(allUsers.length * 1.5);
      const today = Math.floor(Math.random() * 10);
      const week = Math.floor(Math.random() * 50);
      const avg = (total / Math.max(1, allUsers.length / 2)).toFixed(1);
      
      document.getElementById('reportsTotal').textContent = total;
      document.getElementById('reportsToday').textContent = today;
      document.getElementById('reportsWeek').textContent = week;
      document.getElementById('reportsAvg').textContent = avg;
      
      // Pack stats (mock data)
      const packStatsDiv = document.getElementById('packStats');
      packStatsDiv.innerHTML = `
        <div style="display: grid; gap: 15px;">
          <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between;">
            <span>üå∂Ô∏è Pimentinha</span>
            <strong>${Math.floor(allUsers.length * 0.8)} respostas</strong>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between;">
            <span>üé≠ Fetiches</span>
            <strong>${Math.floor(allUsers.length * 0.6)} respostas</strong>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between;">
            <span>üíë Experi√™ncias a Dois</span>
            <strong>${Math.floor(allUsers.length * 0.7)} respostas</strong>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between;">
            <span>üë´ Poliamor & Swing</span>
            <strong>${Math.floor(allUsers.length * 0.4)} respostas</strong>
          </div>
        </div>
      `;
    }
    
    // ===========================
    // ACTIVITY LOG
    // ===========================
    async function loadActivityLog() {
      const loadingActivity = document.getElementById('loadingActivity');
      const activityLog = document.getElementById('activityLog');
      
      // Generate mock activity (in real app, fetch from activity collection)
      allActivity = [];
      
      allUsers.forEach(user => {
        if (user.createdAt) {
          allActivity.push({
            type: 'register',
            user: user.email,
            timestamp: user.createdAt.toDate(),
            details: `Novo registo: ${user.name || 'Sem nome'}`
          });
        }
        
        if (user.lastLogin) {
          allActivity.push({
            type: 'login',
            user: user.email,
            timestamp: user.lastLogin.toDate(),
            details: `Login realizado`
          });
        }
      });
      
      // Sort by timestamp desc
      allActivity.sort((a, b) => b.timestamp - a.timestamp);
      
      // Show only last 50
      const recentActivity = allActivity.slice(0, 50);
      
      activityLog.innerHTML = '';
      
      if (recentActivity.length === 0) {
        activityLog.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">Nenhuma atividade registada.</p>';
      } else {
        recentActivity.forEach(activity => {
          const item = createActivityItem(activity);
          activityLog.appendChild(item);
        });
      }
      
      loadingActivity.style.display = 'none';
      activityLog.style.display = 'block';
    }
    
    function createActivityItem(activity) {
      const div = document.createElement('div');
      div.className = 'activity-item';
      
      const typeIcons = {
        register: 'üÜï',
        login: 'üîì',
        answer: '‚úçÔ∏è',
        report: 'üìä',
        connection: 'üíë'
      };
      
      const typeLabels = {
        register: 'Registo',
        login: 'Login',
        answer: 'Resposta',
        report: 'Relat√≥rio',
        connection: 'Conex√£o'
      };
      
      const icon = typeIcons[activity.type] || 'üìù';
      const label = typeLabels[activity.type] || activity.type;
      
      const timeStr = activity.timestamp.toLocaleDateString('pt-PT') + ' √†s ' + 
                      activity.timestamp.toLocaleTimeString('pt-PT', {hour: '2-digit', minute: '2-digit'});
      
      div.innerHTML = `
        <div class="activity-header">
          <div class="activity-type">${icon} ${label}</div>
          <div class="activity-time">${timeStr}</div>
        </div>
        <div class="activity-details">
          <strong>${activity.user}</strong> - ${activity.details}
        </div>
      `;
      
      return div;
    }
    
    function filterActivity() {
      const typeFilter = document.getElementById('filterActivityType').value;
      const dateFilter = document.getElementById('filterActivityDate').value;
      
      const items = document.querySelectorAll('.activity-item');
      
      items.forEach(item => {
        const typeText = item.querySelector('.activity-type').textContent;
        const dateText = item.querySelector('.activity-time').textContent;
        
        const matchType = !typeFilter || typeText.toLowerCase().includes(typeFilter);
        
        let matchDate = true;
        if (dateFilter) {
          const itemDate = dateText.split(' ')[0];
          const filterDate = new Date(dateFilter).toLocaleDateString('pt-PT');
          matchDate = itemDate === filterDate;
        }
        
        item.style.display = matchType && matchDate ? '' : 'none';
      });
    }
    
    function resetActivityFilters() {
      document.getElementById('filterActivityType').value = '';
      document.getElementById('filterActivityDate').value = '';
      filterActivity();
    }
    
    // ===========================
    // EXPORT FUNCTIONS
    // ===========================
    function exportUsers() {
      const csv = ['Email,Nome,Sexo,Idade,Pa√≠s,Cidade,Data Registo,√öltimo Login'];
      
      allUsers.forEach(user => {
        const createdAt = user.createdAt?.toDate();
        const lastLogin = user.lastLogin?.toDate();
        
        const row = [
          user.email || '',
          user.name || '',
          user.gender || '',
          user.ageRange || '',
          user.country || '',
          user.city || '',
          createdAt ? createdAt.toLocaleString('pt-PT') : '',
          lastLogin ? lastLogin.toLocaleString('pt-PT') : ''
        ];
        
        csv.push(row.join(','));
      });
      
      downloadCSV(csv.join('\n'), 'quest4couple_users.csv');
    }
    
    function exportActivity() {
      const csv = ['Tipo,Utilizador,Data/Hora,Detalhes'];
      
      allActivity.forEach(activity => {
        const row = [
          activity.type,
          activity.user,
          activity.timestamp.toLocaleString('pt-PT'),
          activity.details
        ];
        
        csv.push(row.join(','));
      });
      
      downloadCSV(csv.join('\n'), 'quest4couple_activity.csv');
    }
      function downloadCSV(content, filename) {
      const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // ===========================
    // MODAL FUNCTIONS
    // ===========================
    function closeReportModal() {
      const modal = document.getElementById('reportModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('reportModal');
      if (event.target === modal) {
        closeReportModal();
      }
    };
    
    // Close modal with ESC key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeReportModal();
      }
    });
  </script>

</body>
</html>
